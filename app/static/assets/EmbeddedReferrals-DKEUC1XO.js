import{b as G,u as L,c as W,j as e}from"./vendor-query-Bq4hz6H9.js";import{r as h}from"./vendor-router-CdtyvhQv.js";import{a as v,g as S}from"./index-CIr4Wx79.js";import{P as b,B as _,b as z,h as c,l as K,L as g,u as Q,C as f,a as t,T as n,t as d,D as N,E as $,c as q,M as B,g as w,f as H}from"./vendor-polaris-vFYxDTRx.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";import"./vendor-appbridge-DL6abzKC.js";function J(s=768){const[l,i]=h.useState(typeof window<"u"?window.innerWidth<s:!1);return h.useEffect(()=>{const u=()=>i(window.innerWidth<s);return window.addEventListener("resize",u),()=>window.removeEventListener("resize",u)},[s]),l}async function V(s){const l=await v(`${S()}/referrals/admin/stats`,s);if(!l.ok)throw new Error("Failed to fetch referral stats");const i=await l.json();return{total_referrals:i.stats?.total_referrals||0,monthly_referrals:i.stats?.total_referrals||0,total_credit_issued:i.stats?.total_credit_issued||0,top_referrers:i.top_referrers||[],recent_referrals:i.recent_referrals||[]}}async function Y(s){const l=await v(`${S()}/referrals/admin/config`,s);if(!l.ok)throw new Error("Failed to fetch referral config");return l.json()}async function X(s,l){const i=await v(`${S()}/referrals/admin/config`,s,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)});if(!i.ok){const u=await i.json();throw new Error(u.error||"Failed to update referral config")}return i.json()}function ie({shop:s}){const l=J(),i=G(),[u,m]=h.useState(!1),[M,p]=h.useState(null),[R,C]=h.useState("10"),[F,T]=h.useState("5"),[y,E]=h.useState("signup"),[k,A]=h.useState("50"),{data:a,isLoading:D,error:O}=L({queryKey:["referral-stats",s],queryFn:()=>V(s),enabled:!!s}),{data:o}=L({queryKey:["referral-config",s],queryFn:()=>Y(s),enabled:!!s});h.useEffect(()=>{o?.config&&(C(o.config.referrer_credit?.toString()||"10"),T(o.config.referee_credit?.toString()||"5"),E(o.config.grant_on_signup?"signup":"purchase"),A(o.config.max_referrals_per_month?.toString()||"50"))},[o]);const P=W({mutationFn:r=>X(s,r),onSuccess:()=>{i.invalidateQueries({queryKey:["referral-config",s]}),m(!1),p(null)},onError:r=>{p(r.message)}}),U=()=>{p(null),P.mutate({referrer_credit:parseFloat(R)||0,referee_credit:parseFloat(F)||0,grant_on_signup:y==="signup",require_first_purchase:y==="purchase",max_referrals_per_month:parseInt(k)||50})},j=r=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(r),I=r=>new Date(r).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"});return s?D?e.jsx(b,{title:"Referral Program",children:e.jsx(z,{padding:"1600",children:e.jsx(c,{align:"center",children:e.jsx(K,{size:"large"})})})}):O?e.jsx(b,{title:"Referral Program",children:e.jsx(_,{tone:"critical",children:e.jsx("p",{children:"Failed to load referral data. Please try refreshing the page."})})}):e.jsxs(b,{title:"Referral Program",subtitle:"Grow your membership through word-of-mouth",primaryAction:{content:"Configure Rewards",onAction:()=>m(!0)},children:[e.jsxs(g,{children:[e.jsx(g.Section,{children:e.jsxs(Q,{columns:l?1:{xs:1,sm:2,md:2,lg:4},gap:"400",children:[e.jsx(f,{children:e.jsxs(t,{gap:"200",children:[e.jsx(n,{as:"h3",variant:"headingMd",children:"Total Referrals"}),e.jsx(n,{as:"p",variant:"heading2xl",children:a?.total_referrals||0}),e.jsx(n,{as:"p",variant:"bodySm",tone:"subdued",children:"All-time successful referrals"})]})}),e.jsx(f,{children:e.jsxs(t,{gap:"200",children:[e.jsx(n,{as:"h3",variant:"headingMd",children:"This Month"}),e.jsx(n,{as:"p",variant:"heading2xl",children:a?.monthly_referrals||0}),e.jsx(d,{tone:"success",children:a?.monthly_referrals&&a?.total_referrals?`${Math.round(a.monthly_referrals/a.total_referrals*100)}% of total`:"0%"})]})}),e.jsx(f,{children:e.jsxs(t,{gap:"200",children:[e.jsx(n,{as:"h3",variant:"headingMd",children:"Credits Issued"}),e.jsx(n,{as:"p",variant:"heading2xl",children:j(a?.total_credit_issued||0)}),e.jsx(n,{as:"p",variant:"bodySm",tone:"subdued",children:"Total referral rewards"})]})}),e.jsx(f,{children:e.jsxs(t,{gap:"200",children:[e.jsx(n,{as:"h3",variant:"headingMd",children:"Avg. per Referrer"}),e.jsx(n,{as:"p",variant:"heading2xl",children:a?.top_referrers&&a.top_referrers.length>0?(a.top_referrers.reduce((r,x)=>r+x.referral_count,0)/a.top_referrers.length).toFixed(1):"0"}),e.jsx(n,{as:"p",variant:"bodySm",tone:"subdued",children:"Referrals per active referrer"})]})})]})}),o&&e.jsx(g.Section,{children:e.jsx(f,{children:e.jsxs(t,{gap:"300",children:[e.jsx(n,{as:"h3",variant:"headingMd",children:"Current Reward Structure"}),e.jsxs(c,{gap:"600",children:[e.jsxs(t,{gap:"100",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"Referrer Reward"}),e.jsx(n,{as:"span",variant:"headingMd",children:j(o.config.referrer_credit)})]}),e.jsxs(t,{gap:"100",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"New Member Reward"}),e.jsx(n,{as:"span",variant:"headingMd",children:j(o.config.referee_credit)})]}),e.jsxs(t,{gap:"100",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"Granted On"}),e.jsx(d,{tone:o.config.grant_on_signup?"success":"info",children:o.config.grant_on_signup?"Signup":"First Purchase"})]}),e.jsxs(t,{gap:"100",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"Monthly Limit"}),e.jsxs(n,{as:"span",variant:"headingMd",children:[o.config.max_referrals_per_month," per member"]})]})]})]})})}),e.jsx(g.Section,{variant:"oneHalf",children:e.jsx(f,{children:e.jsxs(t,{gap:"400",children:[e.jsxs(c,{align:"space-between",blockAlign:"center",children:[e.jsx(n,{as:"h3",variant:"headingMd",children:"Top Referrers"}),e.jsx(d,{tone:"info",children:"Leaderboard"})]}),a?.top_referrers&&a.top_referrers.length>0?e.jsx(N,{columnContentTypes:["text","text","numeric","numeric"],headings:["Member","Code","Referrals","Earnings"],rows:a.top_referrers.slice(0,5).filter(r=>r&&r.id!=null).map((r,x)=>[e.jsxs(c,{gap:"200",blockAlign:"center",children:[e.jsx(d,{tone:x===0?"success":x===1?"info":"enabled",children:`#${x+1}`}),e.jsxs(t,{gap:"050",children:[e.jsx(n,{as:"span",variant:"bodyMd",fontWeight:"semibold",children:r.name||r.member_number||"Unknown"}),e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:r.email||"-"})]})]},r.id),e.jsx(d,{children:String(r.referral_code||"-")},`code-${r.id}`),r.referral_count||0,j(r.referral_earnings||0)])}):e.jsx($,{heading:"No referrals yet",image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Top referrers will appear here once members start sharing."})})]})})}),e.jsx(g.Section,{variant:"oneHalf",children:e.jsx(f,{children:e.jsxs(t,{gap:"400",children:[e.jsxs(c,{align:"space-between",blockAlign:"center",children:[e.jsx(n,{as:"h3",variant:"headingMd",children:"Recent Activity"}),e.jsx(d,{children:"Latest signups"})]}),a?.recent_referrals&&a.recent_referrals.length>0?e.jsx(N,{columnContentTypes:["text","text","text"],headings:["New Member","Referred By","Joined"],rows:a.recent_referrals.slice(0,5).filter(r=>r&&r.id!=null).map(r=>[e.jsx(t,{gap:"050",children:e.jsx(n,{as:"span",variant:"bodyMd",fontWeight:"semibold",children:r.name||r.member_number||"Unknown"})},r.id),e.jsx(d,{tone:"info",children:String(r.referred_by||"Unknown")},`by-${r.id}`),r.created_at?I(r.created_at):"-"])}):e.jsx($,{heading:"No recent referrals",image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Recent referral activity will appear here."})})]})})}),e.jsx(g.Section,{children:e.jsx(f,{children:e.jsxs(t,{gap:"400",children:[e.jsx(n,{as:"h3",variant:"headingMd",children:"Promote Your Referral Program"}),e.jsxs(t,{gap:"200",children:[e.jsxs(c,{gap:"200",children:[e.jsx(d,{children:"1"}),e.jsxs(n,{as:"p",children:["Add the ",e.jsx("strong",{children:"Refer a Friend"})," theme block to your storefront"]})]}),e.jsxs(c,{gap:"200",children:[e.jsx(d,{children:"2"}),e.jsx(n,{as:"p",children:"Members can find their unique referral code in their account dashboard"})]}),e.jsxs(c,{gap:"200",children:[e.jsx(d,{children:"3"}),e.jsx(n,{as:"p",children:"New customers use the code at signup to unlock rewards for both parties"})]})]}),e.jsxs(c,{gap:"300",children:[e.jsx(q,{url:"/app/settings",children:"Customize Theme Blocks"}),e.jsx(q,{variant:"plain",children:"View Documentation"})]})]})})})]}),e.jsx(B,{open:u,onClose:()=>{m(!1),p(null)},title:"Configure Referral Rewards",primaryAction:{content:"Save Changes",onAction:U,loading:P.isPending},secondaryActions:[{content:"Cancel",onAction:()=>{m(!1),p(null)}}],children:e.jsx(B.Section,{children:e.jsxs(t,{gap:"400",children:[M&&e.jsx(_,{tone:"critical",onDismiss:()=>p(null),children:e.jsx("p",{children:M})}),e.jsx(w,{label:"Referrer Reward",type:"number",prefix:"$",value:R,onChange:C,helpText:"Credit given to the existing member who referred someone",autoComplete:"off",min:0,max:1e3}),e.jsx(w,{label:"New Member Reward",type:"number",prefix:"$",value:F,onChange:T,helpText:"Credit given to the new member who was referred",autoComplete:"off",min:0,max:1e3}),e.jsx(H,{label:"Grant Rewards",options:[{label:"On Signup",value:"signup"},{label:"On First Purchase",value:"purchase"}],value:y,onChange:E,helpText:"When referral rewards are credited"}),e.jsx(w,{label:"Monthly Limit per Member",type:"number",value:k,onChange:A,helpText:"Maximum referrals a single member can make per month",autoComplete:"off",min:1,max:1e3})]})})})]}):e.jsx(b,{title:"Referral Program",children:e.jsx(_,{tone:"warning",children:e.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})})}export{ie as EmbeddedReferrals};
