import{b as G,u as P,c as y,j as e}from"./vendor-query-Bq4hz6H9.js";import{r as l}from"./vendor-router-CdtyvhQv.js";import{a as h,g}from"./index-CHD2jXUp.js";import{P as E,B as $,b as X,h as w,l as Y,v as Z,L as j,C as T,a9 as ee,R as k,w as M,a as b,T as c,t as u,x as L,E as D,a7 as re,z as te,M as v,e as I,g as d,f as O}from"./vendor-polaris-CV39Dq-f.js";import{T as ne}from"./vendor-appbridge-DL6abzKC.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";async function ae(t){const n=await h(`${g()}/points/rules`,t);if(!n.ok){const o=await n.json().catch(()=>({}));throw new Error(o.error||`Failed to fetch earning rules (${n.status})`)}return(await n.json()).rules||[]}async function se(t){const n=await h(`${g()}/rewards`,t);if(!n.ok){const o=await n.json().catch(()=>({}));throw new Error(o.error||`Failed to fetch rewards (${n.status})`)}return(await n.json()).rewards||[]}async function ie(t,n){const a=await h(`${g()}/points/rules`,t,{method:"POST",body:JSON.stringify(n)});if(!a.ok){const o=await a.json().catch(()=>({}));throw new Error(o.error||`Failed to create rule (${a.status})`)}return a.json()}async function oe(t,n){const a=await h(`${g()}/rewards`,t,{method:"POST",body:JSON.stringify(n)});if(!a.ok){const o=await a.json().catch(()=>({}));throw new Error(o.error||`Failed to create reward (${a.status})`)}return a.json()}async function le(t,n){const a=await h(`${g()}/points/rules/${n}/toggle`,t,{method:"POST"});if(!a.ok)throw new Error("Failed to toggle rule");return a.json()}async function ce(t,n){const a=await h(`${g()}/rewards/${n}/toggle`,t,{method:"POST"});if(!a.ok)throw new Error("Failed to toggle reward");return a.json()}function fe({shop:t}){const n=G(),[a,o]=l.useState(0),[q,_]=l.useState(!1),[B,x]=l.useState(!1),[F,f]=l.useState(null),[s,p]=l.useState({name:"",description:"",rule_type:"base_rate",points_per_dollar:"1",trigger_source:"purchase",min_order_value:"",max_points_per_order:""}),[i,m]=l.useState({name:"",description:"",reward_type:"store_credit",points_cost:"100",credit_value:"1"}),{data:S,isLoading:N,error:K}=P({queryKey:["earning-rules",t],queryFn:()=>ae(t),enabled:!!t}),{data:C,isLoading:Q,error:z}=P({queryKey:["rewards",t],queryFn:()=>se(t),enabled:!!t}),R=y({mutationFn:r=>ie(t,r),onSuccess:()=>{f(null),n.invalidateQueries({queryKey:["earning-rules"]}),_(!1),p({name:"",description:"",rule_type:"base_rate",points_per_dollar:"1",trigger_source:"purchase",min_order_value:"",max_points_per_order:""})},onError:r=>{f(r.message)}}),A=y({mutationFn:r=>oe(t,r),onSuccess:()=>{f(null),n.invalidateQueries({queryKey:["rewards"]}),x(!1),m({name:"",description:"",reward_type:"store_credit",points_cost:"100",credit_value:"1"})},onError:r=>{f(r.message)}}),W=y({mutationFn:r=>le(t,r),onSuccess:()=>{n.invalidateQueries({queryKey:["earning-rules"]})}}),H=y({mutationFn:r=>ce(t,r),onSuccess:()=>{n.invalidateQueries({queryKey:["rewards"]})}}),J=l.useCallback(()=>{const r={name:s.name,description:s.description||void 0,rule_type:s.rule_type,points_per_dollar:parseInt(s.points_per_dollar)||1,trigger_source:s.trigger_source,min_order_value:s.min_order_value?parseFloat(s.min_order_value):void 0,max_points_per_order:s.max_points_per_order?parseInt(s.max_points_per_order):void 0};R.mutate(r)},[s,R]),V=l.useCallback(()=>{const r={name:i.name,description:i.description||void 0,reward_type:i.reward_type,points_cost:parseInt(i.points_cost)||100,credit_value:parseFloat(i.credit_value)||1};A.mutate(r)},[i,A]),U=[{id:"earning-rules",content:"Earning Rules",accessibilityLabel:"Earning rules",panelID:"earning-rules-panel"},{id:"rewards",content:"Rewards Catalog",accessibilityLabel:"Rewards catalog",panelID:"rewards-panel"}];return t?N||Q?e.jsx(E,{title:"Points & Rewards",children:e.jsx(X,{padding:"1600",children:e.jsx(w,{align:"center",children:e.jsx(Y,{size:"large"})})})}):e.jsxs(e.Fragment,{children:[e.jsx(ne,{title:"Points & Rewards"}),e.jsxs(E,{title:"Points & Rewards",subtitle:"Configure how customers earn and redeem loyalty points",primaryAction:{content:a===0?"Add Earning Rule":"Add Reward",icon:Z,onAction:()=>a===0?_(!0):x(!0)},children:[e.jsxs(j,{children:[(K||z)&&e.jsx(j.Section,{children:e.jsx($,{tone:"critical",children:e.jsx("p",{children:"Failed to load data. Please try refreshing the page."})})}),F&&e.jsx(j.Section,{children:e.jsx($,{tone:"critical",onDismiss:()=>f(null),children:e.jsx("p",{children:F})})}),e.jsx(j.Section,{children:e.jsx(T,{padding:"0",children:e.jsx(ee,{tabs:U,selected:a,onSelect:o,children:a===0?S&&S.length>0?e.jsx(k,{resourceName:{singular:"rule",plural:"rules"},items:S,renderItem:r=>e.jsx(M,{id:String(r.id),accessibilityLabel:r.name,onClick:()=>{},media:e.jsx(L,{customer:!1,size:"md",name:r.name,initials:r.name.charAt(0)}),shortcutActions:[{content:r.is_active?"Disable":"Enable",onAction:()=>W.mutate(r.id)}],children:e.jsxs(b,{gap:"200",children:[e.jsxs(w,{gap:"200",blockAlign:"center",wrap:!0,children:[e.jsx(c,{as:"h3",variant:"bodyMd",fontWeight:"bold",children:r.name}),r.is_base_rule&&e.jsx(u,{tone:"info",children:"Base Rule"}),!r.is_active&&e.jsx(u,{tone:"warning",children:"Inactive"}),e.jsx(u,{tone:"success",children:r.rule_type==="base_rate"?`${r.points_per_dollar} pts/$1`:r.rule_type==="multiplier"?`${r.multiplier}x multiplier`:`${r.bonus_points} bonus pts`})]}),e.jsx(c,{as:"span",variant:"bodySm",tone:"subdued",children:r.description||`${r.points_per_dollar||0} points per $1 spent`})]})})}):e.jsx(D,{heading:"Set up your earning rules",action:{content:"Add Earning Rule",onAction:()=>_(!0)},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Earning rules define how customers earn points on purchases, trade-ins, referrals, and more."})}):C&&C.length>0?e.jsx(k,{resourceName:{singular:"reward",plural:"rewards"},items:C,renderItem:r=>e.jsx(M,{id:String(r.id),accessibilityLabel:r.name,onClick:()=>{},media:e.jsx(L,{customer:!1,size:"md",name:r.name,initials:r.name.charAt(0)}),shortcutActions:[{content:r.is_active?"Disable":"Enable",onAction:()=>H.mutate(r.id)}],children:e.jsxs(b,{gap:"200",children:[e.jsxs(w,{gap:"200",blockAlign:"center",wrap:!0,children:[e.jsx(c,{as:"h3",variant:"bodyMd",fontWeight:"bold",children:r.name}),r.is_featured&&e.jsx(u,{tone:"success",children:"Featured"}),!r.is_active&&e.jsx(u,{tone:"warning",children:"Inactive"}),e.jsx(u,{children:`${r.points_cost.toLocaleString()} points`}),r.credit_value&&e.jsx(u,{tone:"info",children:`$${r.credit_value} value`})]}),e.jsx(c,{as:"span",variant:"bodySm",tone:"subdued",children:r.description||`${r.reward_type} reward`})]})})}):e.jsx(D,{heading:"Create your rewards catalog",action:{content:"Add Reward",onAction:()=>x(!0)},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Rewards are what customers can redeem their points for - store credit, discounts, free products, and more."})})})})}),e.jsx(j.Section,{variant:"oneThird",children:e.jsx(T,{children:e.jsxs(b,{gap:"400",children:[e.jsxs(w,{gap:"200",blockAlign:"center",children:[e.jsx(re,{}),e.jsx(c,{as:"h3",variant:"headingMd",children:"How Points Work"})]}),e.jsx(te,{}),e.jsxs(b,{gap:"200",children:[e.jsxs(c,{as:"p",variant:"bodySm",children:[e.jsx("strong",{children:"Earning:"})," Customers earn points based on your earning rules - per dollar spent, on trade-ins, referrals, and more."]}),e.jsxs(c,{as:"p",variant:"bodySm",children:[e.jsx("strong",{children:"Redeeming:"})," Points are redeemed for rewards in your catalog - typically store credit that syncs to Shopify."]}),e.jsxs(c,{as:"p",variant:"bodySm",children:[e.jsx("strong",{children:"Default:"})," 1 point per $1 spent, 100 points = $1 store credit."]})]})]})})})]}),e.jsx(v,{open:q,onClose:()=>_(!1),title:"Create Earning Rule",primaryAction:{content:"Create",onAction:J,loading:R.isPending,disabled:!s.name.trim()},secondaryActions:[{content:"Cancel",onAction:()=>_(!1)}],children:e.jsx(v.Section,{children:e.jsxs(I,{children:[e.jsx(d,{label:"Rule Name",value:s.name,onChange:r=>p({...s,name:r}),placeholder:"e.g., Base Purchase Rate, Double Points Day",autoComplete:"off"}),e.jsx(d,{label:"Description",value:s.description,onChange:r=>p({...s,description:r}),placeholder:"Brief description of this rule",autoComplete:"off"}),e.jsx(O,{label:"Trigger",options:[{label:"Purchase",value:"purchase"},{label:"Trade-in",value:"trade_in"},{label:"Referral",value:"referral"},{label:"Signup",value:"signup"},{label:"Anniversary",value:"anniversary"}],value:s.trigger_source,onChange:r=>p({...s,trigger_source:r})}),e.jsx(d,{label:"Points per Dollar",type:"number",value:s.points_per_dollar,onChange:r=>p({...s,points_per_dollar:r}),autoComplete:"off",helpText:"How many points to award per $1 spent"}),e.jsx(d,{label:"Minimum Order Value (optional)",type:"number",value:s.min_order_value,onChange:r=>p({...s,min_order_value:r}),prefix:"$",autoComplete:"off",helpText:"Order must be at least this amount to qualify"})]})})}),e.jsx(v,{open:B,onClose:()=>x(!1),title:"Create Reward",primaryAction:{content:"Create",onAction:V,loading:A.isPending,disabled:!i.name.trim()},secondaryActions:[{content:"Cancel",onAction:()=>x(!1)}],children:e.jsx(v.Section,{children:e.jsxs(I,{children:[e.jsx(d,{label:"Reward Name",value:i.name,onChange:r=>m({...i,name:r}),placeholder:"e.g., $5 Store Credit, Free Shipping",autoComplete:"off"}),e.jsx(d,{label:"Description",value:i.description,onChange:r=>m({...i,description:r}),placeholder:"Brief description of this reward",autoComplete:"off"}),e.jsx(O,{label:"Reward Type",options:[{label:"Store Credit",value:"store_credit"},{label:"Discount Code",value:"discount_code"},{label:"Free Product",value:"free_product"},{label:"Free Shipping",value:"free_shipping"}],value:i.reward_type,onChange:r=>m({...i,reward_type:r})}),e.jsx(d,{label:"Points Cost",type:"number",value:i.points_cost,onChange:r=>m({...i,points_cost:r}),autoComplete:"off",helpText:"Points required to redeem this reward"}),i.reward_type==="store_credit"&&e.jsx(d,{label:"Credit Value",type:"number",value:i.credit_value,onChange:r=>m({...i,credit_value:r}),prefix:"$",autoComplete:"off",helpText:"Store credit amount to issue"})]})})})]})]}):e.jsx(E,{title:"Points & Rewards",children:e.jsx($,{tone:"warning",children:e.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})})}export{fe as EmbeddedPoints};
