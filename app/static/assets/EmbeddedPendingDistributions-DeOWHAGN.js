import{b as ae,u as Y,c as B,j as e}from"./vendor-query-Bq4hz6H9.js";import{r as u}from"./vendor-router-CdtyvhQv.js";import{a as A,g as k}from"./index-CHD2jXUp.js";import{P as H,B as h,L as S,C as b,h as l,a as i,T as n,t as c,b as _,l as re,u as J,c as T,X as V,E as oe,M as m,z as E,$ as G,g as de,D as le}from"./vendor-polaris-CV39Dq-f.js";import{T as ce}from"./vendor-appbridge-DL6abzKC.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";function pe(){const[a,d]=u.useState(()=>{if(typeof window>"u")return{isMobile:!1,isTablet:!1};const r=window.innerWidth;return{isMobile:r<768,isTablet:r>=768&&r<1024}});return u.useEffect(()=>{const r=()=>{const o=window.innerWidth;d({isMobile:o<768,isTablet:o>=768&&o<1024})};return window.addEventListener("resize",r),()=>window.removeEventListener("resize",r)},[]),a}async function ue(a,d,r){const o=new URLSearchParams;d&&o.append("status",d),r&&o.append("include_all","true");const y=`${k()}/pending-distributions${o.toString()?"?"+o.toString():""}`,v=await A(y,a);if(!v.ok)throw new Error("Failed to fetch pending distributions");return v.json()}async function he(a,d,r){const o=await A(`${k()}/pending-distributions/${d}/approve`,a,{method:"POST",body:JSON.stringify({enable_auto_approve:r})});if(!o.ok){const y=await o.json();throw new Error(y.error||"Failed to approve distribution")}return o.json()}async function je(a,d,r){const o=await A(`${k()}/pending-distributions/${d}/reject`,a,{method:"POST",body:JSON.stringify({reason:r})});if(!o.ok){const y=await o.json();throw new Error(y.error||"Failed to reject distribution")}return o.json()}async function xe(a){const d=await A(`${k()}/pending-distributions/settings`,a);if(!d.ok)throw new Error("Failed to fetch settings");return d.json()}async function ge(a,d){const r=await A(`${k()}/pending-distributions/settings`,a,{method:"PUT",body:JSON.stringify(d)});if(!r.ok){const o=await r.json();throw new Error(o.error||"Failed to update settings")}return r.json()}function _e({shop:a}){const d=ae(),{isMobile:r,isTablet:o}=pe(),[y,v]=u.useState(!1),[X,M]=u.useState(!1),[Z,R]=u.useState(!1),[ee,P]=u.useState(!1),[s,w]=u.useState(null),[q,F]=u.useState(!1),[N,O]=u.useState(""),[x,ne]=u.useState(!1),{data:z,isLoading:te}=Y({queryKey:["pending-distributions",a,x],queryFn:()=>ue(a,x?void 0:"pending",x),enabled:!!a,refetchInterval:3e4}),{data:p}=Y({queryKey:["pending-distributions-settings",a],queryFn:()=>xe(a),enabled:!!a}),C=B({mutationFn:()=>he(a,s.id,q),onSuccess:()=>{d.invalidateQueries({queryKey:["pending-distributions"]}),d.invalidateQueries({queryKey:["pending-distributions-settings"]}),v(!1),w(null),F(!1)}}),D=B({mutationFn:()=>je(a,s.id,N),onSuccess:()=>{d.invalidateQueries({queryKey:["pending-distributions"]}),M(!1),w(null),O("")}}),I=B({mutationFn:t=>ge(a,t),onSuccess:()=>{d.invalidateQueries({queryKey:["pending-distributions-settings"]})}}),se=u.useCallback(t=>{w(t),F(!1),v(!0)},[]),ie=u.useCallback(t=>{w(t),O(""),M(!0)},[]),L=u.useCallback(t=>{w(t),R(!0)},[]),g=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t),f=t=>new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"2-digit",minute:"2-digit"}),K=t=>{switch(t.status){case"pending":return e.jsx(c,{tone:"attention",children:"Pending Approval"});case"approved":return e.jsx(c,{tone:"success",children:"Approved"});case"rejected":return e.jsx(c,{tone:"critical",children:"Rejected"});case"expired":return e.jsx(c,{children:"Expired"});default:return e.jsx(c,{children:t.status})}},Q=t=>{if(t.status!=="pending")return null;const j=t.days_until_expiry;return j===null?null:j<=1?e.jsx(c,{tone:"critical",children:"Expires today"}):j<=3?e.jsx(c,{tone:"warning",children:`Expires in ${j} days`}):e.jsx(c,{tone:"info",children:`Expires in ${j} days`})};if(!a)return e.jsx(H,{title:"Pending Distributions",children:e.jsx(h,{tone:"warning",children:e.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})});const $=z?.distributions||[],W=z?.pending_count||0,U=$.filter(t=>t.status==="pending");return e.jsxs(e.Fragment,{children:[e.jsx(ce,{title:"Pending Distributions"}),e.jsxs(H,{title:"Pending Distributions",subtitle:"Review and approve monthly credit distributions before they are issued",secondaryActions:[{content:x?"Show Pending Only":"Show History",onAction:()=>ne(!x)},{content:"Settings",onAction:()=>P(!0)}],children:[e.jsxs(S,{children:[W>0&&!x&&e.jsx(S.Section,{children:e.jsx(h,{title:`${W} distribution${W>1?"s":""} awaiting approval`,tone:"warning",action:{content:"Review Now",onAction:()=>U[0]&&L(U[0])},children:e.jsx("p",{children:"Monthly credits have been calculated and are ready for your review. Please approve or reject before they expire."})})}),p&&e.jsx(S.Section,{children:e.jsx(b,{children:e.jsxs(l,{align:"space-between",blockAlign:"center",children:[e.jsxs(i,{gap:"100",children:[e.jsx(n,{as:"h3",variant:"headingSm",children:"Auto-Approve Status"}),e.jsx(n,{as:"p",variant:"bodySm",tone:"subdued",children:p.enabled?"Future distributions will be automatically approved":p.eligible?"Auto-approve is available but not enabled":"Complete your first manual approval to enable auto-approve"})]}),e.jsx(c,{tone:p.enabled?"success":p.eligible?"info":"attention",children:p.enabled?"Enabled":p.eligible?"Available":"Not Yet Eligible"})]})})}),e.jsx(S.Section,{children:e.jsx(b,{children:te?e.jsx(i,{gap:"400",align:"center",children:e.jsx(_,{padding:"800",children:e.jsx(re,{accessibilityLabel:"Loading distributions",size:"large"})})}):$.length>0?e.jsx(i,{gap:"400",children:$.map(t=>e.jsx(b,{children:e.jsxs(i,{gap:"400",children:[e.jsx(l,{align:"space-between",blockAlign:"center",wrap:!1,children:e.jsxs(i,{gap:"100",children:[e.jsxs(l,{gap:"200",blockAlign:"center",children:[e.jsx(n,{as:"h3",variant:"headingMd",children:t.display_name}),K(t),Q(t)]}),e.jsxs(n,{as:"p",variant:"bodySm",tone:"subdued",children:["Created ",f(t.created_at)]})]})}),e.jsxs(J,{columns:r?2:4,gap:"300",children:[e.jsx(_,{background:"bg-surface-secondary",padding:"300",borderRadius:"200",children:e.jsxs(i,{gap:"100",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"Members"}),e.jsx(n,{as:"p",variant:"headingLg",children:t.preview_data?.total_members||0})]})}),e.jsx(_,{background:"bg-surface-secondary",padding:"300",borderRadius:"200",children:e.jsxs(i,{gap:"100",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"Total Amount"}),e.jsx(n,{as:"p",variant:"headingLg",tone:"success",children:g(t.preview_data?.total_amount||0)})]})}),e.jsx(_,{background:"bg-surface-secondary",padding:"300",borderRadius:"200",children:e.jsxs(i,{gap:"100",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"Tiers"}),e.jsx(n,{as:"p",variant:"headingLg",children:t.preview_data?.by_tier?.length||0})]})}),e.jsx(_,{background:"bg-surface-secondary",padding:"300",borderRadius:"200",children:e.jsxs(i,{gap:"100",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"Skipped"}),e.jsx(n,{as:"p",variant:"headingLg",children:t.preview_data?.skipped||0})]})})]}),t.preview_data?.by_tier&&t.preview_data.by_tier.length>0&&e.jsxs(i,{gap:"200",children:[e.jsx(n,{as:"h4",variant:"headingSm",children:"Tier Breakdown"}),e.jsx(i,{gap:"100",children:t.preview_data.by_tier.map(j=>e.jsxs(l,{align:"space-between",blockAlign:"center",children:[e.jsxs(l,{gap:"200",blockAlign:"center",children:[e.jsx(c,{children:j.tier}),e.jsxs(n,{as:"span",variant:"bodySm",children:[j.count," members"]})]}),e.jsx(n,{as:"span",variant:"bodySm",fontWeight:"semibold",children:g(j.amount)})]},j.tier))})]}),t.execution_result&&e.jsx(h,{tone:"success",children:e.jsxs("p",{children:["Distributed ",g(t.execution_result.total_amount)," to"," ",t.execution_result.credited," members on"," ",f(t.execution_result.executed_at)]})}),t.rejection_reason&&e.jsx(h,{tone:"critical",children:e.jsxs("p",{children:["Rejected: ",t.rejection_reason]})}),t.status==="pending"&&e.jsxs(l,{gap:"200",align:"end",children:[e.jsx(T,{onClick:()=>L(t),children:"View Details"}),e.jsx(T,{tone:"critical",onClick:()=>ie(t),children:"Reject"}),e.jsx(T,{variant:"primary",icon:V,onClick:()=>se(t),children:"Approve"})]}),t.status!=="pending"&&e.jsx(l,{gap:"200",align:"end",children:e.jsx(T,{onClick:()=>L(t),children:"View Details"})})]})},t.id))}):e.jsx(oe,{heading:x?"No distribution history":"No pending distributions",image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:x?"Distribution history will appear here after you approve or reject distributions.":"Monthly credit distributions will appear here when they are ready for review. Check back on the 1st of the month."})})})}),e.jsx(S.Section,{children:e.jsx(b,{children:e.jsxs(i,{gap:"400",children:[e.jsx(n,{as:"h3",variant:"headingMd",children:"How Distribution Approval Works"}),e.jsxs(i,{gap:"200",children:[e.jsxs(l,{gap:"200",blockAlign:"start",children:[e.jsx(c,{tone:"info",children:"1"}),e.jsxs(i,{gap:"050",children:[e.jsx(n,{as:"p",variant:"bodyMd",fontWeight:"semibold",children:"Monthly Calculation"}),e.jsx(n,{as:"p",variant:"bodySm",tone:"subdued",children:"On the 1st of each month, credits are calculated based on member tiers"})]})]}),e.jsxs(l,{gap:"200",blockAlign:"start",children:[e.jsx(c,{tone:"info",children:"2"}),e.jsxs(i,{gap:"050",children:[e.jsx(n,{as:"p",variant:"bodyMd",fontWeight:"semibold",children:"Review Period"}),e.jsx(n,{as:"p",variant:"bodySm",tone:"subdued",children:"You have 7 days to review the distribution before it expires"})]})]}),e.jsxs(l,{gap:"200",blockAlign:"start",children:[e.jsx(c,{tone:"info",children:"3"}),e.jsxs(i,{gap:"050",children:[e.jsx(n,{as:"p",variant:"bodyMd",fontWeight:"semibold",children:"Approve or Reject"}),e.jsx(n,{as:"p",variant:"bodySm",tone:"subdued",children:"Approve to issue credits to Shopify, or reject if there's an issue"})]})]}),e.jsxs(l,{gap:"200",blockAlign:"start",children:[e.jsx(c,{tone:"success",children:"4"}),e.jsxs(i,{gap:"050",children:[e.jsx(n,{as:"p",variant:"bodyMd",fontWeight:"semibold",children:"Auto-Approve (Optional)"}),e.jsx(n,{as:"p",variant:"bodySm",tone:"subdued",children:"After your first approval, you can enable auto-approve for future distributions"})]})]})]})]})})})]}),e.jsx(m,{open:y,onClose:()=>v(!1),title:"Confirm Distribution",primaryAction:{content:"Approve & Distribute",icon:V,onAction:()=>C.mutate(),loading:C.isPending},secondaryActions:[{content:"Cancel",onAction:()=>v(!1)}],children:e.jsx(m.Section,{children:e.jsxs(i,{gap:"400",children:[e.jsx(h,{tone:"warning",children:e.jsxs("p",{children:[e.jsx("strong",{children:"This action cannot be undone."})," Credits will be immediately added to member accounts in Shopify."]})}),s&&e.jsx(b,{children:e.jsxs(i,{gap:"200",children:[e.jsx(n,{as:"h4",variant:"headingSm",children:"Distribution Summary"}),e.jsx(E,{}),e.jsxs(l,{align:"space-between",children:[e.jsx(n,{as:"span",children:"Members to credit:"}),e.jsx(n,{as:"span",fontWeight:"semibold",children:s.preview_data?.total_members||0})]}),e.jsxs(l,{align:"space-between",children:[e.jsx(n,{as:"span",children:"Total amount:"}),e.jsx(n,{as:"span",fontWeight:"semibold",tone:"success",children:g(s.preview_data?.total_amount||0)})]})]})}),p?.eligible&&e.jsx(G,{label:"Enable auto-approve for future monthly distributions",helpText:"After enabling, future distributions will be automatically approved. You can disable this anytime in Settings.",checked:q,onChange:F}),C.isError&&e.jsx(h,{tone:"critical",children:e.jsx("p",{children:C.error.message})})]})})}),e.jsx(m,{open:X,onClose:()=>M(!1),title:"Reject Distribution",primaryAction:{content:"Reject",destructive:!0,onAction:()=>D.mutate(),loading:D.isPending},secondaryActions:[{content:"Cancel",onAction:()=>M(!1)}],children:e.jsx(m.Section,{children:e.jsxs(i,{gap:"400",children:[e.jsx(h,{tone:"warning",children:e.jsx("p",{children:"Rejecting this distribution will prevent credits from being issued for this month. You can create a new distribution manually if needed."})}),e.jsx(de,{label:"Reason for rejection (optional)",value:N,onChange:O,multiline:3,autoComplete:"off",placeholder:"e.g., Incorrect tier assignments, waiting for tier updates..."}),D.isError&&e.jsx(h,{tone:"critical",children:e.jsx("p",{children:D.error.message})})]})})}),e.jsx(m,{open:Z,onClose:()=>R(!1),title:s?.display_name||"Distribution Details",size:"large",secondaryActions:[{content:"Close",onAction:()=>R(!1)}],children:e.jsx(m.Section,{children:s&&e.jsxs(i,{gap:"400",children:[e.jsxs(l,{gap:"200",blockAlign:"center",children:[e.jsx(n,{as:"span",variant:"bodyMd",children:"Status:"}),K(s),Q(s)]}),e.jsx(b,{children:e.jsxs(i,{gap:"200",children:[e.jsx(n,{as:"h4",variant:"headingSm",children:"Timeline"}),e.jsx(E,{}),e.jsxs(l,{align:"space-between",children:[e.jsx(n,{as:"span",tone:"subdued",children:"Created:"}),e.jsx(n,{as:"span",children:f(s.created_at)})]}),s.expires_at&&s.status==="pending"&&e.jsxs(l,{align:"space-between",children:[e.jsx(n,{as:"span",tone:"subdued",children:"Expires:"}),e.jsx(n,{as:"span",children:f(s.expires_at)})]}),s.approved_at&&e.jsxs(l,{align:"space-between",children:[e.jsx(n,{as:"span",tone:"subdued",children:"Approved:"}),e.jsxs(n,{as:"span",children:[f(s.approved_at)," by ",s.approved_by]})]}),s.rejected_at&&e.jsxs(l,{align:"space-between",children:[e.jsx(n,{as:"span",tone:"subdued",children:"Rejected:"}),e.jsxs(n,{as:"span",children:[f(s.rejected_at)," by ",s.rejected_by]})]})]})}),e.jsx(b,{children:e.jsxs(i,{gap:"200",children:[e.jsx(n,{as:"h4",variant:"headingSm",children:"Summary"}),e.jsx(E,{}),e.jsxs(J,{columns:r?2:4,gap:"200",children:[e.jsxs(i,{gap:"050",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"Members"}),e.jsx(n,{as:"p",variant:"headingMd",children:s.preview_data?.total_members||0})]}),e.jsxs(i,{gap:"050",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"Total Amount"}),e.jsx(n,{as:"p",variant:"headingMd",tone:"success",children:g(s.preview_data?.total_amount||0)})]}),e.jsxs(i,{gap:"050",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"Processed"}),e.jsx(n,{as:"p",variant:"headingMd",children:s.preview_data?.processed||0})]}),e.jsxs(i,{gap:"050",children:[e.jsx(n,{as:"span",variant:"bodySm",tone:"subdued",children:"Skipped"}),e.jsx(n,{as:"p",variant:"headingMd",children:s.preview_data?.skipped||0})]})]})]})}),s.preview_data?.by_tier&&s.preview_data.by_tier.length>0&&e.jsx(b,{children:e.jsxs(i,{gap:"200",children:[e.jsx(n,{as:"h4",variant:"headingSm",children:"Tier Breakdown"}),e.jsx(E,{}),e.jsx(le,{columnContentTypes:["text","numeric","numeric"],headings:["Tier","Members","Amount"],rows:s.preview_data.by_tier.map(t=>[t.tier,String(t.count),g(t.amount)]),totals:["Total",String(s.preview_data.total_members),g(s.preview_data.total_amount)]})]})}),s.execution_result&&e.jsx(h,{tone:"success",children:e.jsxs(i,{gap:"100",children:[e.jsx(n,{as:"p",fontWeight:"semibold",children:"Distribution Completed"}),e.jsxs(n,{as:"p",children:[s.execution_result.credited," members credited"," ",g(s.execution_result.total_amount)," total"]}),s.execution_result.errors>0&&e.jsxs(n,{as:"p",tone:"critical",children:[s.execution_result.errors," errors occurred"]})]})}),s.rejection_reason&&e.jsx(h,{tone:"critical",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Rejection reason:"})," ",s.rejection_reason]})})]})})}),e.jsx(m,{open:ee,onClose:()=>P(!1),title:"Auto-Approve Settings",primaryAction:{content:"Save",onAction:()=>P(!1)},children:e.jsx(m.Section,{children:e.jsx(i,{gap:"400",children:p&&e.jsxs(e.Fragment,{children:[!p.eligible&&e.jsx(h,{tone:"info",children:e.jsx("p",{children:"Auto-approve will be available after you manually approve your first monthly credit distribution. This is a safety measure to ensure you review the initial setup."})}),e.jsx(G,{label:"Enable auto-approve for monthly distributions",helpText:"When enabled, future monthly credit distributions will be automatically approved and issued without manual review.",checked:p.enabled,onChange:t=>I.mutate({enabled:t}),disabled:!p.eligible||I.isPending}),p.enabled&&e.jsx(h,{tone:"success",children:e.jsx("p",{children:"Auto-approve is enabled. Future monthly distributions will be automatically processed. You will still receive email notifications."})})]})})})})]})]})}export{_e as EmbeddedPendingDistributions,_e as default};
