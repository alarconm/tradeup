import{b as _e,u as le,j as e,c as H}from"./vendor-query-Bq4hz6H9.js";import{r as i}from"./vendor-router-CdtyvhQv.js";import{a as E,g as A}from"./index-CIr4Wx79.js";import{P as Fe,B as j,G as Ee,H as Pe,k as De,J as qe,v as Re,L as Te,C as je,b as F,K as Le,h as b,N as be,T as t,c as J,O as Be,Q as Ke,l as Se,a as r,z as Ie,t as G,D as Oe,U as Qe,E as Ue,M as m,e as oe,f as ve,g as Q,I as ze,V as He,W as Me,X as We,Y as ye}from"./vendor-polaris-vFYxDTRx.js";import{T as Ve}from"./vendor-appbridge-DL6abzKC.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";const Je=[{label:"Never expires",value:""},{label:"30 days",value:"30"},{label:"60 days",value:"60"},{label:"90 days",value:"90"},{label:"180 days",value:"180"},{label:"1 year (365 days)",value:"365"}];async function Xe(n){const o=await E(`${A()}/members/tiers`,n);if(!o.ok)throw new Error("Failed to fetch tiers");return o.json()}async function Ye(n){const o=await E(`${A()}/settings`,n);if(!o.ok)throw new Error("Failed to fetch settings");return o.json()}async function Ze(n,o,d,g,h){const f=new URLSearchParams;f.set("page",String(o)),f.set("per_page","20"),d&&f.set("search",d),g&&f.set("tier",g),h&&f.set("status",h);const c=await E(`${A()}/members?${f}`,n);if(!c.ok)throw new Error("Failed to fetch members");return c.json()}function Ge(n=768){const[o,d]=i.useState(typeof window<"u"?window.innerWidth<n:!1);return i.useEffect(()=>{const g=()=>d(window.innerWidth<n);return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[n]),o}function $e(n,o){const[d,g]=i.useState(n);return i.useEffect(()=>{const h=setTimeout(()=>g(n),o);return()=>clearTimeout(h)},[n,o]),d}function pn({shop:n}){const[o,d]=i.useState(1),[g,h]=i.useState(""),[f,c]=i.useState([]),[y,C]=i.useState([]),[N,M]=i.useState(null),[R,S]=i.useState(!1),[I,v]=i.useState(!1),[O,$]=i.useState(!1),[w,x]=i.useState([]),[k,p]=i.useState(!1),[_,l]=i.useState(!1),L=Ge(),U=_e(),ee=$e(g,150),{data:T,isLoading:he,error:ne,isFetching:W}=le({queryKey:["members",n,o,ee,f[0],y[0]],queryFn:()=>Ze(n,o,ee,f[0]||"",y[0]||""),enabled:!!n,retry:1,staleTime:5e3,placeholderData:s=>s}),{data:X}=le({queryKey:["tiers",n],queryFn:()=>Xe(n),enabled:!!n,staleTime:6e4}),{data:Z}=le({queryKey:["settings",n],queryFn:()=>Ye(n),enabled:!!n,staleTime:3e5}),ce=Z?.settings?.general?.timezone||"America/Los_Angeles",u=i.useCallback(s=>{h(s),d(1)},[]),K=i.useCallback(s=>{c(s),d(1)},[]),se=i.useCallback(()=>{h(""),c([]),C([]),d(1)},[]),pe=i.useCallback(()=>{if(!T?.members?.length)return;const s=["Name","Email","Tier","Status","Trade-Ins","Credits Issued","Member Since","Last Activity"],z=T.members.map(D=>[`${D.first_name||""} ${D.last_name||""}`.trim(),D.email||"",D.tier?.name||"None",D.status||"",D.trade_in_count||0,D.total_credits_issued||0,D.created_at?new Date(D.created_at).toLocaleDateString():"",D.last_trade_in_at?new Date(D.last_trade_in_at).toLocaleDateString():"Never"]),P=[s,...z].map(D=>D.map(re=>`"${String(re).replace(/"/g,'""')}"`).join(",")).join(`
`),ae=new Blob([P],{type:"text/csv;charset=utf-8;"}),ue=URL.createObjectURL(ae),Y=document.createElement("a");Y.href=ue,Y.download=`tradeup-members-${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(Y),Y.click(),document.body.removeChild(Y),URL.revokeObjectURL(ue)},[T]),ge=i.useCallback(s=>s?new Date(s).toLocaleDateString("en-US",{timeZone:ce,month:"numeric",day:"numeric",year:"numeric"}):"Never",[ce]),we=i.useCallback(s=>{x(z=>z.includes(s)?z.filter(P=>P!==s):[...z,s])},[]),te=i.useCallback(()=>{const s=T?.members?.filter(P=>P&&P.id!=null).map(P=>P.id)||[],z=s.every(P=>w.includes(P));x(z?P=>P.filter(ae=>!s.includes(ae)):P=>[...new Set([...P,...s])])},[T?.members,w]),me=i.useCallback(()=>{x([])},[]),ie=T?.members?.filter(s=>s&&s.id!=null).map(s=>s.id)||[],B=ie.length>0&&ie.every(s=>w.includes(s)),Ce=ie.some(s=>w.includes(s));if(!n)return e.jsx(Fe,{title:"Members",children:e.jsx(j,{tone:"warning",children:e.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})});const de=s=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(s||0),ke=X?.tiers?X.tiers.filter(s=>s&&s.active&&s.name).map(s=>({label:s.name||"",value:String(s.name||"").toLowerCase()})):[],xe=[{label:"Active",value:"active"},{label:"Suspended",value:"suspended"},{label:"Cancelled",value:"cancelled"}],fe=s=>{C(s),d(1)},Ae=[...ke.length>0?[{key:"tier",label:"Tier",filter:e.jsx(Ee,{title:"Tier",titleHidden:!0,choices:ke,selected:f,onChange:K}),shortcut:!0}]:[],{key:"status",label:"Status",filter:e.jsx(Ee,{title:"Status",titleHidden:!0,choices:xe,selected:y,onChange:fe}),shortcut:!0}],V=[...f.length>0?[{key:"tier",label:`Tier: ${f[0]}`,onRemove:()=>c([])}]:[],...y.length>0?[{key:"status",label:`Status: ${y[0]}`,onRemove:()=>C([])}]:[]];return e.jsxs(e.Fragment,{children:[e.jsx(Ve,{title:"Members",children:e.jsx("button",{variant:"primary",onClick:()=>v(!0),children:"Add member"})}),e.jsxs(Fe,{title:"Members",subtitle:W&&g?"Searching...":`${T?.total||0} total members`,primaryAction:{content:"Add Member",icon:Re,onAction:()=>v(!0)},secondaryActions:[{content:"Import CSV",icon:Pe,onAction:()=>$(!0)},{content:"Email Members",icon:De,onAction:()=>S(!0)},{content:"Export",icon:qe,disabled:!T?.members?.length,onAction:pe}],children:[e.jsxs(Te,{children:[ne&&e.jsx(Te.Section,{children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:"Failed to load members. Please try refreshing the page."})})}),e.jsx(Te.Section,{children:e.jsxs(je,{padding:"0",children:[e.jsx(F,{padding:"400",children:e.jsx(Le,{queryValue:g,queryPlaceholder:"Search by name or email",onQueryChange:u,onQueryClear:()=>h(""),filters:Ae,appliedFilters:V,onClearAll:se})}),w.length>0&&e.jsx(F,{padding:"400",background:"bg-surface-secondary",children:e.jsxs(b,{align:"space-between",blockAlign:"center",children:[e.jsxs(b,{gap:"200",blockAlign:"center",children:[e.jsx(be,{label:"",checked:B,onChange:te}),e.jsxs(t,{as:"span",variant:"bodyMd",children:[w.length," member",w.length!==1?"s":""," selected"]}),e.jsx(J,{variant:"plain",onClick:me,children:"Clear selection"})]}),e.jsx(Be,{active:k,activator:e.jsx(J,{onClick:()=>p(!k),disclosure:!0,children:"Bulk Actions"}),autofocusTarget:"first-node",onClose:()=>p(!1),children:e.jsx(Ke,{actionRole:"menuitem",items:[{content:"Assign Tier",onAction:()=>{p(!1),l(!0)}}]})})]})}),he?e.jsx(F,{padding:"1600",children:e.jsx(b,{align:"center",children:e.jsx(Se,{size:"large"})})}):T?.members&&T.members.length>0?e.jsxs(e.Fragment,{children:[L?e.jsx(F,{padding:"300",children:e.jsxs(r,{gap:"300",children:[e.jsx(b,{gap:"200",blockAlign:"center",children:e.jsx(be,{label:"Select all on page",checked:B,onChange:te,labelHidden:!Ce&&!B})}),T.members.filter(s=>s&&s.id!=null).map((s,z)=>e.jsxs(F,{children:[z>0&&e.jsx(Ie,{}),e.jsx(F,{paddingBlock:"300",children:e.jsxs(b,{gap:"300",blockAlign:"start",wrap:!1,children:[e.jsx(be,{label:"",checked:w.includes(s.id),onChange:()=>we(s.id)}),e.jsx("div",{style:{flex:1,minWidth:0},children:e.jsxs(r,{gap:"200",children:[e.jsxs(b,{align:"space-between",blockAlign:"start",children:[e.jsxs(r,{gap:"050",children:[e.jsxs(J,{variant:"plain",onClick:()=>M(s),children:[s.first_name," ",s.last_name]}),e.jsx(t,{as:"p",variant:"bodySm",tone:"subdued",children:s.email})]}),e.jsxs(r,{gap:"100",inlineAlign:"end",children:[e.jsx(G,{tone:"info",children:String(s.tier?.name||"None")}),e.jsx(G,{tone:s.status==="active"?"success":void 0,children:String(s.status||"unknown")})]})]}),e.jsxs(b,{gap:"400",wrap:!0,children:[e.jsxs(r,{gap:"050",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Trade-Ins"}),e.jsx(t,{as:"span",fontWeight:"medium",children:s.trade_in_count})]}),e.jsxs(r,{gap:"050",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Credits"}),e.jsx(t,{as:"span",fontWeight:"medium",children:de(s.total_credits_issued)})]}),e.jsxs(r,{gap:"050",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Last Active"}),e.jsx(t,{as:"span",fontWeight:"medium",children:ge(s.last_trade_in_at)})]})]})]})})]})})]},s.id))]})}):e.jsx(Oe,{columnContentTypes:["text","text","text","text","numeric","numeric","text"],headings:[e.jsx(be,{label:"",checked:B,onChange:te},"select-all"),"Member","Tier","Status","Trade-Ins","Credits Issued","Last Activity"],rows:T.members.filter(s=>s&&s.id!=null).map(s=>[e.jsx(be,{label:"",checked:w.includes(s.id),onChange:()=>we(s.id)},`select-${s.id}`),e.jsxs(r,{gap:"100",children:[e.jsxs(J,{variant:"plain",onClick:()=>M(s),children:[s.first_name||""," ",s.last_name||""]}),e.jsx(t,{as:"p",variant:"bodySm",tone:"subdued",children:s.email})]},s.id),e.jsx(G,{tone:"info",children:String(s.tier?.name||"None")},`tier-${s.id}`),e.jsx(G,{tone:s.status==="active"?"success":void 0,children:String(s.status||"unknown")},`status-${s.id}`),s.trade_in_count,de(s.total_credits_issued),ge(s.last_trade_in_at)])}),e.jsx(F,{padding:"400",children:e.jsx(b,{align:"center",children:e.jsx(Qe,{hasPrevious:o>1,onPrevious:()=>d(o-1),hasNext:o<(T?.pages||1),onNext:()=>d(o+1)})})})]}):e.jsx(F,{padding:"1600",children:e.jsx(Ue,{heading:"No members found",image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:g||f.length>0?"Try adjusting your search or filters.":"Members will appear here when customers join your program."})})})]})})]}),e.jsx(en,{member:N,shop:n,onClose:()=>M(null),onMemberUpdated:s=>M(s),formatCurrency:de,formatDate:ge}),e.jsx(nn,{open:R,onClose:()=>S(!1),shop:n,tiers:X?.tiers}),e.jsx(sn,{open:I,onClose:()=>v(!1),shop:n}),e.jsx(tn,{open:O,onClose:()=>$(!1),shop:n}),e.jsx(an,{open:_,onClose:()=>l(!1),shop:n,selectedMemberIds:w,tiers:X?.tiers,onSuccess:()=>{me(),U.invalidateQueries({queryKey:["members"]})}})]})]})}function en({member:n,shop:o,onClose:d,onMemberUpdated:g,formatCurrency:h,formatDate:f}){const[c,y]=i.useState(!1),[C,N]=i.useState(""),[M,R]=i.useState(""),[S,I]=i.useState(!1),[v,O]=i.useState(!1),[$,w]=i.useState(!1),[x,k]=i.useState(""),[p,_]=i.useState(""),[l,L]=i.useState(""),[U,ee]=i.useState(""),[T,he]=i.useState(""),[ne,W]=i.useState(!1),[X,Z]=i.useState(!1),[ce,u]=i.useState(!1),[K,se]=i.useState(!1),[pe,ge]=i.useState(!1),[we,te]=i.useState(!1),[me,ie]=i.useState(""),B=_e(),{data:Ce}=le({queryKey:["tiers-list",o],queryFn:async()=>{const a=await E(`${A()}/membership/tiers`,o);if(!a.ok)throw new Error("Failed to fetch tiers");return(await a.json()).tiers||[]},enabled:!!o&&!!n}),{data:de,isLoading:ke}=le({queryKey:["tier-history",o,n?.id],queryFn:async()=>{const a=await E(`${A()}/membership/tiers/history/${n?.id}`,o);if(!a.ok)throw new Error("Failed to fetch history");return a.json()},enabled:!!o&&!!n&&S}),xe=H({mutationFn:async()=>{const a=await E(`${A()}/membership/tiers/assign`,o,{method:"POST",body:JSON.stringify({member_id:n?.id,tier_id:C?parseInt(C):null,reason:M||"Staff assigned"})});if(!a.ok){const q=await a.json();throw new Error(q.error||"Failed to change tier")}return a.json()},onSuccess:()=>{if(B.invalidateQueries({queryKey:["members"]}),B.invalidateQueries({queryKey:["tier-history",o,n?.id]}),n){const a=Ce?.find(q=>String(q.id)===C);g({...n,tier:a?{id:a.id,name:a.name,color:""}:{id:0,name:"None",color:""}})}y(!1),N(""),R("")}}),{data:fe,isLoading:Ae}=le({queryKey:["credit-history",o,n?.id],queryFn:async()=>{const a=await E(`${A()}/bonuses?member_id=${n?.id}&per_page=10`,o);if(!a.ok)throw new Error("Failed to fetch credit history");return a.json()},enabled:!!o&&!!n&&pe}),V=H({mutationFn:async()=>{const a=await E(`${A()}/membership/store-credit/add`,o,{method:"POST",body:JSON.stringify({member_id:n?.id,amount:parseFloat(x),description:p||"Manual credit adjustment",expiration_days:l?parseInt(l):null})});if(!a.ok){const q=await a.json();throw new Error(q.error||"Failed to issue credit")}return a.json()},onSuccess:()=>{B.invalidateQueries({queryKey:["members"]}),B.invalidateQueries({queryKey:["credit-history",o,n?.id]})}}),s=H({mutationFn:async()=>{const a=await E(`${A()}/membership/store-credit/deduct`,o,{method:"POST",body:JSON.stringify({member_id:n?.id,amount:parseFloat(U),description:T||"Manual deduction"})});if(!a.ok){const q=await a.json();throw new Error(q.error||"Failed to deduct credit")}return a.json()},onSuccess:()=>{B.invalidateQueries({queryKey:["members"]}),B.invalidateQueries({queryKey:["credit-history",o,n?.id]})}}),z=i.useCallback((a=!1)=>{O(!1),k(""),_(""),L(""),V.reset(),a&&d()},[V,d]),P=i.useCallback((a=!1)=>{w(!1),ee(""),he(""),s.reset(),a&&d()},[s,d]),ae=H({mutationFn:async()=>{const a=await E(`${A()}/members/${n?.id}`,o,{method:"PUT",body:JSON.stringify({status:"cancelled"})});if(!a.ok){const q=await a.json();throw new Error(q.error||"Failed to cancel membership")}return a.json()},onSuccess:()=>{B.invalidateQueries({queryKey:["members"]}),W(!1),d()}}),ue=H({mutationFn:async()=>{const a=await E(`${A()}/members/${n?.id}`,o,{method:"DELETE"});if(!a.ok){const q=await a.json();throw new Error(q.error||"Failed to delete member")}return a.json()},onSuccess:()=>{B.invalidateQueries({queryKey:["members"]}),Z(!1),d()}}),Y=H({mutationFn:async()=>{const a=await E(`${A()}/members/${n?.id}/suspend`,o,{method:"POST"});if(!a.ok){const q=await a.json();throw new Error(q.error||"Failed to suspend membership")}return a.json()},onSuccess:()=>{B.invalidateQueries({queryKey:["members"]}),u(!1),d()}}),D=H({mutationFn:async()=>{const a=await E(`${A()}/members/${n?.id}/reactivate`,o,{method:"POST"});if(!a.ok){const q=await a.json();throw new Error(q.error||"Failed to reactivate membership")}return a.json()},onSuccess:()=>{B.invalidateQueries({queryKey:["members"]}),se(!1),d()}}),re=H({mutationFn:async()=>{const a=await E(`${A()}/members/${n?.id}`,o,{method:"PUT",body:JSON.stringify({partner_customer_id:me.trim()||null})});if(!a.ok){const q=await a.json();throw new Error(q.error||"Failed to update partner ID")}return a.json()},onSuccess:()=>{B.invalidateQueries({queryKey:["members"]}),n&&g({...n,partner_customer_id:me.trim()||null}),te(!1)}});if(!n)return null;const Ne=[{label:"No Tier",value:""},...Ce?.filter(a=>a&&a.name).map(a=>({label:a.name||"",value:String(a.id)}))||[]];return e.jsxs(e.Fragment,{children:[e.jsxs(m,{open:n!==null,onClose:d,title:`${n.first_name} ${n.last_name}`,primaryAction:{content:"Issue Credit",onAction:()=>O(!0),disabled:!n.shopify_customer_id},secondaryActions:[{content:"Deduct Credit",onAction:()=>w(!0),destructive:!0,disabled:!n.shopify_customer_id},{content:"Change Tier",onAction:()=>y(!0)},...n.status==="active"?[{content:"Suspend",onAction:()=>u(!0)}]:[],...n.status==="suspended"||n.status==="cancelled"?[{content:"Reactivate",onAction:()=>se(!0)}]:[],{content:"Cancel Membership",onAction:()=>W(!0),destructive:!0,disabled:n.status==="cancelled"},{content:"Delete Member",onAction:()=>Z(!0),destructive:!0}],children:[e.jsx(m.Section,{children:e.jsxs(r,{gap:"400",children:[!n.shopify_customer_id&&e.jsx(j,{tone:"critical",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Not linked to Shopify:"})," This member is not linked to a Shopify customer account. Store credit cannot be issued until the member is linked. Delete this member and re-add them by searching for an existing Shopify customer."]})}),e.jsxs(b,{gap:"400",children:[e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Email"}),e.jsx(t,{as:"span",children:n.email})]}),e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Tier"}),e.jsx(G,{tone:"info",children:String(n.tier?.name||"None")})]})]}),e.jsxs(b,{gap:"400",children:[e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Member Number"}),e.jsx(t,{as:"span",children:n.member_number||"-"})]}),e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Partner ID"}),e.jsxs(b,{gap:"200",blockAlign:"center",children:[e.jsx(t,{as:"span",children:n.partner_customer_id||"-"}),e.jsx(J,{variant:"plain",size:"slim",onClick:()=>{ie(n.partner_customer_id||""),te(!0)},children:"Edit"})]})]})]}),e.jsxs(b,{gap:"400",children:[e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Total Trade-Ins"}),e.jsx(t,{as:"span",children:n.trade_in_count})]}),e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Trade-In Value"}),e.jsx(t,{as:"span",children:h(n.total_trade_in_value)})]}),e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Credits Issued"}),e.jsx(t,{as:"span",children:h(n.total_credits_issued)})]})]}),e.jsxs(b,{gap:"400",children:[e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Member Since"}),e.jsx(t,{as:"span",children:f(n.created_at)})]}),e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Last Activity"}),e.jsx(t,{as:"span",children:f(n.last_trade_in_at)})]})]})]})}),e.jsx(m.Section,{children:e.jsxs(r,{gap:"300",children:[e.jsxs(b,{align:"space-between",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:"Tier History"}),e.jsxs(J,{variant:"plain",onClick:()=>I(!S),children:[S?"Hide":"Show"," History"]})]}),S&&(ke?e.jsx(b,{align:"center",children:e.jsx(Se,{size:"small"})}):de?.history&&de.history.length>0?e.jsx(r,{gap:"200",children:de.history.slice(0,5).filter(a=>a&&a.id!=null).map(a=>e.jsx(F,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:e.jsxs(b,{align:"space-between",children:[e.jsxs(r,{gap:"050",children:[e.jsxs(t,{as:"span",variant:"bodySm",children:[String(a.previous_tier||"None")," → ",String(a.new_tier||"None")]}),e.jsxs(t,{as:"span",variant:"bodySm",tone:"subdued",children:[String(a.change_type||"change")," • ",String(a.source_type||"system")]})]}),e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:a.created_at?f(a.created_at):"-"})]})},a.id))}):e.jsx(t,{as:"p",tone:"subdued",children:"No tier changes recorded"}))]})}),e.jsx(m.Section,{children:e.jsxs(r,{gap:"300",children:[e.jsxs(b,{align:"space-between",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:"Credit History"}),e.jsxs(J,{variant:"plain",onClick:()=>ge(!pe),children:[pe?"Hide":"Show"," History"]})]}),pe&&(Ae?e.jsx(b,{align:"center",children:e.jsx(Se,{size:"small"})}):fe?.bonuses&&fe.bonuses.length>0?e.jsx(r,{gap:"200",children:fe.bonuses.filter(a=>a&&a.id!=null).map(a=>e.jsx(F,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:e.jsxs(b,{align:"space-between",children:[e.jsxs(r,{gap:"050",children:[e.jsxs(b,{gap:"200",children:[e.jsxs(t,{as:"span",variant:"bodySm",fontWeight:"semibold",children:[a.amount>0?"+":"",h(a.amount)]}),a.synced_to_shopify&&e.jsx(G,{tone:"success",size:"small",children:"Synced"})]}),e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:String(a.description||a.event_type||"credit")})]}),e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:f(a.created_at)})]})},a.id))}):e.jsx(t,{as:"p",tone:"subdued",children:"No credit transactions recorded"}))]})})]}),e.jsx(m,{open:c,onClose:()=>y(!1),title:"Change Member Tier",primaryAction:{content:"Save",onAction:()=>xe.mutate(),loading:xe.isPending},secondaryActions:[{content:"Cancel",onAction:()=>y(!1)}],children:e.jsxs(m.Section,{children:[xe.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:xe.error?.message||"Failed to change tier"})})}),e.jsxs(oe,{children:[e.jsx(ve,{label:"New Tier",options:Ne,value:C,onChange:N}),e.jsx(Q,{label:"Reason (optional)",value:M,onChange:R,placeholder:"e.g., VIP upgrade, loyalty reward",autoComplete:"off"})]})]})}),e.jsx(m,{open:v,onClose:()=>z(!1),title:"Issue Store Credit",primaryAction:V.isSuccess?{content:"Done",onAction:()=>z(!0)}:{content:"Issue Credit",onAction:()=>V.mutate(),loading:V.isPending,disabled:!x||parseFloat(x)<=0},secondaryActions:V.isSuccess?[]:[{content:"Cancel",onAction:()=>z(!1)}],children:e.jsxs(m.Section,{children:[V.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:V.error?.message||"Failed to issue credit"})})}),V.isSuccess?e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",variant:"headingMd",children:"Credit Issued Successfully!"}),e.jsxs(t,{as:"p",children:[h(parseFloat(x))," has been added to ",n.first_name,"'s Shopify store credit balance."]})]})}):e.jsxs(oe,{children:[e.jsx(Q,{label:"Credit Amount",type:"number",value:x,onChange:k,prefix:"$",min:.01,step:.01,autoComplete:"off",helpText:"Amount to add to member's store credit balance"}),e.jsx(Q,{label:"Description (optional)",value:p,onChange:_,placeholder:"e.g., Loyalty bonus, Price adjustment",autoComplete:"off",helpText:"Reason for the credit (visible in history)"}),e.jsx(ve,{label:"Credit Expiration",options:Je,value:l,onChange:L,helpText:"When this credit should expire"})]})]})}),e.jsx(m,{open:$,onClose:()=>P(!1),title:"Deduct Store Credit",primaryAction:s.isSuccess?{content:"Done",onAction:()=>P(!0)}:{content:"Deduct Credit",onAction:()=>s.mutate(),loading:s.isPending,disabled:!U||parseFloat(U)<=0||!T,destructive:!0},secondaryActions:s.isSuccess?[]:[{content:"Cancel",onAction:()=>P(!1)}],children:e.jsxs(m.Section,{children:[s.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:s.error?.message||"Failed to deduct credit"})})}),s.isSuccess?e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",variant:"headingMd",children:"Credit Deducted Successfully!"}),e.jsxs(t,{as:"p",children:[h(parseFloat(U))," has been deducted from ",n.first_name,"'s Shopify store credit balance."]})]})}):e.jsxs(oe,{children:[e.jsx(j,{tone:"warning",children:e.jsx(t,{as:"p",children:"This will deduct store credit from the member's Shopify account. Use this for corrections, chargebacks, or other adjustments."})}),e.jsx(Q,{label:"Deduction Amount",type:"number",value:U,onChange:ee,prefix:"$",min:.01,step:.01,autoComplete:"off",helpText:"Amount to deduct from member's store credit balance"}),e.jsx(Q,{label:"Reason (required)",value:T,onChange:he,placeholder:"e.g., Chargeback reversal, Correction for order #1234",autoComplete:"off",helpText:"Reason for the deduction (visible in history)",requiredIndicator:!0,error:U&&parseFloat(U)>0&&!T?"Please provide a reason for this deduction":void 0})]})]})}),e.jsx(m,{open:ne,onClose:()=>W(!1),title:"Cancel Membership",primaryAction:{content:"Cancel Membership",onAction:()=>ae.mutate(),loading:ae.isPending,destructive:!0},secondaryActions:[{content:"Keep Active",onAction:()=>W(!1)}],children:e.jsxs(m.Section,{children:[ae.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:ae.error?.message||"Failed to cancel membership"})})}),e.jsx(j,{tone:"warning",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",fontWeight:"semibold",children:"Are you sure you want to cancel this membership?"}),e.jsxs(t,{as:"p",children:[n.first_name," ",n.last_name," will no longer receive member benefits. Their existing store credit will remain available."]})]})})]})}),e.jsx(m,{open:X,onClose:()=>Z(!1),title:"Delete Member",primaryAction:{content:"Delete Permanently",onAction:()=>ue.mutate(),loading:ue.isPending,destructive:!0},secondaryActions:[{content:"Cancel",onAction:()=>Z(!1)}],children:e.jsxs(m.Section,{children:[ue.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:ue.error?.message||"Failed to delete member"})})}),e.jsx(j,{tone:"critical",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",fontWeight:"semibold",children:"Are you sure you want to permanently delete this member?"}),e.jsxs(t,{as:"p",children:["This will remove ",n.first_name," ",n.last_name," (",n.email,") from TradeUp and delete all their credit history. This action cannot be undone."]}),e.jsx(t,{as:"p",children:"Note: This does NOT delete the customer from Shopify - only from TradeUp."})]})})]})}),e.jsx(m,{open:ce,onClose:()=>u(!1),title:"Suspend Membership",primaryAction:{content:"Suspend Membership",onAction:()=>Y.mutate(),loading:Y.isPending},secondaryActions:[{content:"Cancel",onAction:()=>u(!1)}],children:e.jsxs(m.Section,{children:[Y.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:Y.error?.message||"Failed to suspend membership"})})}),e.jsx(j,{tone:"warning",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",fontWeight:"semibold",children:"Suspend this membership?"}),e.jsxs(t,{as:"p",children:[n.first_name," ",n.last_name,"'s membership will be temporarily suspended. They will not receive member benefits, but their data and store credit will be preserved. You can reactivate their membership at any time."]})]})})]})}),e.jsx(m,{open:K,onClose:()=>se(!1),title:"Reactivate Membership",primaryAction:{content:"Reactivate Membership",onAction:()=>D.mutate(),loading:D.isPending},secondaryActions:[{content:"Cancel",onAction:()=>se(!1)}],children:e.jsxs(m.Section,{children:[D.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:D.error?.message||"Failed to reactivate membership"})})}),e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",fontWeight:"semibold",children:"Reactivate this membership?"}),e.jsxs(t,{as:"p",children:[n.first_name," ",n.last_name,"'s membership will be reactivated. They will immediately regain access to all member benefits and their existing store credit."]})]})})]})}),e.jsx(m,{open:we,onClose:()=>{te(!1),ie(""),re.reset()},title:"Edit Partner ID",primaryAction:{content:"Save",onAction:()=>re.mutate(),loading:re.isPending},secondaryActions:[{content:"Cancel",onAction:()=>{te(!1),ie(""),re.reset()}}],children:e.jsxs(m.Section,{children:[re.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:re.error?.message||"Failed to update partner ID"})})}),e.jsx(oe,{children:e.jsx(Q,{label:"Partner Customer ID",value:me,onChange:ie,placeholder:"e.g., ORB-12345, CUST-789",autoComplete:"off",helpText:"Your store's internal customer ID for this member (e.g., from your POS system)"})})]})})]})}function nn({open:n,onClose:o,shop:d,tiers:g}){const[h,f]=i.useState([]),[c,y]=i.useState(""),[C,N]=i.useState(""),[M,R]=i.useState(!1),[S,I]=i.useState(null),{data:v}=le({queryKey:["email-templates",d],queryFn:async()=>{const l=await E(`${A()}/members/email/templates`,d);if(!l.ok)throw new Error("Failed to fetch templates");return l.json()},enabled:!!d&&n}),O=H({mutationFn:async()=>{const l=await E(`${A()}/members/email/preview`,d,{method:"POST",body:JSON.stringify({tier_names:h})});if(!l.ok)throw new Error("Failed to preview");return l.json()}}),$=H({mutationFn:async()=>{const l=await E(`${A()}/members/email/send`,d,{method:"POST",body:JSON.stringify({tier_names:h,subject:c,message:C})});if(!l.ok){const L=await l.json();throw new Error(L.error||"Failed to send emails")}return l.json()},onSuccess:l=>{R(!0),I({sent:l.sent,failed:l.failed})}}),w=i.useCallback(l=>{f(l),l.length>0&&O.mutate()},[]),x=i.useCallback(l=>{y(l.subject),N(l.message)},[]),k=i.useCallback(()=>{f([]),y(""),N(""),R(!1),I(null),o()},[o]),p=h.length>0&&c.trim()&&C.trim(),_=O.data?.total_recipients||0;return e.jsx(m,{open:n,onClose:k,title:"Email Members by Tier",primaryAction:M?{content:"Done",onAction:k}:{content:`Send to ${_} ${_===1?"Member":"Members"}`,onAction:()=>$.mutate(),disabled:!p||_===0,loading:$.isPending},secondaryActions:M?[]:[{content:"Cancel",onAction:k}],size:"large",children:M?e.jsx(m.Section,{children:e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",variant:"headingMd",children:"Email Sent Successfully!"}),e.jsxs(t,{as:"p",children:["Sent ",S?.sent," emails",S?.failed?` (${S.failed} failed)`:"","."]})]})})}):e.jsxs(e.Fragment,{children:[e.jsx(m.Section,{children:e.jsxs(r,{gap:"400",children:[$.isError&&e.jsx(j,{tone:"critical",children:e.jsx("p",{children:$.error?.message||"Failed to send emails"})}),e.jsx(Ee,{title:"Select Tiers to Email",choices:g?g.filter(l=>l&&l.active&&l.name).map(l=>({label:l.name||"",value:String(l.name||"").toUpperCase()})):[],selected:h,onChange:w,allowMultiple:!0}),O.data&&e.jsx(j,{children:e.jsxs(t,{as:"p",children:[e.jsx("strong",{children:_})," active members will receive this email:",Object.entries(O.data.member_counts).map(([l,L])=>e.jsxs("span",{children:[" ",l,": ",L]},l))]})})]})}),e.jsx(m.Section,{children:e.jsxs(r,{gap:"400",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:"Quick Templates"}),e.jsx(b,{gap:"200",wrap:!0,children:v?.templates?.filter(l=>l&&l.id).map(l=>e.jsx(J,{size:"slim",onClick:()=>x(l),children:l.name||"Template"},l.id))})]})}),e.jsx(m.Section,{children:e.jsxs(oe,{children:[e.jsx(Q,{label:"Subject",value:c,onChange:y,autoComplete:"off",placeholder:"e.g., Exclusive Member Offer!",requiredIndicator:!0}),e.jsx(Q,{label:"Message",value:C,onChange:N,multiline:8,autoComplete:"off",placeholder:"Write your message here...",helpText:"Use {member_name}, {member_number}, and {tier_name} for personalization",requiredIndicator:!0})]})})]})})}function sn({open:n,onClose:o,shop:d}){const g=_e(),[h,f]=i.useState(""),[c,y]=i.useState(null),[C,N]=i.useState(""),[M,R]=i.useState([]),[S,I]=i.useState(!1),[v,O]=i.useState(!1),$=$e(h,150),[w,x]=i.useState(!1),[k,p]=i.useState(""),[_,l]=i.useState(""),[L,U]=i.useState(""),[ee,T]=i.useState(""),{data:he}=le({queryKey:["tiers-list",d],queryFn:async()=>{const u=await E(`${A()}/membership/tiers`,d);if(!u.ok)throw new Error("Failed to fetch tiers");return(await u.json()).tiers||[]},enabled:!!d&&n});i.useEffect(()=>{(async()=>{if(!$||$.length<2){R([]);return}I(!0);try{const K=await E(`${A()}/members/search-shopify?q=${encodeURIComponent($)}`,d);if(K.ok){const se=await K.json();R(se.customers||[])}}catch(K){console.error("Search failed:",K)}finally{I(!1)}})()},[$,d]);const ne=H({mutationFn:async()=>{if(!c)throw new Error("No customer selected");const u=await E(`${A()}/members/enroll`,d,{method:"POST",body:JSON.stringify({shopify_customer_id:c.id,tier_id:C?parseInt(C):null})});if(!u.ok){const K=await u.json();throw new Error(K.error||"Failed to enroll member")}return u.json()},onSuccess:()=>{O(!0),g.invalidateQueries({queryKey:["members"]})}}),W=H({mutationFn:async()=>{if(!k)throw new Error("Email is required");const u=await E(`${A()}/members/create-and-enroll`,d,{method:"POST",body:JSON.stringify({email:k,first_name:_||void 0,last_name:L||void 0,phone:ee||void 0,tier_id:C?parseInt(C):null})});if(!u.ok){const K=await u.json();throw new Error(K.error||"Failed to create customer")}return u.json()},onSuccess:()=>{O(!0),g.invalidateQueries({queryKey:["members"]})}}),X=i.useCallback(()=>{f(""),y(null),N(""),R([]),O(!1),x(!1),p(""),l(""),U(""),T(""),o()},[o]),Z=[{label:"No Tier (Start at base)",value:""},...he?.filter(u=>u&&u.name).map(u=>({label:u.name||"",value:String(u.id)}))||[]],ce=k&&k.includes("@")&&k.includes(".");return e.jsx(m,{open:n,onClose:X,title:w?"Create New Customer":"Add Member",primaryAction:v?{content:"Done",onAction:X}:w?{content:"Create & Enroll",onAction:()=>W.mutate(),loading:W.isPending,disabled:!ce}:c?{content:"Enroll Member",onAction:()=>ne.mutate(),loading:ne.isPending}:void 0,secondaryActions:v?[]:w?[{content:"Back to Search",onAction:()=>{x(!1),p(""),l(""),U(""),T("")}}]:c?[{content:"Back",onAction:()=>y(null)}]:[{content:"Cancel",onAction:X}],children:v?e.jsx(m.Section,{children:e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",variant:"headingMd",children:"Member Enrolled!"}),e.jsxs(t,{as:"p",children:[w?`${_||""} ${L||""} (${k})`.trim():c?.name||`${c?.firstName||""} ${c?.lastName||""}`.trim()," has been enrolled in your loyalty program."]})]})})}):w?e.jsx(m.Section,{children:e.jsxs(r,{gap:"400",children:[W.isError&&e.jsx(j,{tone:"critical",children:e.jsx("p",{children:W.error?.message||"Failed to create customer"})}),e.jsx(j,{tone:"info",children:e.jsx(t,{as:"p",children:"This will create a new customer in Shopify and automatically enroll them as a member."})}),e.jsxs(oe,{children:[e.jsx(Q,{label:"Email",type:"email",value:k,onChange:p,autoComplete:"email",placeholder:"customer@example.com",requiredIndicator:!0,error:k&&!ce?"Please enter a valid email":void 0}),e.jsxs(oe.Group,{children:[e.jsx(Q,{label:"First Name",value:_,onChange:l,autoComplete:"given-name",placeholder:"John"}),e.jsx(Q,{label:"Last Name",value:L,onChange:U,autoComplete:"family-name",placeholder:"Doe"})]}),e.jsx(Q,{label:"Phone (optional)",type:"tel",value:ee,onChange:T,autoComplete:"tel",placeholder:"+1 555-123-4567"}),e.jsx(ve,{label:"Starting Tier",options:Z,value:C,onChange:N,helpText:"Select an initial tier or leave at base level"})]})]})}):c?e.jsx(m.Section,{children:e.jsxs(r,{gap:"400",children:[ne.isError&&e.jsx(j,{tone:"critical",children:e.jsx("p",{children:ne.error?.message||"Failed to enroll member"})}),e.jsx(je,{background:"bg-surface-secondary",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:c.name||`${c.firstName||""} ${c.lastName||""}`.trim()||"Unknown"}),e.jsx(t,{as:"p",tone:"subdued",children:c.email}),e.jsxs(b,{gap:"400",wrap:!0,children:[e.jsxs(t,{as:"span",variant:"bodySm",children:[c.numberOfOrders||c.ordersCount||0," orders"]}),e.jsxs(t,{as:"span",variant:"bodySm",children:["$",Number(c.amountSpent||c.totalSpent||0).toFixed(2)," spent"]}),(c.storeCredit??0)>0&&e.jsx(G,{tone:"info",size:"small",children:`$${Number(c.storeCredit).toFixed(2)} store credit`})]})]})}),e.jsx(ve,{label:"Starting Tier",options:Z,value:C,onChange:N,helpText:"Select an initial tier or leave at base level"})]})}):e.jsx(m.Section,{children:e.jsxs(r,{gap:"400",children:[e.jsx(Q,{label:"Search Shopify Customers",value:h,onChange:f,placeholder:"Type to search by name, email, or phone...",autoComplete:"off",autoFocus:!0,clearButton:!0,onClearButtonClick:()=>f(""),prefix:e.jsx(ze,{source:He}),suffix:S?e.jsx(Se,{size:"small"}):null,helpText:h.length>0&&h.length<2?"Type at least 2 characters":void 0}),M.length>0?e.jsxs(r,{gap:"200",children:[e.jsxs(t,{as:"h3",variant:"headingSm",children:["Search Results (",M.length,")"]}),M.map(u=>e.jsx("div",{onClick:()=>!u.is_member&&y(u),role:"button",tabIndex:0,onKeyDown:K=>K.key==="Enter"&&!u.is_member&&y(u),style:{cursor:u.is_member?"not-allowed":"pointer",opacity:u.is_member?.6:1},children:e.jsx(F,{padding:"300",background:"bg-surface-secondary",borderRadius:"200",children:e.jsxs(b,{align:"space-between",blockAlign:"center",children:[e.jsxs(r,{gap:"100",children:[e.jsxs(b,{gap:"200",blockAlign:"center",children:[e.jsx(t,{as:"span",fontWeight:"semibold",children:u.name||`${u.firstName||""} ${u.lastName||""}`.trim()||"Unknown"}),u.is_member&&e.jsx(G,{tone:"success",size:"small",children:`Member ${u.member_number||""}`})]}),e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:u.email})]}),e.jsxs(r,{gap:"050",inlineAlign:"end",children:[e.jsxs(b,{gap:"200",children:[e.jsxs(t,{as:"span",variant:"bodySm",children:[u.numberOfOrders||u.ordersCount||0," orders"]}),e.jsxs(t,{as:"span",variant:"bodySm",tone:"subdued",children:["$",Number(u.amountSpent||u.totalSpent||0).toFixed(2)," spent"]})]}),(u.storeCredit??0)>0&&e.jsx(G,{tone:"info",size:"small",children:`$${Number(u.storeCredit).toFixed(2)} credit`})]})]})})},u.id)),e.jsx(Ie,{}),e.jsx(J,{variant:"plain",onClick:()=>x(!0),children:"Or create a new customer"})]}):$.length>=2&&!S?e.jsxs(r,{gap:"300",children:[e.jsx(j,{tone:"info",children:e.jsxs(t,{as:"p",children:['No customers found matching "',$,'"']})}),e.jsx(J,{variant:"primary",onClick:()=>{x(!0),h.includes("@")&&p(h)},fullWidth:!0,children:"Create New Customer"})]}):e.jsxs(r,{gap:"300",children:[e.jsx(t,{as:"p",tone:"subdued",alignment:"center",children:S?e.jsxs(b,{gap:"200",align:"center",children:[e.jsx(Se,{size:"small"}),e.jsx("span",{children:"Searching..."})]}):"Start typing to search for Shopify customers, or create a new customer."}),e.jsx(J,{variant:"plain",onClick:()=>x(!0),children:"Create new customer instead"})]})]})})})}function tn({open:n,onClose:o,shop:d}){const g=_e(),[h,f]=i.useState(null),[c,y]=i.useState(null),[C,N]=i.useState(!1),[M,R]=i.useState(!1),[S,I]=i.useState(""),[v,O]=i.useState(null),$=i.useCallback((p,_)=>{_.length>0&&(f(_[0]),y(null),I(""),O(null))},[]),w=i.useCallback(async()=>{if(!(!h||!d)){R(!0),I("");try{const p=new FormData;p.append("file",h);const _=await fetch(`${A()}/members/import/preview`,{method:"POST",headers:{"X-Shop-Domain":d},body:p});if(!_.ok){const L=await _.json();throw new Error(L.error||"Failed to preview CSV")}const l=await _.json();y(l)}catch(p){I(p instanceof Error?p.message:"Failed to preview CSV")}finally{R(!1)}}},[h,d]),x=i.useCallback(async()=>{if(!(!h||!d)){N(!0),I("");try{const p=new FormData;p.append("file",h),p.append("skip_duplicates","true");const _=await fetch(`${A()}/members/import/import`,{method:"POST",headers:{"X-Shop-Domain":d},body:p});if(!_.ok){const L=await _.json();throw new Error(L.error||"Failed to import members")}const l=await _.json();O({imported:l.imported,skipped:l.skipped}),g.invalidateQueries({queryKey:["members"]})}catch(p){I(p instanceof Error?p.message:"Failed to import members")}finally{N(!1)}}},[h,d,g]),k=i.useCallback(()=>{f(null),y(null),I(""),O(null),o()},[o]);return e.jsx(m,{open:n,onClose:k,title:"Import Members from CSV",primaryAction:v?{content:"Done",onAction:k}:c?{content:`Import ${c.valid_count} Members`,onAction:x,loading:C,disabled:c.valid_count===0}:h?{content:"Preview Import",onAction:w,loading:M}:void 0,secondaryActions:v?[]:c?[{content:"Back",onAction:()=>{y(null),f(null)}}]:[{content:"Cancel",onAction:k}],size:"large",children:v?e.jsx(m.Section,{children:e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",variant:"headingMd",children:"Import Complete!"}),e.jsxs(t,{as:"p",children:["Successfully imported ",v.imported," members",v.skipped>0&&` (${v.skipped} duplicates skipped)`,"."]})]})})}):c?e.jsx(e.Fragment,{children:e.jsxs(m.Section,{children:[S&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",onDismiss:()=>I(""),children:e.jsx("p",{children:S})})}),e.jsxs(r,{gap:"400",children:[e.jsxs(b,{gap:"400",children:[e.jsx(je,{children:e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"headingLg",tone:"success",children:c.valid_count}),e.jsx(t,{as:"span",variant:"bodySm",children:"Ready to import"})]})}),e.jsx(je,{children:e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"headingLg",tone:"critical",children:c.invalid_count}),e.jsx(t,{as:"span",variant:"bodySm",children:"Invalid rows"})]})}),e.jsx(je,{children:e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"headingLg",tone:"caution",children:c.duplicate_count}),e.jsx(t,{as:"span",variant:"bodySm",children:"Duplicates (skipped)"})]})})]}),c.valid_rows.length>0&&e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:"Preview (first 10 rows)"}),e.jsx(Oe,{columnContentTypes:["numeric","text","text","text","text"],headings:["Row","Email","First Name","Last Name","Tier"],rows:c.valid_rows.map(p=>[p.row,p.email,p.first_name,p.last_name,p.tier_name||"-"])})]}),c.invalid_rows.length>0&&e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"h3",variant:"headingSm",tone:"critical",children:"Invalid Rows"}),c.invalid_rows.map(p=>e.jsx(F,{padding:"200",background:"bg-surface-critical",borderRadius:"100",children:e.jsxs(b,{align:"space-between",children:[e.jsxs(t,{as:"span",variant:"bodySm",children:["Row ",p.row,": ",p.email||"(no email)"]}),e.jsx(t,{as:"span",variant:"bodySm",tone:"critical",children:p.errors.join(", ")})]})},p.row))]})]})]})}):e.jsx(m.Section,{children:e.jsxs(r,{gap:"400",children:[S&&e.jsx(j,{tone:"critical",onDismiss:()=>I(""),children:e.jsx("p",{children:S})}),e.jsx(Me,{accept:".csv",type:"file",onDrop:$,variableHeight:!0,children:h?e.jsx(F,{padding:"400",children:e.jsxs(b,{gap:"300",blockAlign:"center",children:[e.jsx(We,{source:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",alt:"CSV file",size:"small"}),e.jsxs(r,{gap:"050",children:[e.jsx(t,{as:"span",variant:"bodyMd",fontWeight:"semibold",children:h.name}),e.jsxs(t,{as:"span",variant:"bodySm",tone:"subdued",children:[(h.size/1024).toFixed(1)," KB"]})]})]})}):e.jsx(Me.FileUpload,{actionHint:"or drop a CSV file to upload"})}),e.jsx(je,{background:"bg-surface-secondary",children:e.jsxs(r,{gap:"300",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:"CSV Format Requirements"}),e.jsxs(ye,{type:"bullet",children:[e.jsx(ye.Item,{children:"First row must be column headers"}),e.jsx(ye.Item,{children:"Required columns: email, first_name"}),e.jsx(ye.Item,{children:"Optional: last_name, phone, tier_name"}),e.jsx(ye.Item,{children:"Tier names must match existing tiers exactly"})]}),e.jsx(t,{as:"p",variant:"bodySm",tone:"subdued",children:"Example: email,first_name,last_name,tier_name"})]})})]})})})}function an({open:n,onClose:o,shop:d,selectedMemberIds:g,tiers:h,onSuccess:f}){const[c,y]=i.useState(""),[C,N]=i.useState(""),[M,R]=i.useState(!1),[S,I]=i.useState(null),v=H({mutationFn:async()=>{const x=await E(`${A()}/tiers/bulk-assign`,d,{method:"POST",body:JSON.stringify({member_ids:g,tier_id:c?parseInt(c):null,reason:C||"Bulk assignment"})});if(!x.ok){const k=await x.json();throw new Error(k.error||"Failed to assign tier")}return x.json()},onSuccess:x=>{R(!0),I({successful:x.successful||g.length,failed:x.failed||0}),f()}}),O=i.useCallback(()=>{y(""),N(""),R(!1),I(null),v.reset(),o()},[o,v]),$=[{label:"Remove Tier (No Tier)",value:""},...h?.filter(x=>x&&x.name).map(x=>({label:x.name||"",value:String(x.id)}))||[]],w=c?h?.find(x=>String(x.id)===c)?.name||"Unknown":"No Tier";return e.jsx(m,{open:n,onClose:O,title:"Bulk Assign Tier",primaryAction:M?{content:"Done",onAction:O}:{content:`Assign to ${g.length} member${g.length!==1?"s":""}`,onAction:()=>v.mutate(),loading:v.isPending},secondaryActions:M?[]:[{content:"Cancel",onAction:O}],children:M?e.jsx(m.Section,{children:e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",variant:"headingMd",children:"Tier Assigned Successfully!"}),e.jsxs(t,{as:"p",children:[S?.successful," member",S?.successful!==1?"s were":" was"," assigned to ",w,S?.failed?` (${S.failed} failed)`:"","."]})]})})}):e.jsx(m.Section,{children:e.jsxs(r,{gap:"400",children:[v.isError&&e.jsx(j,{tone:"critical",children:e.jsx("p",{children:v.error?.message||"Failed to assign tier"})}),e.jsx(j,{children:e.jsxs(t,{as:"p",children:["You are about to assign a tier to ",e.jsx("strong",{children:g.length})," selected member",g.length!==1?"s":"","."]})}),e.jsxs(oe,{children:[e.jsx(ve,{label:"Select Tier",options:$,value:c,onChange:y,helpText:"Choose the tier to assign to all selected members"}),e.jsx(Q,{label:"Reason (optional)",value:C,onChange:N,placeholder:"e.g., Bulk upgrade campaign, Loyalty reward",autoComplete:"off",helpText:"This will be recorded in each member's tier history"})]})]})})})}export{pn as EmbeddedMembers};
