import{u as R,j as e}from"./vendor-query-Bq4hz6H9.js";import{r}from"./vendor-router-CdtyvhQv.js";import{g as T,a as O}from"./index-CtYfgeRr.js";import{T as i,P as N,B as $,J as Z,L as S,u as ee,C as p,a as b,h as x,b as u,g as te,I as ne,O as ae,f as re,ao as se,ar as ie,c as g,a5 as oe,l as ce,D as de,ah as M,ag as q,N as le,E as he,t as pe}from"./vendor-polaris-CV39Dq-f.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";import"./vendor-appbridge-DL6abzKC.js";const W={trade_in:"Trade-In",purchase:"Purchase Cashback",promotion:"Promotion Bonus",adjustment:"Manual Adjustment",bulk:"Bulk Credit",referral:"Referral Bonus",redemption:"Redemption",expiration:"Expired",birthday:"Birthday Reward",anniversary:"Anniversary Reward"},ue={trade_in:"success",purchase:"success",promotion:"info",adjustment:"warning",bulk:"info",referral:"success",redemption:"critical",expiration:"critical",birthday:"success",anniversary:"success"};async function ge(o,l){const c=new URLSearchParams;Object.entries(l).forEach(([h,m])=>{m!==void 0&&m!==""&&c.append(h,String(m))});const j=await O(`${T()}/promotions/credit/ledger?${c.toString()}`,o);if(!j.ok)throw new Error("Failed to fetch ledger");return j.json()}async function me(o){const l=await O(`${T()}/promotions/credit/ledger/event-types`,o);if(!l.ok)throw new Error("Failed to fetch event types");return l.json()}function Ce({shop:o}){const[l,c]=r.useState(1),[j]=r.useState(25),[h,m]=r.useState(""),[d,D]=r.useState([]),[n,E]=r.useState({}),[L,_]=r.useState(!1),[f,U]=r.useState("created_at"),[v,P]=r.useState("desc"),B=r.useMemo(()=>{const t={page:l,per_page:j,sort_by:f,sort_dir:v};return h&&(t.search=h),d.length===1&&(t.event_type=d[0]),n.start&&(t.start_date=n.start.toISOString()),n.end&&(t.end_date=n.end.toISOString()),t},[l,j,h,d,n,f,v]),{data:a,isLoading:z,error:H}=R({queryKey:["credit-ledger",o,B],queryFn:()=>ge(o,B),enabled:!!o}),{data:w}=R({queryKey:["credit-event-types",o],queryFn:()=>me(o),enabled:!!o,staleTime:6e4}),A=r.useCallback(t=>{m(t),c(1)},[]),V=r.useCallback(t=>{D(t),c(1)},[]),C=r.useCallback(t=>{E(t),c(1),_(!1)},[]),Y=r.useCallback(()=>{m(""),D([]),E({}),c(1)},[]),K=r.useCallback(()=>{const t=new URLSearchParams;n.start&&t.append("start_date",n.start.toISOString()),n.end&&t.append("end_date",n.end.toISOString()),d.length===1&&t.append("event_type",d[0]),window.open(`${T()}/promotions/credit/ledger/export?${t.toString()}`,"_blank")},[n,d]),I=r.useCallback(t=>{U(s=>s===t?(P(k=>k==="asc"?"desc":"asc"),t):(P("desc"),t))},[]),y=t=>{const s=new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(Math.abs(t));return t<0?`-${s}`:s},G=t=>t?new Date(t).toLocaleString("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit"}):"-",J=t=>{const s=W[t]||t,k=ue[t];return e.jsx(pe,{tone:k,children:s})},Q=r.useMemo(()=>a?.entries?a.entries.map(t=>[G(t.created_at),t.member_email||t.member_name||`Member #${t.member_id}`,J(t.event_type),e.jsxs(i,{as:"span",tone:t.amount>=0?"success":"critical",fontWeight:"semibold",children:[t.amount>=0?"+":"",y(t.amount)]}),y(t.balance_after),t.description||"-",t.source_reference||"-"]):[],[a?.entries]),X=r.useMemo(()=>w?.event_types?w.event_types.map(t=>({label:`${W[t.type]||t.type} (${t.count})`,value:t.type})):[],[w]),F=h||d.length>0||n.start||n.end;return o?e.jsx(N,{title:"Store Credit Ledger",subtitle:"Complete history of all store credit transactions",primaryAction:{content:"Export CSV",icon:Z,onAction:K},children:e.jsxs(S,{children:[H&&e.jsx(S.Section,{children:e.jsx($,{tone:"critical",children:e.jsx("p",{children:"Failed to load credit ledger. Please try refreshing the page."})})}),a?.summary&&e.jsx(S.Section,{children:e.jsxs(ee,{columns:{xs:2,sm:4,lg:5},gap:"400",children:[e.jsx(p,{padding:"400",children:e.jsxs(b,{gap:"100",children:[e.jsx(i,{as:"p",variant:"bodySm",tone:"subdued",children:"Total Credited"}),e.jsx(i,{as:"p",variant:"headingLg",tone:"success",fontWeight:"bold",children:y(a.summary.total_credited)})]})}),e.jsx(p,{padding:"400",children:e.jsxs(b,{gap:"100",children:[e.jsx(i,{as:"p",variant:"bodySm",tone:"subdued",children:"Total Debited"}),e.jsx(i,{as:"p",variant:"headingLg",tone:"critical",fontWeight:"bold",children:y(a.summary.total_debited)})]})}),e.jsx(p,{padding:"400",children:e.jsxs(b,{gap:"100",children:[e.jsx(i,{as:"p",variant:"bodySm",tone:"subdued",children:"Net Change"}),e.jsx(i,{as:"p",variant:"headingLg",tone:a.summary.net_change>=0?"success":"critical",fontWeight:"bold",children:y(a.summary.net_change)})]})}),e.jsx(p,{padding:"400",children:e.jsxs(b,{gap:"100",children:[e.jsx(i,{as:"p",variant:"bodySm",tone:"subdued",children:"Transactions"}),e.jsx(i,{as:"p",variant:"headingLg",fontWeight:"bold",children:a.summary.total_transactions.toLocaleString()})]})}),e.jsx(p,{padding:"400",children:e.jsxs(b,{gap:"100",children:[e.jsx(i,{as:"p",variant:"bodySm",tone:"subdued",children:"Unique Members"}),e.jsx(i,{as:"p",variant:"headingLg",fontWeight:"bold",children:a.summary.unique_members.toLocaleString()})]})})]})}),e.jsx(S.Section,{children:e.jsx(p,{padding:"400",children:e.jsxs(x,{gap:"300",blockAlign:"center",wrap:!0,children:[e.jsx(u,{minWidth:"250px",children:e.jsx(te,{label:"Search",labelHidden:!0,placeholder:"Search by email, description...",value:h,onChange:A,autoComplete:"off",prefix:e.jsx(ne,{source:ae}),clearButton:!0,onClearButtonClick:()=>A("")})}),e.jsx(u,{minWidth:"200px",children:e.jsx(re,{label:"Event Type",labelHidden:!0,placeholder:"All event types",options:[{label:"All event types",value:""},...X],value:d[0]||"",onChange:t=>V(t?[t]:[])})}),e.jsx(se,{active:L,activator:e.jsx(g,{icon:oe,onClick:()=>_(!L),children:n.start?`${n.start.toLocaleDateString()} - ${n.end?.toLocaleDateString()||"Now"}`:"Select dates"}),onClose:()=>_(!1),children:e.jsxs(u,{padding:"400",children:[e.jsx(ie,{month:new Date().getMonth(),year:new Date().getFullYear(),onChange:C,selected:n.start?{start:n.start,end:n.end||n.start}:void 0,allowRange:!0}),e.jsx(u,{paddingBlockStart:"300",children:e.jsxs(x,{gap:"200",children:[e.jsx(g,{size:"slim",onClick:()=>{const t=new Date,s=new Date(t.getTime()-10080*60*1e3);C({start:s,end:t})},children:"Last 7 days"}),e.jsx(g,{size:"slim",onClick:()=>{const t=new Date,s=new Date(t.getTime()-720*60*60*1e3);C({start:s,end:t})},children:"Last 30 days"}),e.jsx(g,{size:"slim",onClick:()=>{const t=new Date;t.setHours(0,0,0,0);const s=new Date(t.getTime()+1440*60*1e3);C({start:t,end:s})},children:"Today"})]})})]})}),F&&e.jsx(g,{onClick:Y,variant:"plain",children:"Clear all"})]})})}),e.jsx(S.Section,{children:e.jsx(p,{padding:"0",children:z?e.jsx(u,{padding:"1600",children:e.jsx(x,{align:"center",children:e.jsx(ce,{size:"large"})})}):a&&a.entries.length>0?e.jsxs(e.Fragment,{children:[e.jsx(de,{columnContentTypes:["text","text","text","numeric","numeric","text","text"],headings:[e.jsxs(x,{gap:"100",blockAlign:"center",children:["Date",e.jsx(g,{variant:"plain",icon:f==="created_at"?v==="desc"?M:q:void 0,onClick:()=>I("created_at")})]}),"Member","Type",e.jsxs(x,{gap:"100",blockAlign:"center",children:["Amount",e.jsx(g,{variant:"plain",icon:f==="amount"?v==="desc"?M:q:void 0,onClick:()=>I("amount")})]}),"Balance After","Description","Reference"],rows:Q,hoverable:!0}),e.jsx(u,{padding:"400",borderBlockStartWidth:"025",borderColor:"border",children:e.jsxs(x,{align:"center",children:[e.jsx(le,{hasPrevious:a.pagination.has_prev,hasNext:a.pagination.has_next,onPrevious:()=>c(t=>Math.max(1,t-1)),onNext:()=>c(t=>t+1)}),e.jsxs(i,{as:"span",tone:"subdued",variant:"bodySm",children:["Page ",a.pagination.page," of ",a.pagination.total_pages," (",a.pagination.total_items.toLocaleString()," total)"]})]})})]}):e.jsx(u,{padding:"1600",children:e.jsx(he,{heading:"No credit transactions found",image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:F?"Try adjusting your filters to see more results.":"Store credit transactions will appear here as members earn and redeem credits."})})})})})]})}):e.jsx(N,{title:"Credit Ledger",children:e.jsx($,{tone:"warning",children:e.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})})}export{Ce as EmbeddedCreditLedger,Ce as default};
