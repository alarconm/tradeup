import{b as U,u as v,c as k,j as e}from"./vendor-query-Bq4hz6H9.js";import{r as d}from"./vendor-router-CdtyvhQv.js";import{a as S,g as x}from"./index-r9c0LRG1.js";import{P as m,B as P,b as D,h as r,l as K,L as o,C,a as c,T as t,t as M,c as A,u as L,o as B,I as y,X as f,M as F}from"./vendor-polaris-1WqYVNpP.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";import"./vendor-appbridge-DL6abzKC.js";function Q(n=768){const[a,l]=d.useState(typeof window<"u"?window.innerWidth<n:!1);return d.useEffect(()=>{const u=()=>l(window.innerWidth<n);return window.addEventListener("resize",u),()=>window.removeEventListener("resize",u)},[n]),a}async function W(){const n=await fetch(`${x()}/billing/plans`);if(!n.ok)throw new Error("Failed to fetch plans");return n.json()}async function N(n){const a=await S(`${x()}/billing/status`,n);if(!a.ok)throw new Error("Failed to fetch billing status");return a.json()}async function Y(n,a){const l=await S(`${x()}/billing/subscribe`,n,{method:"POST",body:JSON.stringify({plan:a})});if(!l.ok)throw new Error("Failed to subscribe");return l.json()}async function G(n){if(!(await S(`${x()}/billing/cancel`,n,{method:"POST"})).ok)throw new Error("Failed to cancel")}function se({shop:n}){const a=Q(),l=U(),[u,E]=d.useState(null),[T,h]=d.useState(!1),{data:I,isLoading:_}=v({queryKey:["plans"],queryFn:W}),{data:i,isLoading:q,error:z}=v({queryKey:["billing-status",n],queryFn:()=>N(n),enabled:!!n}),b=k({mutationFn:s=>Y(n,s),onSuccess:s=>{window.top?.location.assign(s.confirmation_url)}}),w=k({mutationFn:()=>G(n),onSuccess:()=>{l.invalidateQueries({queryKey:["billing-status"]}),h(!1)}}),O=d.useCallback(s=>{E(s),b.mutate(s)},[b]);if(!n)return e.jsx(m,{title:"Plan & Billing",children:e.jsx(P,{tone:"warning",children:e.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})});if(_||q)return e.jsx(m,{title:"Plan & Billing",children:e.jsx(D,{padding:"1600",children:e.jsx(r,{align:"center",children:e.jsx(K,{size:"large"})})})});const g=s=>s===null?"Unlimited":s.toLocaleString(),p=s=>i?.plan===s&&i?.active;return e.jsxs(m,{title:"Plan & Billing",subtitle:"Manage your TradeUp subscription",children:[e.jsxs(o,{children:[z&&e.jsx(o.Section,{children:e.jsx(P,{tone:"critical",children:e.jsx("p",{children:"Failed to load billing information. Please try refreshing."})})}),i&&e.jsx(o.Section,{children:e.jsx(C,{children:e.jsxs(c,{gap:"400",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsxs(c,{gap:"100",children:[e.jsxs(r,{gap:"200",blockAlign:"center",children:[e.jsx(t,{as:"h2",variant:"headingLg",children:i.plan?String(i.plan).charAt(0).toUpperCase()+String(i.plan).slice(1):"Free"}),e.jsx(M,{tone:i.active?"success":"warning",children:String(i.status||"inactive")})]}),i.trial_ends_at&&e.jsxs(t,{as:"p",variant:"bodySm",tone:"subdued",children:["Trial ends: ",new Date(i.trial_ends_at).toLocaleDateString()]})]}),i.active&&e.jsx(A,{variant:"plain",tone:"critical",onClick:()=>h(!0),children:"Cancel subscription"})]}),e.jsxs(L,{columns:a?1:2,gap:"400",children:[e.jsxs(c,{gap:"200",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Members"}),e.jsxs(t,{as:"span",variant:"headingMd",children:[i.usage.members.current," / ",g(i.usage.members.limit)]}),e.jsx(B,{progress:i.usage.members.percentage,size:"small",tone:i.usage.members.percentage>90?"critical":i.usage.members.percentage>75?"highlight":"success"})]}),e.jsxs(c,{gap:"200",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Tiers"}),e.jsxs(t,{as:"span",variant:"headingMd",children:[i.usage.tiers.current," / ",g(i.usage.tiers.limit)]}),e.jsx(B,{progress:i.usage.tiers.percentage,size:"small"})]})]})]})})}),e.jsx(o.Section,{children:e.jsx(t,{as:"h2",variant:"headingLg",children:"Available Plans"})}),e.jsx(o.Section,{children:e.jsx(L,{columns:a?1:{xs:1,sm:2,md:2,lg:4},gap:"400",children:I?.plans.filter(s=>s&&s.key).map(s=>e.jsx(C,{children:e.jsxs(c,{gap:"400",children:[e.jsxs(c,{gap:"200",children:[e.jsxs(r,{align:"space-between",blockAlign:"center",children:[e.jsx(t,{as:"h3",variant:"headingMd",children:s.name}),p(s.key)&&e.jsx(M,{tone:"success",children:"Current"})]}),e.jsxs(r,{gap:"100",blockAlign:"baseline",children:[e.jsxs(t,{as:"span",variant:"heading2xl",children:["$",s.price]}),e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"/month"})]})]}),e.jsxs(c,{gap:"200",children:[e.jsxs(r,{gap:"200",children:[e.jsx(y,{source:f,tone:"success"}),e.jsxs(t,{as:"span",variant:"bodySm",children:[g(s.max_members)," members"]})]}),e.jsxs(r,{gap:"200",children:[e.jsx(y,{source:f,tone:"success"}),e.jsxs(t,{as:"span",variant:"bodySm",children:[g(s.max_tiers)," tiers"]})]}),(s.features||[]).filter(j=>j).map((j,$)=>e.jsxs(r,{gap:"200",children:[e.jsx(y,{source:f,tone:"success"}),e.jsx(t,{as:"span",variant:"bodySm",children:j})]},$))]}),e.jsx(A,{variant:p(s.key)?"secondary":"primary",disabled:p(s.key),loading:b.isPending&&u===s.key,onClick:()=>O(s.key),fullWidth:!0,children:p(s.key)?"Current Plan":"Select Plan"})]})},s.key))})})]}),e.jsx(F,{open:T,onClose:()=>h(!1),title:"Cancel Subscription",primaryAction:{content:"Cancel Subscription",destructive:!0,onAction:()=>w.mutate(),loading:w.isPending},secondaryActions:[{content:"Keep Subscription",onAction:()=>h(!1)}],children:e.jsx(F.Section,{children:e.jsxs(c,{gap:"400",children:[e.jsx(t,{as:"p",children:"Are you sure you want to cancel your subscription?"}),e.jsx(t,{as:"p",tone:"subdued",children:"You'll lose access to premium features at the end of your current billing period. Your data will be preserved if you decide to resubscribe."})]})})})]})}export{se as EmbeddedBilling};
