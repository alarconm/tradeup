import{b as Me,u as ne,c as se,j as e}from"./vendor-query-Bq4hz6H9.js";import{u as $e,r as n}from"./vendor-router-CdtyvhQv.js";import{a as j,g as b}from"./index-D10Yqe92.js";import{u as Le}from"./useShopifyData-D2lWwkSF.js";import{P as Se,B as we,v as Oe,L as re,u as oe,C as P,a as u,T as s,b as C,g as m,h,E as ve,z as ie,t as K,c as S,W as qe,D as Be,N as Re,M as Q,e as Ke,I as Te,X as Qe,l as We,O as ze,f as Ue}from"./vendor-polaris-1WqYVNpP.js";import{T as Ve}from"./vendor-appbridge-DL6abzKC.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";function Xe(a,r){const[i,d]=n.useState(a);return n.useEffect(()=>{const p=setTimeout(()=>d(a),r);return()=>clearTimeout(p)},[a,r]),i}function Ge(a=768){const[r,i]=n.useState(typeof window<"u"?window.innerWidth<a:!1);return n.useEffect(()=>{const d=()=>i(window.innerWidth<a);return window.addEventListener("resize",d),()=>window.removeEventListener("resize",d)},[a]),r}async function Je(a,r,i=""){const d=new URLSearchParams({page:String(r),per_page:"20"});i&&d.append("search",i);const p=await j(`${b()}/trade-ledger/?${d.toString()}`,a);if(!p.ok)throw new Error("Failed to fetch entries");return p.json()}async function He(a){const r=await j(`${b()}/trade-ledger/summary`,a);if(!r.ok)throw new Error("Failed to fetch summary");return r.json()}async function Ye(a){const r=await j(`${b()}/trade-ledger/categories`,a);if(!r.ok)throw new Error("Failed to fetch categories");return r.json()}async function Ze(a,r){const i=await j(`${b()}/trade-ledger/`,a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)});if(!i.ok){const d=await i.json();throw new Error(d.error||"Failed to create entry")}return i.json()}async function et(a,r){if(!(await j(`${b()}/trade-ledger/${r}`,a,{method:"DELETE"})).ok)throw new Error("Failed to delete entry")}function ct({shop:a}){const r=Ge();$e();const i=Me(),[d,p]=n.useState(1),[W,le]=n.useState(""),[A,_e]=n.useState(""),[ke,D]=n.useState(!1),[Ne,M]=n.useState(!1),[z,$]=n.useState(null);n.useEffect(()=>{const t=setTimeout(()=>{_e(W),p(1)},300);return()=>clearTimeout(t)},[W]);const[w,v]=n.useState(""),[o,T]=n.useState(null),[ce,N]=n.useState([]),[U,de]=n.useState(!1),_=Xe(w,150),[Ee,k]=n.useState(!1),[x,E]=n.useState(""),[V,L]=n.useState(""),[X,O]=n.useState(""),[G,q]=n.useState(""),[y,ue]=n.useState(""),[F,me]=n.useState(""),[J,H]=n.useState(""),[f,he]=n.useState(""),[B,ge]=n.useState(""),[Y,pe]=n.useState(""),{data:xe,isLoading:Fe}=ne({queryKey:["trade-ledger",a,d,A],queryFn:()=>Je(a,d,A),enabled:!!a}),{data:R}=ne({queryKey:["trade-ledger-summary",a],queryFn:()=>He(a),enabled:!!a}),{data:Ie}=ne({queryKey:["trade-ledger-categories",a],queryFn:()=>Ye(a),enabled:!!a}),{data:Z}=Le(a),ee=se({mutationFn:t=>Ze(a,t),onSuccess:()=>{i.invalidateQueries({queryKey:["trade-ledger"]}),i.invalidateQueries({queryKey:["trade-ledger-summary"]}),te()}}),fe=se({mutationFn:t=>et(a,t),onSuccess:()=>{i.invalidateQueries({queryKey:["trade-ledger"]}),i.invalidateQueries({queryKey:["trade-ledger-summary"]}),M(!1),$(null)}});n.useEffect(()=>{(async()=>{if(!_||_.length<2||o){o||N([]);return}de(!0);try{const l=await j(`${b()}/members/search-shopify?q=${encodeURIComponent(_)}`,a);if(l.ok){const c=await l.json();N(c.customers||[])}}catch(l){console.error("Search failed:",l)}finally{de(!1)}})()},[_,a,o]),n.useEffect(()=>{const t=parseFloat(y)||0,l=parseFloat(F)||0,c=t-l;c>=0&&H(c.toFixed(2))},[y,F]);const te=n.useCallback(()=>{D(!1),T(null),v(""),N([]),k(!1),E(""),L(""),O(""),q(""),ue(""),me(""),H(""),he(""),ge(""),pe("")},[]),je=se({mutationFn:async()=>{if(!x)throw new Error("Email is required");const t=await j(`${b()}/members/create-and-enroll`,a,{method:"POST",body:JSON.stringify({email:x,first_name:V||void 0,last_name:X||void 0,phone:G||void 0})});if(!t.ok){const l=await t.json();throw new Error(l.error||"Failed to create customer")}return t.json()},onSuccess:t=>{T({id:t.shopify_customer_id||t.id,email:x,firstName:V,lastName:X,phone:G||null,is_member:!0,member_id:t.id,member_number:t.member_number}),k(!1),E(""),L(""),O(""),q(""),i.invalidateQueries({queryKey:["members"]})}}),Pe=n.useCallback(async()=>{if(!o)return;const t={total_value:parseFloat(y)||0,cash_amount:parseFloat(F)||0,credit_amount:parseFloat(J)||0,notes:Y||null};let l=o.member_id;if(!l&&!o.is_member)try{const c=await j(`${b()}/members/enroll`,a,{method:"POST",body:JSON.stringify({shopify_customer_id:o.id})});if(!c.ok){const De=await c.json();throw new Error(De.error||"Failed to enroll customer")}const I=await c.json();l=I.id||I.member_id,T({...o,is_member:!0,member_id:l,member_number:I.member_number})}catch(c){console.error("Failed to enroll customer:",c);return}if(t.member_id=l,f==="custom"&&B)t.category=B;else if(f&&f!=="none"){const c=Z?.collections?.find(I=>I.id===f);c?(t.collection_id=c.id,t.collection_name=c.title,t.category=c.title):t.category=f}ee.mutate(t)},[o,y,F,J,f,B,Y,Z,ee,a]),be=x&&x.includes("@")&&x.includes("."),g=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t),ye=t=>new Date(t).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"}),Ae=[{label:"None",value:"none"},...(Ie?.categories||[]).map(t=>({label:t,value:t})),...(Z?.collections||[]).map(t=>({label:`ðŸ“ ${t.title}`,value:t.id})),{label:"+ Custom Category",value:"custom"}];if(!a)return e.jsx(Se,{title:"Trade-In Ledger",children:e.jsx(we,{tone:"warning",children:e.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})});const ae=xe?.entries||[],Ce=xe?.pages||1;return e.jsxs(e.Fragment,{children:[e.jsx(Ve,{title:"Trade-In Ledger",children:e.jsx("button",{variant:"primary",onClick:()=>D(!0),children:"New Trade-In"})}),e.jsx(Se,{title:"Trade-In Ledger",subtitle:"Simple record of all trade-in transactions",primaryAction:{content:"New Trade-In",icon:Oe,onAction:()=>D(!0)},children:e.jsxs(re,{children:[e.jsx(re.Section,{children:e.jsxs(oe,{columns:r?2:4,gap:"400",children:[e.jsx(P,{children:e.jsxs(u,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",tone:"subdued",children:"Total Trade-Ins"}),e.jsx(s,{as:"p",variant:"headingXl",children:R?.total_entries||0})]})}),e.jsx(P,{children:e.jsxs(u,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",tone:"subdued",children:"Total Value"}),e.jsx(s,{as:"p",variant:"headingXl",children:g(R?.total_value||0)})]})}),e.jsx(P,{children:e.jsxs(u,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",tone:"subdued",children:"Paid Cash"}),e.jsx(s,{as:"p",variant:"headingXl",children:g(R?.total_cash||0)})]})}),e.jsx(P,{children:e.jsxs(u,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",tone:"subdued",children:"Paid Credit"}),e.jsx(s,{as:"p",variant:"headingXl",children:g(R?.total_credit||0)})]})})]})}),e.jsx(re.Section,{children:e.jsxs(P,{children:[e.jsx(C,{paddingBlockEnd:"400",children:e.jsx(m,{label:"",labelHidden:!0,value:W,onChange:le,placeholder:"Search by reference, customer name, or email...",autoComplete:"off",clearButton:!0,onClearButtonClick:()=>le("")})}),Fe?e.jsx(C,{padding:"800",children:e.jsx(h,{align:"center",children:e.jsx(s,{as:"p",children:"Loading..."})})}):ae.length===0?A?e.jsx(ve,{heading:"No trade-ins found",image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsxs("p",{children:['No trade-ins match your search for "',A,'". Try a different search term.']})}):e.jsx(ve,{heading:"No trade-ins recorded yet",action:{content:"Record First Trade-In",onAction:()=>D(!0)},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Start recording trade-in transactions to track your store's activity."})}):r?e.jsx(u,{gap:"300",children:ae.map((t,l)=>e.jsxs(C,{padding:"300",children:[l>0&&e.jsx(ie,{}),e.jsxs(u,{gap:"200",children:[e.jsxs(h,{align:"space-between",children:[e.jsx(s,{as:"span",fontWeight:"semibold",children:t.reference}),e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:ye(t.trade_date)})]}),e.jsx(s,{as:"p",children:t.customer_name||"Guest"}),e.jsxs(h,{gap:"200",children:[e.jsx(K,{tone:"success",children:g(t.total_value)}),t.category&&e.jsx(K,{children:String(t.category)})]}),e.jsxs(h,{gap:"200",children:[e.jsxs(s,{as:"span",variant:"bodySm",children:["Cash: ",g(t.cash_amount)]}),e.jsxs(s,{as:"span",variant:"bodySm",children:["Credit: ",g(t.credit_amount)]})]}),e.jsx(S,{size:"slim",icon:qe,tone:"critical",onClick:()=>{$(t),M(!0)},children:"Delete"})]})]},t.id))}):e.jsx(Be,{columnContentTypes:["text","text","text","numeric","numeric","numeric","text"],headings:["Reference","Date","Customer","Total","Cash","Credit","Category"],rows:ae.map(t=>[t.reference,ye(t.trade_date),t.customer_name||"Guest",g(t.total_value),g(t.cash_amount),g(t.credit_amount),t.category||"-"])}),Ce>1&&e.jsx(C,{padding:"400",children:e.jsx(h,{align:"center",children:e.jsx(Re,{hasPrevious:d>1,hasNext:d<Ce,onPrevious:()=>p(t=>t-1),onNext:()=>p(t=>t+1)})})})]})})]})}),e.jsx(Q,{open:ke,onClose:te,title:"Record Trade-In",primaryAction:{content:"Save Trade-In",onAction:Pe,loading:ee.isPending,disabled:!o||!y||parseFloat(y)<=0},secondaryActions:[{content:"Cancel",onAction:te}],children:e.jsx(Q.Section,{children:e.jsxs(Ke,{children:[e.jsxs(u,{gap:"300",children:[e.jsx(s,{as:"h3",variant:"headingSm",children:"Customer"}),o?e.jsx(C,{padding:"300",background:"bg-surface-success",borderRadius:"200",borderColor:"border-success",borderWidth:"025",children:e.jsxs(h,{align:"space-between",blockAlign:"center",children:[e.jsxs(h,{gap:"200",blockAlign:"center",children:[e.jsx(C,{padding:"100",background:"bg-fill-success",borderRadius:"full",children:e.jsx(Te,{source:Qe,tone:"success"})}),e.jsxs(u,{gap:"050",children:[e.jsxs(h,{gap:"200",blockAlign:"center",children:[e.jsx(s,{as:"span",variant:"bodyMd",fontWeight:"semibold",children:o.name||`${o.firstName||""} ${o.lastName||""}`.trim()||o.email}),o.is_member&&e.jsx(K,{tone:"success",size:"small",children:"Member"})]}),e.jsxs(s,{as:"span",variant:"bodySm",tone:"subdued",children:[o.email,o.member_number&&` Â· ${o.member_number}`]})]})]}),e.jsx(S,{variant:"plain",onClick:()=>{T(null),v("")},children:"Change"})]})}):Ee?e.jsxs(u,{gap:"300",children:[e.jsx(we,{tone:"info",children:e.jsx(s,{as:"p",children:"Create a new customer. They will be automatically enrolled in your loyalty program."})}),e.jsx(m,{label:"Email",type:"email",value:x,onChange:E,autoComplete:"email",placeholder:"customer@example.com",requiredIndicator:!0,error:x&&!be?"Please enter a valid email":void 0}),e.jsxs(oe,{columns:2,gap:"300",children:[e.jsx(m,{label:"First Name",value:V,onChange:L,autoComplete:"given-name"}),e.jsx(m,{label:"Last Name",value:X,onChange:O,autoComplete:"family-name"})]}),e.jsx(m,{label:"Phone (optional)",type:"tel",value:G,onChange:q,autoComplete:"tel"}),e.jsxs(h,{gap:"200",children:[e.jsx(S,{variant:"primary",onClick:()=>je.mutate(),loading:je.isPending,disabled:!be,children:"Create Customer"}),e.jsx(S,{variant:"plain",onClick:()=>{k(!1),E(""),L(""),O(""),q("")},children:"Back to Search"})]})]}):e.jsxs(u,{gap:"200",children:[e.jsx(m,{label:"Search Shopify Customers",labelHidden:!0,value:w,onChange:v,placeholder:"Type to search by name, email, or phone...",autoComplete:"off",clearButton:!0,onClearButtonClick:()=>v(""),prefix:e.jsx(Te,{source:ze}),suffix:U?e.jsx(We,{size:"small"}):null,helpText:w.length>0&&w.length<2?"Type at least 2 characters":void 0}),ce.length>0?e.jsxs(u,{gap:"100",children:[ce.map(t=>e.jsx("div",{onClick:()=>{T(t),v(""),N([])},role:"button",tabIndex:0,onKeyDown:l=>{l.key==="Enter"&&(T(t),v(""),N([]))},style:{cursor:"pointer"},children:e.jsx(C,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:e.jsxs(h,{align:"space-between",blockAlign:"center",children:[e.jsxs(u,{gap:"050",children:[e.jsxs(h,{gap:"200",blockAlign:"center",children:[e.jsx(s,{as:"span",fontWeight:"semibold",children:t.name||`${t.firstName||""} ${t.lastName||""}`.trim()||"Unknown"}),t.is_member&&e.jsx(K,{tone:"success",size:"small",children:"Member"})]}),e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:t.email})]}),e.jsxs(s,{as:"span",variant:"bodySm",children:[t.numberOfOrders||t.ordersCount||0," orders"]})]})})},t.id)),e.jsx(S,{variant:"plain",onClick:()=>k(!0),children:"Or create a new customer"})]}):_.length>=2&&!U?e.jsxs(u,{gap:"200",children:[e.jsxs(s,{as:"p",tone:"subdued",alignment:"center",children:['No customers found matching "',_,'"']}),e.jsx(S,{onClick:()=>{k(!0),w.includes("@")&&E(w)},fullWidth:!0,children:"Create New Customer"})]}):e.jsxs(u,{gap:"200",children:[e.jsx(s,{as:"p",tone:"subdued",alignment:"center",children:U?"Searching...":"Search for a Shopify customer or create a new one"}),e.jsx(S,{variant:"plain",onClick:()=>k(!0),children:"Create new customer instead"})]})]})]}),e.jsx(ie,{}),e.jsx(m,{label:"Total Trade-In Value",type:"number",prefix:"$",value:y,onChange:ue,autoComplete:"off",requiredIndicator:!0}),e.jsxs(oe,{columns:2,gap:"300",children:[e.jsx(m,{label:"Paid in Cash",type:"number",prefix:"$",value:F,onChange:me,autoComplete:"off"}),e.jsx(m,{label:"Paid as Store Credit",type:"number",prefix:"$",value:J,onChange:H,autoComplete:"off",helpText:"Auto-calculated from total - cash"})]}),e.jsx(ie,{}),e.jsx(Ue,{label:"Category (Optional)",options:Ae,value:f,onChange:he}),f==="custom"&&e.jsx(m,{label:"Custom Category",value:B,onChange:ge,placeholder:"e.g., Pokemon, Sports Cards",autoComplete:"off"}),e.jsx(m,{label:"Notes (Optional)",value:Y,onChange:pe,multiline:3,autoComplete:"off"})]})})}),e.jsx(Q,{open:Ne,onClose:()=>{M(!1),$(null)},title:"Delete Trade-In Entry",primaryAction:{content:"Delete",destructive:!0,onAction:()=>z&&fe.mutate(z.id),loading:fe.isPending},secondaryActions:[{content:"Cancel",onAction:()=>{M(!1),$(null)}}],children:e.jsx(Q.Section,{children:e.jsxs(s,{as:"p",children:["Are you sure you want to delete trade-in ",e.jsx("strong",{children:z?.reference}),"? This action cannot be undone."]})})})]})}export{ct as EmbeddedTradeLedger};
