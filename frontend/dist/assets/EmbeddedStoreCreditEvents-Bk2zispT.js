import{b as Xe,u as Ae,c as L,j as e}from"./vendor-query-Bq4hz6H9.js";import{r as u}from"./vendor-router-CdtyvhQv.js";import{a as A,g as F}from"./index-CtYfgeRr.js";import{c as et,u as tt}from"./useShopifyData-DeoO_0dv.js";import{P as Fe,B as D,a0 as Pe,v as st,L as he,C as p,a as l,T as s,u as V,h as g,I,a5 as pe,c as y,a6 as it,a9 as nt,b as B,D as X,t as _,Z as at,W as rt,E as Me,a1 as Le,M as O,e as U,g as S,f as me,z as w,G as ee,_ as E,O as Ie,Y as te,$ as Be}from"./vendor-polaris-CV39Dq-f.js";import{T as ot}from"./vendor-appbridge-DL6abzKC.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";function lt(){const[r,d]=u.useState(()=>{if(typeof window>"u")return{isMobile:!1,isTablet:!1};const c=window.innerWidth;return{isMobile:c<768,isTablet:c>=768&&c<1024}});return u.useEffect(()=>{const c=()=>{const m=window.innerWidth;d({isMobile:m<768,isTablet:m>=768&&m<1024})};return window.addEventListener("resize",c),()=>window.removeEventListener("resize",c)},[]),r}const dt=[{label:"Monday",value:"0"},{label:"Tuesday",value:"1"},{label:"Wednesday",value:"2"},{label:"Thursday",value:"3"},{label:"Friday",value:"4"},{label:"Saturday",value:"5"},{label:"Sunday",value:"6"}],Oe=[{label:"Never expires",value:""},{label:"30 days",value:"30"},{label:"60 days",value:"60"},{label:"90 days",value:"90"},{label:"180 days",value:"180"},{label:"1 year",value:"365"}];async function ct(r){const d=await A(`${F()}/promotions/promotions`,r);if(!d.ok)throw new Error("Failed to fetch events");return{events:((await d.json()).promotions||[]).filter(j=>j.promo_type==="purchase_cashback"||j.promo_type==="trade_in_bonus")}}async function ut(r,d){const c=await A(`${F()}/promotions/promotions`,r,{method:"POST",body:JSON.stringify(d)});if(!c.ok)throw new Error("Failed to create event");return c.json()}async function ht(r,d,c){const m=await A(`${F()}/promotions/promotions/${d}`,r,{method:"PUT",body:JSON.stringify(c)});if(!m.ok)throw new Error("Failed to update event");return m.json()}async function pt(r,d){if(!(await A(`${F()}/promotions/promotions/${d}`,r,{method:"DELETE"})).ok)throw new Error("Failed to delete event")}function $(r){return r?new Date(r).toISOString().replace(/\.\d{3}Z$/,"Z"):""}function R(r){const d=r.getFullYear(),c=String(r.getMonth()+1).padStart(2,"0"),m=String(r.getDate()).padStart(2,"0"),j=String(r.getHours()).padStart(2,"0"),G=String(r.getMinutes()).padStart(2,"0");return`${d}-${c}-${m}T${j}:${G}`}async function mt(r,d,c){const m=new URLSearchParams({start_datetime:$(d),end_datetime:$(c)}),j=await A(`${F()}/store-credit-events/sources?${m}`,r);if(!j.ok)throw new Error("Failed to fetch order sources");return j.json()}async function xt(r,d){const c={...d,start_datetime:$(d.start_datetime),end_datetime:$(d.end_datetime)},m=await A(`${F()}/store-credit-events/preview`,r,{method:"POST",body:JSON.stringify(c)});if(!m.ok)throw new Error("Failed to preview event");return m.json()}async function gt(r,d){const c={...d,start_datetime:$(d.start_datetime),end_datetime:$(d.end_datetime)},m=await A(`${F()}/store-credit-events/run`,r,{method:"POST",body:JSON.stringify(c)});if(!m.ok)throw new Error("Failed to run event");return m.json()}async function _t(r,d=1){const c=await A(`${F()}/store-credit-events/history?page=${d}&limit=15`,r);if(!c.ok)throw new Error("Failed to fetch event history");return c.json()}function kt({shop:r}){const d=Xe(),{isMobile:c,isTablet:m}=lt(),[j,G]=u.useState(0),[Re,M]=u.useState(!1),[N,se]=u.useState(null),[$e,Q]=u.useState(!1),[ie,xe]=u.useState(null),[Ne,K]=u.useState(!1),[b,z]=u.useState(null),[h,J]=u.useState(null),[ge,ne]=u.useState([]),[i,x]=u.useState({name:"",description:"",promo_type:"purchase_cashback",bonus_percent:10,starts_at:"",ends_at:"",daily_start_time:"",daily_end_time:"",active_days:[],product_tags_filter:[],collection_ids:[],tier_restriction:[],audience:"members_only",active:!0,credit_expiration_days:""}),[n,f]=u.useState({start_datetime:"",end_datetime:"",sources:[],credit_percent:10,include_authorized:!0,credit_expiration_days:"",collection_ids:[],product_tags:[],audience:"all_customers"}),[ae,_e]=u.useState(""),[re,je]=u.useState(""),[oe,ye]=u.useState(""),[le,fe]=u.useState(""),{data:C}=et(r),{data:v}=tt(r),{data:ze,isLoading:We}=Ae({queryKey:["scheduled-events",r],queryFn:()=>ct(r),enabled:!!r}),[be,ve]=u.useState(1),{data:k,isLoading:Se,refetch:qe}=Ae({queryKey:["event-history",r,be],queryFn:()=>_t(r,be),enabled:!!r&&j===2}),He=u.useMemo(()=>{if(!C?.tags)return[];const t=(oe||"").toLowerCase();return(t?C.tags.filter(a=>(a||"").toLowerCase().includes(t)):C.tags).filter(a=>a).map(a=>({value:a,label:a}))},[C,oe]),Ue=u.useMemo(()=>{if(!v?.collections)return[];const t=(le||"").toLowerCase();return(t?v.collections.filter(a=>(a?.title||"").toLowerCase().includes(t)):v.collections).filter(a=>a?.title).map(a=>({value:a.id,label:a.title}))},[v,le]),Ge=u.useMemo(()=>{if(!C?.tags)return[];const t=(ae||"").toLowerCase();return(t?C.tags.filter(a=>(a||"").toLowerCase().includes(t)):C.tags).filter(a=>a).map(a=>({value:a,label:a}))},[C,ae]),Qe=u.useMemo(()=>{if(!v?.collections)return[];const t=(re||"").toLowerCase();return(t?v.collections.filter(a=>(a?.title||"").toLowerCase().includes(t)):v.collections).filter(a=>a?.title).map(a=>({value:a.id,label:a.title}))},[v,re]),de=L({mutationFn:t=>ut(r,t),onSuccess:()=>{d.invalidateQueries({queryKey:["scheduled-events"]}),M(!1),Y()}}),ce=L({mutationFn:({id:t,data:o})=>ht(r,t,o),onSuccess:()=>{d.invalidateQueries({queryKey:["scheduled-events"]}),M(!1),se(null),Y()}}),we=L({mutationFn:t=>pt(r,t),onSuccess:()=>{d.invalidateQueries({queryKey:["scheduled-events"]}),Q(!1),xe(null)}}),W=L({mutationFn:({start:t,end:o})=>mt(r,t,o),onSuccess:t=>ne(t.sources)}),Ce=L({mutationFn:()=>xt(r,{start_datetime:n.start_datetime,end_datetime:n.end_datetime,sources:n.sources,credit_percent:n.credit_percent,include_authorized:n.include_authorized,collection_ids:n.collection_ids.length>0?n.collection_ids:void 0,product_tags:n.product_tags.length>0?n.product_tags:void 0,audience:n.audience}),onSuccess:t=>{z(t),J(null)}}),ke=L({mutationFn:()=>gt(r,{start_datetime:n.start_datetime,end_datetime:n.end_datetime,sources:n.sources,credit_percent:n.credit_percent,include_authorized:n.include_authorized,expires_at:n.credit_expiration_days?new Date(Date.now()+parseInt(n.credit_expiration_days)*24*60*60*1e3).toISOString():void 0,collection_ids:n.collection_ids.length>0?n.collection_ids:void 0,product_tags:n.product_tags.length>0?n.product_tags:void 0,audience:n.audience}),onSuccess:t=>{J(t),z(null),d.invalidateQueries({queryKey:["event-history"]})}}),Y=u.useCallback(()=>{const t=new Date,o=new Date(t.getTime()+10080*60*1e3);x({name:"",description:"",promo_type:"purchase_cashback",bonus_percent:10,starts_at:R(t),ends_at:R(o),daily_start_time:"",daily_end_time:"",active_days:[],product_tags_filter:[],collection_ids:[],tier_restriction:[],audience:"members_only",active:!0,credit_expiration_days:""}),ye(""),fe("")},[]),ue=u.useCallback(()=>{f({start_datetime:"",end_datetime:"",sources:[],credit_percent:10,include_authorized:!0,credit_expiration_days:"",collection_ids:[],product_tags:[],audience:"all_customers"}),z(null),J(null),ne([]),_e(""),je("")},[]),P=u.useCallback(t=>{if(Y(),t){const o=new Date,a=t.duration_hours?new Date(o.getTime()+t.duration_hours*60*60*1e3):new Date(o.getTime()+10080*60*1e3);x(H=>({...H,name:t.name,description:t.description,bonus_percent:t.bonus_percent,daily_start_time:t.daily_start_time||"",daily_end_time:t.daily_end_time||"",active_days:t.active_days||[],starts_at:R(o),ends_at:R(a)}))}se(null),M(!0)},[Y]),Ke=u.useCallback(t=>{se(t),x({name:t.name,description:t.description||"",promo_type:t.promo_type,bonus_percent:t.bonus_percent,starts_at:t.starts_at?.slice(0,16)||"",ends_at:t.ends_at?.slice(0,16)||"",daily_start_time:t.daily_start_time||"",daily_end_time:t.daily_end_time||"",active_days:t.active_days?t.active_days.split(","):[],product_tags_filter:t.product_tags_filter||[],collection_ids:t.collection_ids||[],tier_restriction:t.tier_restriction||[],audience:t.audience||"members_only",active:t.active,credit_expiration_days:""}),M(!0)},[]),q=u.useCallback((t,o)=>{const a=new Date,H=t?new Date(a.getTime()+t*60*60*1e3):new Date(a.getTime()+10800*1e3),Z=R(a),Ee=R(H);f({start_datetime:Z,end_datetime:Ee,sources:[],credit_percent:o||10,include_authorized:!0,credit_expiration_days:"",collection_ids:[],product_tags:[],audience:"all_customers"}),z(null),J(null),ne([]),K(!0),W.mutate({start:Z,end:Ee})},[W]),Te=u.useCallback((t,o)=>{const a={...n,[t]:o};f(a),a.start_datetime&&a.end_datetime&&W.mutate({start:a.start_datetime,end:a.end_datetime})},[n,W]),Je=u.useCallback(()=>{const t={name:i.name,description:i.description||null,promo_type:i.promo_type,bonus_percent:i.bonus_percent,bonus_flat:0,multiplier:1,starts_at:i.starts_at,ends_at:i.ends_at,daily_start_time:i.daily_start_time||null,daily_end_time:i.daily_end_time||null,active_days:i.active_days.length>0?i.active_days.join(","):null,product_tags_filter:i.product_tags_filter.length>0?i.product_tags_filter:null,collection_ids:i.collection_ids.length>0?i.collection_ids:null,tier_restriction:i.tier_restriction.length>0?i.tier_restriction:null,audience:i.audience,channel:"all",stackable:!0,active:i.active,credit_expiration_days:i.credit_expiration_days?parseInt(i.credit_expiration_days):null};N?ce.mutate({id:N.id,data:t}):de.mutate(t)},[i,N,de,ce]),T=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t),Ye=t=>t.active?t.is_active_now?e.jsx(_,{tone:"success",children:"Active Now"}):t.starts_at&&new Date(t.starts_at)>new Date?e.jsx(_,{tone:"info",children:"Scheduled"}):e.jsx(_,{tone:"warning",children:"Ended"}):e.jsx(_,{children:"Disabled"}),Ze=t=>{const o=[];if(t.daily_start_time&&t.daily_end_time&&o.push(`${t.daily_start_time} - ${t.daily_end_time}`),t.active_days){const a=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],H=t.active_days.split(",").map(Z=>a[parseInt(Z)]);o.push(H.join(", "))}return o.length>0?o.join(" on "):"All times"},Ve=[{id:"scheduled",content:"Live Promotions",panelID:"scheduled-panel"},{id:"bulk",content:"Post-Event Rewards",panelID:"bulk-panel"},{id:"history",content:"Event History",panelID:"history-panel"}];if(!r)return e.jsx(Fe,{title:"Store Credit Events",children:e.jsx(D,{tone:"warning",children:e.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})});const De=ze?.events||[];return e.jsxs(e.Fragment,{children:[e.jsx(ot,{title:"Store Credit Events",children:e.jsx("button",{variant:"primary",onClick:()=>P(),children:"New Event"})}),e.jsxs(Fe,{title:"Store Credit Events",subtitle:"Create bonus events to reward customers with store credit",primaryAction:{content:"New Live Promotion",icon:st,onAction:()=>P()},secondaryActions:[{content:"Run Bulk Event",icon:Pe,onAction:()=>q()}],children:[e.jsxs(he,{children:[e.jsx(he.Section,{children:e.jsx(p,{children:e.jsxs(l,{gap:"400",children:[e.jsx(s,{as:"h3",variant:"headingMd",children:"Quick Start Templates"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Use a template to quickly create common bonus events"}),e.jsxs(V,{columns:c?1:m?2:4,gap:"300",children:[e.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:e.jsx(p,{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",minHeight:"140px"},children:[e.jsxs(l,{gap:"200",children:[e.jsxs(g,{gap:"200",blockAlign:"center",children:[e.jsx(I,{source:pe}),e.jsx(s,{as:"h4",variant:"headingSm",children:"Black Friday"})]}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"+10% store credit on all purchases during Black Friday weekend"})]}),e.jsx("div",{style:{marginTop:"auto",paddingTop:"12px"},children:e.jsx(y,{size:"slim",onClick:()=>P({name:"Black Friday Bonus",description:"Earn 10% store credit on all purchases this Black Friday weekend!",bonus_percent:10,duration_hours:72}),children:"Use Template"})})]})})}),e.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:e.jsx(p,{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",minHeight:"140px"},children:[e.jsxs(l,{gap:"200",children:[e.jsxs(g,{gap:"200",blockAlign:"center",children:[e.jsx(I,{source:it}),e.jsx(s,{as:"h4",variant:"headingSm",children:"Trade Night"})]}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Saturday 6-9pm bonus for in-store trades and purchases"})]}),e.jsx("div",{style:{marginTop:"auto",paddingTop:"12px"},children:e.jsx(y,{size:"slim",onClick:()=>P({name:"Saturday Trade Night",description:"Extra 10% store credit on Saturday evening purchases!",bonus_percent:10,daily_start_time:"18:00",daily_end_time:"21:00",active_days:["5"]}),children:"Use Template"})})]})})}),e.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:e.jsx(p,{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",minHeight:"140px"},children:[e.jsxs(l,{gap:"200",children:[e.jsxs(g,{gap:"200",blockAlign:"center",children:[e.jsx(I,{source:pe}),e.jsx(s,{as:"h4",variant:"headingSm",children:"Weekend Warrior"})]}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"+5% store credit on all weekend purchases"})]}),e.jsx("div",{style:{marginTop:"auto",paddingTop:"12px"},children:e.jsx(y,{size:"slim",onClick:()=>P({name:"Weekend Bonus",description:"Earn 5% store credit on all weekend purchases!",bonus_percent:5,active_days:["5","6"]}),children:"Use Template"})})]})})}),e.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:e.jsx(p,{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",minHeight:"140px"},children:[e.jsxs(l,{gap:"200",children:[e.jsxs(g,{gap:"200",blockAlign:"center",children:[e.jsx(I,{source:pe}),e.jsx(s,{as:"h4",variant:"headingSm",children:"Grand Opening"})]}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"+15% store credit on opening day purchases"})]}),e.jsx("div",{style:{marginTop:"auto",paddingTop:"12px"},children:e.jsx(y,{size:"slim",onClick:()=>P({name:"Grand Opening Bonus",description:"Celebrate our grand opening with 15% store credit!",bonus_percent:15,duration_hours:24}),children:"Use Template"})})]})})})]})]})})}),e.jsx(he.Section,{children:e.jsxs(nt,{tabs:Ve,selected:j,onSelect:G,children:[j===0&&e.jsx(p,{children:We?e.jsx(l,{gap:"400",children:[1,2,3].map(t=>e.jsx(B,{paddingBlock:"300",children:e.jsxs(g,{gap:"400",blockAlign:"center",children:[e.jsx(B,{background:"bg-surface-secondary",borderRadius:"100",minHeight:"20px",minWidth:"150px"}),e.jsx(B,{background:"bg-surface-secondary",borderRadius:"100",minHeight:"20px",minWidth:"100px"})]})},t))}):De.length>0?e.jsx(X,{columnContentTypes:["text","text","text","text","text","text","text"],headings:["Event Name","Audience","Bonus","Schedule","Date Range","Status","Actions"],rows:De.map(t=>[e.jsxs(l,{gap:"100",children:[e.jsx(s,{as:"span",fontWeight:"semibold",children:t.name}),t.product_tags_filter&&t.product_tags_filter.length>0&&e.jsx(g,{gap:"100",children:t.product_tags_filter.slice(0,2).map(o=>e.jsx(_,{size:"small",children:o},o))})]},t.id),e.jsx(_,{tone:t.audience==="all_customers"?"info":void 0,children:t.audience==="all_customers"?"All Customers":"Members Only"},`audience-${t.id}`),e.jsx(_,{tone:"success",children:`+${t.bonus_percent}%`},t.id),Ze(t),e.jsxs(s,{as:"span",variant:"bodySm",children:[t.starts_at?new Date(t.starts_at).toLocaleDateString():"—"," - ",t.ends_at?new Date(t.ends_at).toLocaleDateString():"—"]},t.id),Ye(t),e.jsxs(g,{gap:"200",children:[e.jsx(y,{size:"slim",icon:at,onClick:()=>Ke(t),accessibilityLabel:`Edit ${t.name}`}),e.jsx(y,{size:"slim",icon:rt,tone:"critical",onClick:()=>{xe(t),Q(!0)},accessibilityLabel:`Delete ${t.name}`})]},t.id)])}):e.jsx(Me,{heading:"No live promotions yet",action:{content:"Create your first event",onAction:()=>P()},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Schedule store credit bonus events to reward your customers during special periods."})})}),j===1&&e.jsxs(l,{gap:"400",children:[e.jsx(p,{children:e.jsxs(l,{gap:"300",children:[e.jsx(s,{as:"h3",variant:"headingMd",children:"Send Post-Event Rewards"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Issue store credit to customers based on their past orders. Great for rewarding customers after a busy sales period."}),e.jsxs(V,{columns:c?1:m?2:3,gap:"300",children:[e.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:e.jsx(p,{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",minHeight:"100px"},children:[e.jsxs(l,{gap:"200",children:[e.jsx(s,{as:"h4",variant:"headingSm",children:"Trade Night Recap"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Issue 10% credit for orders from the last 3 hours"})]}),e.jsx("div",{style:{marginTop:"auto",paddingTop:"12px"},children:e.jsx(y,{size:"slim",onClick:()=>q(3,10),children:"Run Event"})})]})})}),e.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:e.jsx(p,{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",minHeight:"100px"},children:[e.jsxs(l,{gap:"200",children:[e.jsx(s,{as:"h4",variant:"headingSm",children:"Weekend Recap"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Issue 5% credit for orders from the last 48 hours"})]}),e.jsx("div",{style:{marginTop:"auto",paddingTop:"12px"},children:e.jsx(y,{size:"slim",onClick:()=>q(48,5),children:"Run Event"})})]})})}),e.jsx("div",{style:{display:"flex",flexDirection:"column",height:"100%"},children:e.jsx(p,{children:e.jsxs("div",{style:{display:"flex",flexDirection:"column",height:"100%",minHeight:"100px"},children:[e.jsxs(l,{gap:"200",children:[e.jsx(s,{as:"h4",variant:"headingSm",children:"Custom Event"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Configure your own date range and credit percentage"})]}),e.jsx("div",{style:{marginTop:"auto",paddingTop:"12px"},children:e.jsx(y,{size:"slim",variant:"primary",onClick:()=>q(),children:"Create Custom"})})]})})})]})]})}),e.jsx(p,{children:e.jsxs(l,{gap:"300",children:[e.jsx(s,{as:"h3",variant:"headingMd",children:"How Bulk Events Work"}),e.jsxs(l,{gap:"200",children:[e.jsxs(g,{gap:"200",blockAlign:"start",children:[e.jsx(_,{tone:"info",children:"1"}),e.jsxs(s,{as:"p",variant:"bodySm",children:[e.jsx("strong",{children:"Set Date Range:"})," Choose the period to include orders from"]})]}),e.jsxs(g,{gap:"200",blockAlign:"start",children:[e.jsx(_,{tone:"info",children:"2"}),e.jsxs(s,{as:"p",variant:"bodySm",children:[e.jsx("strong",{children:"Select Sources:"})," Filter by POS, Web, or all channels"]})]}),e.jsxs(g,{gap:"200",blockAlign:"start",children:[e.jsx(_,{tone:"info",children:"3"}),e.jsxs(s,{as:"p",variant:"bodySm",children:[e.jsx("strong",{children:"Preview:"})," See exactly how much credit will be issued"]})]}),e.jsxs(g,{gap:"200",blockAlign:"start",children:[e.jsx(_,{tone:"success",children:"4"}),e.jsxs(s,{as:"p",variant:"bodySm",children:[e.jsx("strong",{children:"Apply:"})," Issue store credit to all qualifying customers"]})]})]})]})})]}),j===2&&e.jsx(p,{children:e.jsxs(l,{gap:"400",children:[e.jsxs(g,{align:"space-between",blockAlign:"center",children:[e.jsx(s,{as:"h3",variant:"headingMd",children:"Past Store Credit Events"}),e.jsx(y,{icon:Le,onClick:()=>qe(),loading:Se,children:"Refresh"})]}),Se?e.jsx(l,{gap:"400",children:[1,2,3].map(t=>e.jsx(B,{paddingBlock:"300",children:e.jsxs(g,{gap:"400",blockAlign:"center",children:[e.jsx(B,{background:"bg-surface-secondary",borderRadius:"100",minHeight:"20px",minWidth:"150px"}),e.jsx(B,{background:"bg-surface-secondary",borderRadius:"100",minHeight:"20px",minWidth:"100px"})]})},t))}):k&&k.events.length>0?e.jsxs(e.Fragment,{children:[e.jsx(X,{columnContentTypes:["text","text","numeric","numeric","numeric","text"],headings:["Event","Date Range","Credited","Skipped","Failed","Total Issued"],rows:k.events.map(t=>[e.jsxs(l,{gap:"100",children:[e.jsx(s,{as:"span",fontWeight:"semibold",children:t.name}),e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:t.created_at?new Date(t.created_at).toLocaleString():"—"})]},t.id),e.jsxs(s,{as:"span",variant:"bodySm",children:[t.date_range_start?new Date(t.date_range_start).toLocaleDateString():"—"," - ",t.date_range_end?new Date(t.date_range_end).toLocaleDateString():"—"]},t.id),e.jsx(_,{tone:"success",children:String(t.customers_processed)},`success-${t.id}`),t.customers_skipped>0?e.jsx(_,{children:String(t.customers_skipped)},`skipped-${t.id}`):e.jsx(s,{as:"span",children:"0"},`skipped-${t.id}`),t.customers_failed>0?e.jsx(_,{tone:"critical",children:String(t.customers_failed)},`failed-${t.id}`):e.jsx(s,{as:"span",children:"0"},`failed-${t.id}`),e.jsx(s,{as:"span",fontWeight:"semibold",children:T(t.total_credit_amount)},`total-${t.id}`)])}),k.pages>1&&e.jsxs(g,{align:"center",gap:"200",children:[e.jsx(y,{disabled:!k.has_prev,onClick:()=>ve(t=>Math.max(1,t-1)),children:"Previous"}),e.jsxs(s,{as:"span",variant:"bodySm",children:["Page ",k.page," of ",k.pages]}),e.jsx(y,{disabled:!k.has_next,onClick:()=>ve(t=>t+1),children:"Next"})]})]}):e.jsx(Me,{heading:"No event history yet",action:{content:"Run your first event",onAction:()=>{G(1),q()}},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Run a bulk store credit event and it will appear here for your records."})})]})})]})})]}),e.jsx(O,{open:Re,onClose:()=>M(!1),title:N?"Edit Live Promotion":"New Live Promotion",primaryAction:{content:N?"Save Changes":"Create Event",onAction:Je,loading:de.isPending||ce.isPending},secondaryActions:[{content:"Cancel",onAction:()=>M(!1)}],children:e.jsx(O.Section,{children:e.jsxs(U,{children:[e.jsx(S,{label:"Event Name",value:i.name,onChange:t=>x({...i,name:t}),autoComplete:"off",requiredIndicator:!0,placeholder:"e.g., Black Friday Bonus, Saturday Trade Night"}),e.jsx(S,{label:"Description",value:i.description,onChange:t=>x({...i,description:t}),multiline:2,autoComplete:"off",helpText:"Shown to customers in their account"}),e.jsx(me,{label:"Bonus Type",options:[{label:"Purchase Cashback (% of order total)",value:"purchase_cashback"},{label:"Trade-In Bonus (% extra on trade-ins)",value:"trade_in_bonus"}],value:i.promo_type,onChange:t=>x({...i,promo_type:t})}),e.jsx(S,{label:"Bonus Percentage",type:"number",value:i.bonus_percent.toString(),onChange:t=>x({...i,bonus_percent:parseFloat(t)||0}),suffix:"%",autoComplete:"off",helpText:"Percentage of order/trade-in value to credit"}),e.jsx(w,{}),e.jsx(s,{as:"h3",variant:"headingSm",children:"Who Should Receive This Bonus?"}),e.jsx(ee,{title:"Target Audience",titleHidden:!0,choices:[{label:"Members Only",value:"members_only",helpText:"Only enrolled TradeUp members receive the bonus"},{label:"All Customers Who Purchase",value:"all_customers",helpText:"Any customer who meets criteria gets store credit"}],selected:[i.audience],onChange:t=>x({...i,audience:t[0]})}),i.audience==="all_customers"&&e.jsx(D,{tone:"info",children:e.jsx("p",{children:"Both members and non-members will receive store credit directly to their Shopify account. Great for acquisition campaigns!"})}),e.jsx(w,{}),e.jsx(s,{as:"h3",variant:"headingSm",children:"Date Range"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"The event will be active from start date through end date"}),e.jsxs(U.Group,{children:[e.jsx(S,{label:"Start Date",type:"date",value:i.starts_at.split("T")[0],onChange:t=>x({...i,starts_at:t+"T00:00"}),autoComplete:"off",requiredIndicator:!0}),e.jsx(S,{label:"End Date",type:"date",value:i.ends_at.split("T")[0],onChange:t=>x({...i,ends_at:t+"T23:59"}),autoComplete:"off",requiredIndicator:!0})]}),e.jsx(w,{}),e.jsx(s,{as:"h3",variant:"headingSm",children:"Daily Time Window (Optional)"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Limit this bonus to specific hours each day (e.g., 6-9pm trade nights)"}),e.jsxs(U.Group,{children:[e.jsx(S,{label:"Daily Start Time",type:"time",value:i.daily_start_time,onChange:t=>x({...i,daily_start_time:t}),autoComplete:"off",helpText:"e.g., 18:00 for 6 PM"}),e.jsx(S,{label:"Daily End Time",type:"time",value:i.daily_end_time,onChange:t=>x({...i,daily_end_time:t}),autoComplete:"off",helpText:"e.g., 21:00 for 9 PM"})]}),e.jsx(ee,{title:"Active Days",choices:dt,selected:i.active_days,onChange:t=>x({...i,active_days:t}),allowMultiple:!0}),e.jsx(w,{}),e.jsx(s,{as:"h3",variant:"headingSm",children:"Product Filters (Optional)"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Only apply this bonus to specific products"}),e.jsxs(l,{gap:"200",children:[e.jsx(E,{options:He,selected:i.product_tags_filter,onSelect:t=>x({...i,product_tags_filter:t}),textField:e.jsx(E.TextField,{label:"Product Tags",value:oe,onChange:ye,placeholder:"e.g., pokemon, sports-cards",prefix:e.jsx(I,{source:Ie}),autoComplete:"off"}),allowMultiple:!0}),i.product_tags_filter.length>0&&e.jsx(g,{gap:"100",wrap:!0,children:i.product_tags_filter.map(t=>e.jsx(te,{onRemove:()=>x({...i,product_tags_filter:i.product_tags_filter.filter(o=>o!==t)}),children:t},t))})]}),e.jsxs(l,{gap:"200",children:[e.jsx(E,{options:Ue,selected:i.collection_ids,onSelect:t=>x({...i,collection_ids:t}),textField:e.jsx(E.TextField,{label:"Collections",value:le,onChange:fe,placeholder:"Search collections...",prefix:e.jsx(I,{source:Ie}),autoComplete:"off"}),allowMultiple:!0}),i.collection_ids.length>0&&e.jsx(g,{gap:"100",wrap:!0,children:i.collection_ids.map(t=>{const o=v?.collections?.find(a=>a?.id===t);return e.jsx(te,{onRemove:()=>x({...i,collection_ids:i.collection_ids.filter(a=>a!==t)}),children:o?.title||t},t)})})]}),e.jsx(w,{}),e.jsx(me,{label:"Credit Expiration",options:Oe,value:i.credit_expiration_days,onChange:t=>x({...i,credit_expiration_days:t}),helpText:"How long before credited amounts expire"}),e.jsx(Be,{label:"Event is active",checked:i.active,onChange:t=>x({...i,active:t})})]})})}),e.jsx(O,{open:$e,onClose:()=>Q(!1),title:"Delete Event",primaryAction:{content:"Delete",destructive:!0,onAction:()=>ie&&we.mutate(ie.id),loading:we.isPending},secondaryActions:[{content:"Cancel",onAction:()=>Q(!1)}],children:e.jsx(O.Section,{children:e.jsxs(s,{as:"p",children:['Are you sure you want to delete "',ie?.name,'"? This action cannot be undone.']})})}),e.jsx(O,{open:Ne,onClose:()=>{K(!1),ue()},title:"Run Bulk Store Credit Event",size:"large",primaryAction:b&&!h?{content:"Apply Credits",icon:Pe,onAction:()=>ke.mutate(),loading:ke.isPending}:h?{content:"Done",onAction:()=>{K(!1),ue()}}:{content:"Preview (Dry Run)",icon:Le,onAction:()=>Ce.mutate(),loading:Ce.isPending,disabled:!n.start_datetime||!n.end_datetime||n.sources.length===0},secondaryActions:h?[]:[{content:"Cancel",onAction:()=>{K(!1),ue()}}],children:e.jsx(O.Section,{children:h?e.jsxs(l,{gap:"400",children:[e.jsx(D,{title:h.success_count>0?"Event Completed Successfully!":"Event Completed",tone:h.failure_count>0?"warning":"success",children:e.jsxs("p",{children:["Issued ",T(h.total_credit_issued)," in store credit to ",h.success_count," customers.",h.skipped_count&&h.skipped_count>0&&` ${h.skipped_count} skipped (already received).`,h.failure_count>0&&` ${h.failure_count} failed.`]})}),e.jsxs(V,{columns:c?2:4,gap:"300",children:[e.jsx(p,{children:e.jsxs(l,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Successful"}),e.jsx(s,{as:"p",variant:"headingLg",tone:"success",children:h.success_count})]})}),e.jsx(p,{children:e.jsxs(l,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Total Credited"}),e.jsx(s,{as:"p",variant:"headingLg",tone:"success",children:T(h.total_credit_issued)})]})}),e.jsx(p,{children:e.jsxs(l,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Skipped"}),e.jsx(s,{as:"p",variant:"headingLg",children:h.skipped_count||0})]})}),e.jsx(p,{children:e.jsxs(l,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Failed"}),e.jsx(s,{as:"p",variant:"headingLg",tone:h.failure_count>0?"critical":void 0,children:h.failure_count})]})})]}),h.results&&h.results.length>0&&e.jsx(p,{children:e.jsxs(l,{gap:"300",children:[e.jsxs(s,{as:"h4",variant:"headingSm",children:["All Credit Issuances (",h.results.length," total)"]}),e.jsx(X,{columnContentTypes:["text","numeric","text"],headings:["Customer","Credit Amount","Status"],rows:h.results.map(t=>[t.customer_email||t.customer_id||"Unknown",T(t.credit_amount||0),t.success&&!t.skipped?e.jsx(_,{tone:"success",children:"Issued"},t.customer_id):t.skipped?e.jsx(_,{children:"Already Received"},t.customer_id):e.jsx(_,{tone:"critical",children:t.error||"Failed"},t.customer_id)])})]})}),h.errors&&h.errors.length>0&&e.jsx(p,{children:e.jsxs(l,{gap:"200",children:[e.jsx(s,{as:"h4",variant:"headingSm",tone:"critical",children:"Errors"}),h.errors.map((t,o)=>e.jsx(s,{as:"p",variant:"bodySm",children:t},o))]})})]}):b?e.jsxs(l,{gap:"400",children:[e.jsx(D,{title:"Preview Results",tone:"info",children:e.jsx("p",{children:'This is a dry run. No credits have been issued yet. Review the data below and click "Apply Credits" to proceed.'})}),e.jsxs(V,{columns:c||m?2:4,gap:"300",children:[e.jsx(p,{children:e.jsxs(l,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Total Orders"}),e.jsx(s,{as:"p",variant:"headingLg",children:b.summary.total_orders})]})}),e.jsx(p,{children:e.jsxs(l,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Unique Customers"}),e.jsx(s,{as:"p",variant:"headingLg",children:b.summary.unique_customers})]})}),e.jsx(p,{children:e.jsxs(l,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Total Order Value"}),e.jsx(s,{as:"p",variant:"headingLg",children:T(b.summary.total_order_value)})]})}),e.jsx(p,{children:e.jsxs(l,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Credit to Issue"}),e.jsx(s,{as:"p",variant:"headingLg",tone:"success",children:T(b.summary.total_credit_to_issue)})]})})]}),b.top_customers&&b.top_customers.length>0&&e.jsx(p,{children:e.jsxs(l,{gap:"300",children:[e.jsxs(s,{as:"h4",variant:"headingSm",children:["All Customers to Receive Credit (",b.top_customers.length," total)"]}),e.jsx(X,{columnContentTypes:["text","text","numeric","numeric","numeric"],headings:["Customer","Email","Orders","Spent","Credit"],rows:b.top_customers.map(t=>[t.name||"Guest",t.email||"-",t.order_count||0,T(t.total_spent||0),e.jsx(_,{tone:"success",children:T(t.credit_amount||0)},t.customer_id)])})]})}),e.jsx(y,{onClick:()=>z(null),variant:"plain",children:"Back to Edit"})]}):e.jsxs(U,{children:[e.jsx(D,{tone:"info",children:e.jsx("p",{children:'Reward customers for past purchases. Set your date range and filters, then click "Preview" to see who qualifies before sending credits.'})}),e.jsxs(U.Group,{children:[e.jsx(S,{label:"Start Date & Time",type:"datetime-local",value:n.start_datetime,onChange:t=>Te("start_datetime",t),autoComplete:"off",requiredIndicator:!0,helpText:"Include orders created after this time"}),e.jsx(S,{label:"End Date & Time",type:"datetime-local",value:n.end_datetime,onChange:t=>Te("end_datetime",t),autoComplete:"off",requiredIndicator:!0,helpText:"Include orders created before this time"})]}),e.jsx(S,{label:"Credit Percentage",type:"number",value:n.credit_percent.toString(),onChange:t=>f({...n,credit_percent:parseFloat(t)||0}),suffix:"%",autoComplete:"off",helpText:"Percentage of order total to issue as store credit"}),e.jsx(w,{}),e.jsx(s,{as:"h3",variant:"headingSm",children:"Who Should Receive This Credit?"}),e.jsx(ee,{title:"Target Audience",titleHidden:!0,choices:[{label:"All Customers Who Purchased (Recommended)",value:"all_customers",helpText:"Any customer with orders in the date range gets credit"},{label:"Members Only",value:"members_only",helpText:"Only enrolled TradeUp members receive the credit"}],selected:[n.audience],onChange:t=>f({...n,audience:t[0]})}),n.audience==="all_customers"&&e.jsx(D,{tone:"info",children:e.jsx("p",{children:"Store credit will be issued directly to customers' Shopify accounts, including those who aren't members. Great for acquisition campaigns!"})}),n.audience==="members_only"&&e.jsx(D,{tone:"warning",children:e.jsx("p",{children:"Only enrolled TradeUp members will receive credit. Non-members who made purchases in this period will be skipped."})}),e.jsx(w,{}),e.jsxs(l,{gap:"200",children:[e.jsxs(s,{as:"span",variant:"bodyMd",children:["Order Sources ",e.jsx(s,{as:"span",tone:"critical",children:"*"})]}),W.isPending?e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Loading available sources..."}):ge.length>0?e.jsx(ee,{title:"",choices:ge.map(t=>({label:`${t.name} (${t.count} orders)`,value:t.name})),selected:n.sources,onChange:t=>f({...n,sources:t}),allowMultiple:!0}):n.start_datetime&&n.end_datetime?e.jsx(D,{tone:"warning",children:e.jsx("p",{children:"No orders found in this date range. Try adjusting the dates."})}):e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Select start and end dates to see available order sources."})]}),e.jsx(w,{}),e.jsx(s,{as:"h3",variant:"headingSm",children:"Product Filters (Optional)"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Narrow down to orders containing specific products. Leave empty to include all orders."}),e.jsxs(l,{gap:"200",children:[e.jsx(s,{as:"span",variant:"bodyMd",children:"Collections"}),e.jsx(E,{options:Qe,selected:n.collection_ids,onSelect:t=>f({...n,collection_ids:t}),textField:e.jsx(E.TextField,{label:"",onChange:je,value:re,placeholder:"Search collections...",autoComplete:"off"}),allowMultiple:!0,listTitle:"Available Collections"}),n.collection_ids.length>0&&e.jsx(g,{gap:"100",wrap:!0,children:n.collection_ids.map(t=>{const o=v?.collections?.find(a=>a.id===t);return e.jsx(te,{onRemove:()=>f({...n,collection_ids:n.collection_ids.filter(a=>a!==t)}),children:o?.title||t},t)})})]}),e.jsxs(l,{gap:"200",children:[e.jsx(s,{as:"span",variant:"bodyMd",children:"Product Tags"}),e.jsx(E,{options:Ge,selected:n.product_tags,onSelect:t=>f({...n,product_tags:t}),textField:e.jsx(E.TextField,{label:"",onChange:_e,value:ae,placeholder:"Search tags...",autoComplete:"off"}),allowMultiple:!0,listTitle:"Available Tags"}),n.product_tags.length>0&&e.jsx(g,{gap:"100",wrap:!0,children:n.product_tags.map(t=>e.jsx(te,{onRemove:()=>f({...n,product_tags:n.product_tags.filter(o=>o!==t)}),children:t},t))})]}),e.jsx(w,{}),e.jsx(me,{label:"Credit Expiration",options:Oe,value:n.credit_expiration_days,onChange:t=>f({...n,credit_expiration_days:t}),helpText:"How long before issued credits expire"}),e.jsx(Be,{label:"Include authorized (unpaid) orders",checked:n.include_authorized,onChange:t=>f({...n,include_authorized:t})})]})})})]})]})}export{kt as EmbeddedStoreCreditEvents,kt as default};
