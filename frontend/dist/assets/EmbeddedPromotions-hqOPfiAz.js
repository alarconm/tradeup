import{b as Xe,u as ye,c as M,j as e}from"./vendor-query-Bq4hz6H9.js";import{r as u}from"./vendor-router-CdtyvhQv.js";import{a as T,g as k}from"./index-CIr4Wx79.js";import{u as Je,a as Ye,b as Ze,c as et}from"./useShopifyData-B4ZYikEh.js";import{P as J,B as E,L as C,u as N,C as p,a as r,b,h,v as Oe,T as s,c as y,z as P,t as m,a0 as Le,Z as Ie,D as $e,E as Ne,M as F,e as O,g as x,f as Y,G as ve,a1 as D,I as Z,V as ee,$ as te,N as Se,a2 as tt,a3 as nt,l as st}from"./vendor-polaris-vFYxDTRx.js";import{T as it}from"./vendor-appbridge-DL6abzKC.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";function at(i=768){const[d,_]=u.useState(typeof window<"u"?window.innerWidth<i:!1);return u.useEffect(()=>{const g=()=>_(window.innerWidth<i);return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[i]),d}const Ce=[{label:"Trade-In Bonus",value:"trade_in_bonus"},{label:"Purchase Cashback",value:"purchase_cashback"},{label:"Flat Bonus",value:"flat_bonus"},{label:"Credit Multiplier",value:"multiplier"}],rt=[{label:"All Channels",value:"all"},{label:"In-Store Only",value:"in_store"},{label:"Online Only",value:"online"}],ot=[{label:"Monday",value:"0"},{label:"Tuesday",value:"1"},{label:"Wednesday",value:"2"},{label:"Thursday",value:"3"},{label:"Friday",value:"4"},{label:"Saturday",value:"5"},{label:"Sunday",value:"6"}],Re=[{label:"Never expires",value:""},{label:"30 days",value:"30"},{label:"60 days",value:"60"},{label:"90 days",value:"90"},{label:"180 days",value:"180"},{label:"1 year (365 days)",value:"365"}];async function lt(i){const d=await T(`${k()}/promotions/promotions`,i);if(!d.ok)throw new Error("Failed to fetch promotions");return d.json()}async function ct(i){const d=await T(`${k()}/promotions/tiers`,i);if(!d.ok)throw new Error("Failed to fetch tiers");return d.json()}async function dt(i){const d=await T(`${k()}/promotions/dashboard/stats`,i);if(!d.ok)throw new Error("Failed to fetch stats");return d.json()}async function ut(i,d){const _=await T(`${k()}/promotions/promotions`,i,{method:"POST",body:JSON.stringify(d)});if(!_.ok)throw new Error("Failed to create promotion");return _.json()}async function ht(i,d,_){const g=await T(`${k()}/promotions/promotions/${d}`,i,{method:"PUT",body:JSON.stringify(_)});if(!g.ok)throw new Error("Failed to update promotion");return g.json()}async function pt(i,d){if(!(await T(`${k()}/promotions/promotions/${d}`,i,{method:"DELETE"})).ok)throw new Error("Failed to delete promotion")}async function mt(i,d,_){const g=new URLSearchParams({start_datetime:d,end_datetime:_}),R=await T(`${k()}/store_credit_events/sources?${g}`,i);if(!R.ok)throw new Error("Failed to fetch order sources");return R.json()}async function _t(i,d){const _=await T(`${k()}/store_credit_events/preview`,i,{method:"POST",body:JSON.stringify(d)});if(!_.ok)throw new Error("Failed to preview event");return _.json()}async function xt(i,d){const _=await T(`${k()}/store_credit_events/run`,i,{method:"POST",body:JSON.stringify(d)});if(!_.ok)throw new Error("Failed to run event");return _.json()}function gt(){const i=new Date,d=new Date(i.getTime()+10080*60*1e3);return{starts_at:i.toISOString().slice(0,16),ends_at:d.toISOString().slice(0,16)}}function Tt({shop:i}){const d=Xe(),[_,g]=u.useState(!1),[R,z]=u.useState(!1),[L,ne]=u.useState(null),[se,we]=u.useState(null),[A,ie]=u.useState("promotions"),v=at(),[ze,q]=u.useState(!1),[f,I]=u.useState(null),[j,B]=u.useState(null),[o,S]=u.useState({start_datetime:"",end_datetime:"",sources:[],credit_percent:10,include_authorized:!0,credit_expiration_days:""}),[Te,ae]=u.useState([]),[n,c]=u.useState(()=>{const t=gt();return{name:"",description:"",code:"",promo_type:"trade_in_bonus",bonus_percent:10,bonus_flat:0,multiplier:1,starts_at:t.starts_at,ends_at:t.ends_at,daily_start_time:"",daily_end_time:"",active_days:[],channel:"all",collection_ids:[],vendor_filter:[],product_type_filter:[],product_tags_filter:[],tier_restriction:[],min_value:"",stackable:!0,max_uses:"",max_uses_per_member:"",active:!0,credit_expiration_days:""}}),[re,oe]=u.useState(""),[le,ce]=u.useState(""),[de,ue]=u.useState(""),[he,pe]=u.useState(""),{data:$}=Je(i),{data:W}=Ye(i),{data:U}=Ze(i),{data:H}=et(i),qe=u.useMemo(()=>{if(!$?.collections)return[];const t=(re||"").toLowerCase();return(t?$.collections.filter(a=>(a?.title||"").toLowerCase().includes(t)):$.collections).filter(a=>a?.title).map(a=>({value:a.id,label:a.title}))},[$,re]),Be=u.useMemo(()=>{if(!W?.vendors)return[];const t=(le||"").toLowerCase();return(t?W.vendors.filter(a=>(a||"").toLowerCase().includes(t)):W.vendors).filter(a=>a).map(a=>({value:a,label:a}))},[W,le]),We=u.useMemo(()=>{if(!U?.product_types)return[];const t=(de||"").toLowerCase();return(t?U.product_types.filter(a=>(a||"").toLowerCase().includes(t)):U.product_types).filter(a=>a).map(a=>({value:a,label:a}))},[U,de]),Ue=u.useMemo(()=>{if(!H?.tags)return[];const t=(he||"").toLowerCase();return(t?H.tags.filter(a=>(a||"").toLowerCase().includes(t)):H.tags).filter(a=>a).map(a=>({value:a,label:a}))},[H,he]),{data:He,isLoading:Ge,error:Ke}=ye({queryKey:["promotions",i],queryFn:()=>lt(i),enabled:!!i,staleTime:3e4,gcTime:6e4,retry:1}),{data:G,isLoading:Ve}=ye({queryKey:["tiers",i],queryFn:()=>ct(i),enabled:!!i,staleTime:6e4,gcTime:12e4,retry:1}),{data:K}=ye({queryKey:["promotions-stats",i],queryFn:()=>dt(i),enabled:!!i,staleTime:3e4,gcTime:6e4,retry:1}),me=M({mutationFn:t=>ut(i,t),onSuccess:()=>{d.invalidateQueries({queryKey:["promotions"]}),g(!1),Q()}}),_e=M({mutationFn:({id:t,data:l})=>ht(i,t,l),onSuccess:()=>{d.invalidateQueries({queryKey:["promotions"]}),g(!1),ne(null),Q()}}),ke=M({mutationFn:t=>pt(i,t),onSuccess:()=>{d.invalidateQueries({queryKey:["promotions"]}),z(!1),we(null)}}),xe=M({mutationFn:()=>_t(i,{start_datetime:o.start_datetime,end_datetime:o.end_datetime,sources:o.sources,credit_percent:o.credit_percent,include_authorized:o.include_authorized}),onSuccess:t=>{I(t),B(null)}}),Pe=M({mutationFn:()=>xt(i,{start_datetime:o.start_datetime,end_datetime:o.end_datetime,sources:o.sources,credit_percent:o.credit_percent,include_authorized:o.include_authorized,expires_at:o.credit_expiration_days?new Date(Date.now()+parseInt(o.credit_expiration_days)*24*60*60*1e3).toISOString():void 0}),onSuccess:t=>{B(t),I(null),d.invalidateQueries({queryKey:["promotions-stats"]})}}),ge=M({mutationFn:()=>mt(i,o.start_datetime,o.end_datetime),onSuccess:t=>{ae(t.sources)}}),je=u.useCallback(()=>{S({start_datetime:"",end_datetime:"",sources:[],credit_percent:10,include_authorized:!0,credit_expiration_days:""}),I(null),B(null),ae([])},[]),V=u.useCallback(t=>{const l=new Date,a=t?new Date(l.getTime()+t*60*60*1e3):new Date(l.getTime()+10800*1e3);S({start_datetime:l.toISOString().slice(0,16),end_datetime:a.toISOString().slice(0,16),sources:[],credit_percent:10,include_authorized:!0,credit_expiration_days:""}),I(null),B(null),ae([]),q(!0)},[]),De=u.useCallback((t,l)=>{const a={...o,[t]:l};S(a),a.start_datetime&&a.end_datetime&&ge.mutate()},[o,ge]),Q=u.useCallback(()=>{c({name:"",description:"",code:"",promo_type:"trade_in_bonus",bonus_percent:10,bonus_flat:0,multiplier:1,starts_at:new Date().toISOString().slice(0,16),ends_at:new Date(Date.now()+10080*60*1e3).toISOString().slice(0,16),daily_start_time:"",daily_end_time:"",active_days:[],channel:"all",collection_ids:[],vendor_filter:[],product_type_filter:[],product_tags_filter:[],tier_restriction:[],min_value:"",stackable:!0,max_uses:"",max_uses_per_member:"",active:!0,credit_expiration_days:""}),oe(""),ce(""),ue(""),pe("")},[]),fe=u.useCallback(()=>{ne(null),Q(),g(!0)},[Q]),Ee=u.useCallback(t=>{ne(t),c({name:t.name,description:t.description||"",code:t.code||"",promo_type:t.promo_type,bonus_percent:t.bonus_percent,bonus_flat:t.bonus_flat,multiplier:t.multiplier,starts_at:t.starts_at?.slice(0,16)||"",ends_at:t.ends_at?.slice(0,16)||"",daily_start_time:t.daily_start_time||"",daily_end_time:t.daily_end_time||"",active_days:t.active_days?t.active_days.split(","):[],channel:t.channel,collection_ids:t.collection_ids||[],vendor_filter:t.vendor_filter||[],product_type_filter:t.product_type_filter||[],product_tags_filter:t.product_tags_filter||t.category_ids||[],tier_restriction:t.tier_restriction||[],min_value:t.min_value?.toString()||"",stackable:t.stackable,max_uses:t.max_uses?.toString()||"",max_uses_per_member:t.max_uses_per_member?.toString()||"",active:t.active,credit_expiration_days:t.credit_expiration_days?.toString()||""}),oe(""),ce(""),ue(""),pe(""),g(!0)},[]),Ae=u.useCallback(t=>{we(t),z(!0)},[]),Qe=u.useCallback(()=>{const t={name:n.name,description:n.description||null,code:n.code||null,promo_type:n.promo_type,bonus_percent:n.bonus_percent,bonus_flat:n.bonus_flat,multiplier:n.multiplier,starts_at:n.starts_at,ends_at:n.ends_at,channel:n.channel,stackable:n.stackable,active:n.active,active_days:n.active_days.length>0?n.active_days.join(","):null,daily_start_time:n.daily_start_time||null,daily_end_time:n.daily_end_time||null,collection_ids:n.collection_ids.length>0?n.collection_ids:null,vendor_filter:n.vendor_filter.length>0?n.vendor_filter:null,product_type_filter:n.product_type_filter.length>0?n.product_type_filter:null,product_tags_filter:n.product_tags_filter.length>0?n.product_tags_filter:null,tier_restriction:n.tier_restriction.length>0?n.tier_restriction:null,min_value:n.min_value?parseFloat(n.min_value):0,max_uses:n.max_uses?parseInt(n.max_uses):null,max_uses_per_member:n.max_uses_per_member?parseInt(n.max_uses_per_member):null,credit_expiration_days:n.credit_expiration_days?parseInt(n.credit_expiration_days):null};L?_e.mutate({id:L.id,data:t}):me.mutate(t)},[n,L,me,_e]),w=t=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t),Me=t=>t?t.active?t.is_active_now?e.jsx(m,{tone:"success",children:"Active Now"}):t.starts_at&&new Date(t.starts_at)>new Date?e.jsx(m,{tone:"info",children:"Scheduled"}):e.jsx(m,{tone:"warning",children:"Ended"}):e.jsx(m,{children:"Disabled"}):e.jsx(m,{children:"Unknown"}),Fe=t=>t?t.promo_type==="flat_bonus"?`${w(t.bonus_flat??0)} flat`:t.promo_type==="multiplier"?`${t.multiplier??1}x multiplier`:`+${t.bonus_percent??0}% bonus`:"—";if(!i)return e.jsx(J,{title:"Promotions",children:e.jsx(E,{tone:"warning",children:e.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})});if(Ge||Ve)return e.jsx(J,{title:"Promotions & Bonuses",subtitle:"Loading your promotions...",children:e.jsxs(C,{children:[e.jsx(C.Section,{children:e.jsx(N,{columns:v?2:4,gap:"400",children:[1,2,3,4].map(t=>e.jsx(p,{children:e.jsxs(r,{gap:"200",children:[e.jsx(b,{background:"bg-surface-secondary",borderRadius:"100",minHeight:"16px",maxWidth:"80px"}),e.jsx(b,{background:"bg-surface-secondary",borderRadius:"100",minHeight:"32px",maxWidth:"60px"})]})},t))})}),e.jsx(C.Section,{children:e.jsxs(h,{gap:"200",children:[e.jsx(b,{background:"bg-surface-secondary",borderRadius:"200",minHeight:"32px",minWidth:"120px"}),e.jsx(b,{background:"bg-surface-secondary",borderRadius:"200",minHeight:"32px",minWidth:"120px"})]})}),e.jsx(C.Section,{children:e.jsx(p,{children:e.jsx(r,{gap:"400",children:[1,2,3].map(t=>e.jsx(b,{paddingBlock:"300",children:e.jsxs(h,{gap:"400",blockAlign:"center",children:[e.jsx(b,{background:"bg-surface-secondary",borderRadius:"100",minHeight:"20px",minWidth:"150px"}),e.jsx(b,{background:"bg-surface-secondary",borderRadius:"100",minHeight:"20px",minWidth:"100px"}),e.jsx(b,{background:"bg-surface-secondary",borderRadius:"100",minHeight:"20px",minWidth:"80px"}),e.jsx(b,{background:"bg-surface-secondary",borderRadius:"100",minHeight:"20px",minWidth:"60px"})]})},t))})})})]})});if(Ke)return e.jsx(J,{title:"Promotions",children:e.jsx(E,{tone:"critical",children:e.jsx("p",{children:"Failed to load promotions. Please try refreshing the page."})})});const X=He?.promotions||[],be=G?.tiers||[];return e.jsxs(e.Fragment,{children:[e.jsx(it,{title:"Promotions",children:e.jsx("button",{variant:"primary",onClick:fe,children:"New promotion"})}),e.jsxs(J,{title:"Promotions & Bonuses",subtitle:"Create special offers and manage tier benefits",primaryAction:{content:"New Promotion",icon:Oe,onAction:fe},children:[e.jsxs(C,{children:[e.jsx(C.Section,{children:e.jsxs(N,{columns:v?2:4,gap:"400",children:[e.jsx(p,{children:e.jsxs(r,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",tone:"subdued",children:"Active Promos"}),e.jsx(s,{as:"p",variant:v?"headingLg":"headingXl",children:K?.active_promotions||0})]})}),e.jsx(p,{children:e.jsxs(r,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",tone:"subdued",children:"Ending Soon"}),e.jsx(s,{as:"p",variant:v?"headingLg":"headingXl",children:K?.promotions_ending_soon||0})]})}),e.jsx(p,{children:e.jsxs(r,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",tone:"subdued",children:"Cashback (30d)"}),e.jsx(s,{as:"p",variant:v?"headingLg":"headingXl",children:w(K?.total_cashback_30d||0)})]})}),e.jsx(p,{children:e.jsxs(r,{gap:"200",children:[e.jsx(s,{as:"h3",variant:"headingSm",tone:"subdued",children:"Bulk Credits (30d)"}),e.jsx(s,{as:"p",variant:v?"headingLg":"headingXl",children:w(K?.total_bulk_credits_30d||0)})]})})]})}),e.jsx(C.Section,{children:e.jsxs(h,{gap:"200",wrap:!0,children:[e.jsx(y,{pressed:A==="promotions",onClick:()=>ie("promotions"),children:`Promotions (${X.length})`}),e.jsx(y,{pressed:A==="tiers",onClick:()=>ie("tiers"),children:`Tier Benefits (${be.length})`}),e.jsx(y,{pressed:A==="events",onClick:()=>ie("events"),children:"Store Credit Events"})]})}),A==="promotions"&&e.jsx(C.Section,{children:e.jsx(p,{children:X.length>0?v?e.jsx(b,{padding:"300",children:e.jsx(r,{gap:"300",children:X.filter(t=>t&&t.id!=null).map((t,l)=>e.jsxs(b,{children:[l>0&&e.jsx(P,{}),e.jsx(b,{paddingBlock:"300",children:e.jsxs(r,{gap:"200",children:[e.jsxs(h,{align:"space-between",blockAlign:"start",children:[e.jsxs(r,{gap:"100",children:[e.jsx(s,{as:"span",fontWeight:"semibold",children:t.name||"Untitled"}),t.code&&e.jsx(m,{size:"small",children:String(t.code)})]}),Me(t)]}),e.jsxs(h,{gap:"200",wrap:!0,children:[e.jsx(m,{tone:"info",children:String(Ce.find(a=>a.value===t.promo_type)?.label||t.promo_type||"Promotion")}),e.jsx(s,{as:"span",variant:"bodySm",fontWeight:"medium",children:Fe(t)})]}),e.jsxs(h,{gap:"300",wrap:!0,children:[e.jsxs(s,{as:"span",variant:"bodySm",tone:"subdued",children:[t.starts_at?new Date(t.starts_at).toLocaleDateString():"—"," - ",t.ends_at?new Date(t.ends_at).toLocaleDateString():"—"]}),e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:t.max_uses?`${t.current_uses||0} / ${t.max_uses} uses`:`${t.current_uses||0} uses`})]}),e.jsxs(h,{gap:"200",children:[e.jsx(y,{size:"slim",icon:Le,onClick:()=>Ee(t),accessibilityLabel:`Edit ${t.name}`,children:"Edit"}),e.jsx(y,{size:"slim",icon:Ie,tone:"critical",onClick:()=>Ae(t),accessibilityLabel:`Delete ${t.name}`,children:"Delete"})]})]})})]},t.id))})}):e.jsx($e,{columnContentTypes:["text","text","text","text","text","text","text"],headings:["Name","Type","Value","Schedule","Usage","Status","Actions"],rows:X.filter(t=>t&&t.id!=null).map(t=>[e.jsxs(r,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodyMd",fontWeight:"semibold",children:t.name||"Untitled"}),t.code&&e.jsx(m,{children:String(t.code)})]},t.id),Ce.find(l=>l.value===t.promo_type)?.label||t.promo_type||"Promotion",Fe(t),e.jsxs(s,{as:"span",variant:"bodySm",children:[t.starts_at?new Date(t.starts_at).toLocaleDateString():"—"," - ",t.ends_at?new Date(t.ends_at).toLocaleDateString():"—"]},t.id),e.jsx(s,{as:"span",variant:"bodySm",children:t.max_uses?`${t.current_uses||0} / ${t.max_uses}`:t.current_uses?`${t.current_uses} uses`:"0 uses"},`usage-${t.id}`),Me(t),e.jsxs(h,{gap:"200",children:[e.jsx(y,{size:"slim",icon:Le,onClick:()=>Ee(t),accessibilityLabel:`Edit ${t.name}`}),e.jsx(y,{size:"slim",icon:Ie,tone:"critical",onClick:()=>Ae(t),accessibilityLabel:`Delete ${t.name}`})]},t.id)])}):e.jsx(Ne,{heading:"No promotions yet",action:{content:"Create your first promotion",onAction:fe},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Create promotions to offer bonuses and special deals to your members."})})})}),A==="tiers"&&e.jsx(C.Section,{children:be.length===0?e.jsx(p,{children:e.jsx(Ne,{heading:"No membership tiers configured",action:{content:"Create Tiers",url:"/app/tiers"},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:"Configure membership tiers to offer different benefit levels to your customers. Tiers can include trade-in bonuses, purchase cashback, and store discounts."})})}):e.jsx(N,{columns:v?1:3,gap:"400",children:be.filter(t=>t&&t.tier_name).map(t=>e.jsx(p,{children:e.jsxs(r,{gap:"300",children:[e.jsxs(h,{align:"space-between",children:[e.jsx(s,{as:"h3",variant:"headingMd",children:String(t.tier_name||"").toUpperCase()||"UNKNOWN"}),e.jsx(m,{tone:t.active?"success":void 0,children:t.active?"Active":"Inactive"})]}),e.jsxs(s,{as:"p",variant:"headingLg",children:[w(t.monthly_price??0),"/mo"]}),e.jsx(P,{}),e.jsxs(r,{gap:"200",children:[e.jsxs(h,{align:"space-between",children:[e.jsx(s,{as:"span",variant:"bodySm",children:"Trade-In Bonus"}),e.jsx(m,{tone:"success",children:`+${t.trade_in_bonus_pct??0}%`})]}),e.jsxs(h,{align:"space-between",children:[e.jsx(s,{as:"span",variant:"bodySm",children:"Purchase Cashback"}),e.jsx(m,{tone:"info",children:`${t.purchase_cashback_pct??0}%`})]}),e.jsxs(h,{align:"space-between",children:[e.jsx(s,{as:"span",variant:"bodySm",children:"Store Discount"}),e.jsx(m,{children:`${t.store_discount_pct??0}%`})]})]}),t.features&&t.features.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(P,{}),e.jsx(r,{gap:"100",children:t.features.filter(l=>l).map((l,a)=>e.jsx(s,{as:"p",variant:"bodySm",children:l},a))})]})]})},t.id))})}),A==="events"&&e.jsx(C.Section,{children:e.jsxs(r,{gap:"400",children:[e.jsx(p,{children:e.jsxs(r,{gap:"400",children:[e.jsxs(h,{align:"space-between",blockAlign:"center",children:[e.jsxs(r,{gap:"100",children:[e.jsx(s,{as:"h3",variant:"headingMd",children:"Quick Start Templates"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Use a template or create a custom event"})]}),e.jsx(y,{icon:Oe,variant:"primary",onClick:()=>V(),children:"Custom Event"})]}),e.jsxs(N,{columns:v?1:3,gap:"300",children:[e.jsx(p,{children:e.jsxs(r,{gap:"200",children:[e.jsx(s,{as:"h4",variant:"headingSm",children:"Trade Night"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"10% store credit on all purchases during Trade Night hours"}),e.jsx(s,{as:"p",variant:"bodySm",children:"Duration: 3 hours"}),e.jsx(y,{size:"slim",onClick:()=>{V(3),S(t=>({...t,credit_percent:10}))},children:"Use Template"})]})}),e.jsx(p,{children:e.jsxs(r,{gap:"200",children:[e.jsx(s,{as:"h4",variant:"headingSm",children:"Grand Opening"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"15% store credit on opening day purchases"}),e.jsx(s,{as:"p",variant:"bodySm",children:"Duration: 24 hours"}),e.jsx(y,{size:"slim",onClick:()=>{V(24),S(t=>({...t,credit_percent:15}))},children:"Use Template"})]})}),e.jsx(p,{children:e.jsxs(r,{gap:"200",children:[e.jsx(s,{as:"h4",variant:"headingSm",children:"Weekend Sale"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"5% store credit on weekend purchases"}),e.jsx(s,{as:"p",variant:"bodySm",children:"Duration: 48 hours"}),e.jsx(y,{size:"slim",onClick:()=>{V(48),S(t=>({...t,credit_percent:5}))},children:"Use Template"})]})})]})]})}),e.jsx(p,{children:e.jsxs(r,{gap:"300",children:[e.jsx(s,{as:"h3",variant:"headingMd",children:"How Store Credit Events Work"}),e.jsxs(r,{gap:"200",children:[e.jsxs(h,{gap:"200",blockAlign:"start",children:[e.jsx(m,{tone:"info",children:"1"}),e.jsxs(s,{as:"p",variant:"bodySm",children:[e.jsx("strong",{children:"Set Date Range:"})," Choose the start and end time for your event"]})]}),e.jsxs(h,{gap:"200",blockAlign:"start",children:[e.jsx(m,{tone:"info",children:"2"}),e.jsxs(s,{as:"p",variant:"bodySm",children:[e.jsx("strong",{children:"Select Sources:"})," Choose which order sources (POS, Web, etc.) to include"]})]}),e.jsxs(h,{gap:"200",blockAlign:"start",children:[e.jsx(m,{tone:"info",children:"3"}),e.jsxs(s,{as:"p",variant:"bodySm",children:[e.jsx("strong",{children:"Preview (Dry Run):"})," See exactly how much credit will be issued before applying"]})]}),e.jsxs(h,{gap:"200",blockAlign:"start",children:[e.jsx(m,{tone:"success",children:"4"}),e.jsxs(s,{as:"p",variant:"bodySm",children:[e.jsx("strong",{children:"Run Event:"})," Apply store credit to all qualifying customers"]})]})]})]})})]})})]}),e.jsx(F,{open:_,onClose:()=>g(!1),title:L?"Edit Promotion":"New Promotion",primaryAction:{content:L?"Save Changes":"Create Promotion",onAction:Qe,loading:me.isPending||_e.isPending},secondaryActions:[{content:"Cancel",onAction:()=>g(!1)}],children:e.jsx(F.Section,{children:e.jsxs(O,{children:[e.jsx(x,{label:"Promotion Name",value:n.name,onChange:t=>c({...n,name:t}),autoComplete:"off",requiredIndicator:!0}),e.jsx(x,{label:"Description",value:n.description,onChange:t=>c({...n,description:t}),multiline:2,autoComplete:"off"}),e.jsx(x,{label:"Promo Code (optional)",value:n.code,onChange:t=>c({...n,code:(t||"").toUpperCase()}),autoComplete:"off",helpText:"Leave empty for automatic promotions"}),e.jsx(Y,{label:"Promotion Type",options:Ce,value:n.promo_type,onChange:t=>c({...n,promo_type:t})}),n.promo_type==="flat_bonus"?e.jsx(x,{label:"Flat Bonus Amount",type:"number",value:n.bonus_flat.toString(),onChange:t=>c({...n,bonus_flat:parseFloat(t)||0}),prefix:"$",autoComplete:"off"}):n.promo_type==="multiplier"?e.jsx(x,{label:"Multiplier",type:"number",value:n.multiplier.toString(),onChange:t=>c({...n,multiplier:parseFloat(t)||1}),suffix:"x",autoComplete:"off"}):e.jsx(x,{label:"Bonus Percentage",type:"number",value:n.bonus_percent.toString(),onChange:t=>c({...n,bonus_percent:parseFloat(t)||0}),suffix:"%",autoComplete:"off"}),e.jsxs(O.Group,{children:[e.jsx(x,{label:"Starts At",type:"datetime-local",value:n.starts_at,onChange:t=>c({...n,starts_at:t}),autoComplete:"off",requiredIndicator:!0}),e.jsx(x,{label:"Ends At",type:"datetime-local",value:n.ends_at,onChange:t=>c({...n,ends_at:t}),autoComplete:"off",requiredIndicator:!0})]}),e.jsx(P,{}),e.jsx(s,{as:"h3",variant:"headingSm",children:"Advanced Scheduling"}),e.jsxs(O.Group,{children:[e.jsx(x,{label:"Daily Start Time",type:"time",value:n.daily_start_time,onChange:t=>c({...n,daily_start_time:t}),autoComplete:"off",helpText:"e.g., 18:00 for 6 PM"}),e.jsx(x,{label:"Daily End Time",type:"time",value:n.daily_end_time,onChange:t=>c({...n,daily_end_time:t}),autoComplete:"off",helpText:"e.g., 21:00 for 9 PM"})]}),e.jsx(ve,{title:"Active Days (optional)",choices:ot,selected:n.active_days,onChange:t=>c({...n,active_days:t}),allowMultiple:!0}),e.jsx(P,{}),e.jsx(s,{as:"h3",variant:"headingSm",children:"Product Eligibility Filters"}),e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Leave empty to apply to all products. Multiple selections use AND logic."}),e.jsxs(r,{gap:"200",children:[e.jsx(D,{options:qe,selected:n.collection_ids,onSelect:t=>c({...n,collection_ids:t}),textField:e.jsx(D.TextField,{label:"Collections",value:re,onChange:oe,placeholder:"Search collections...",prefix:e.jsx(Z,{source:ee}),autoComplete:"off"}),allowMultiple:!0}),n.collection_ids.length>0&&e.jsx(h,{gap:"100",wrap:!0,children:n.collection_ids.filter(t=>t).map(t=>{const l=$?.collections?.find(a=>a&&a.id===t);return e.jsx(te,{onRemove:()=>c({...n,collection_ids:n.collection_ids.filter(a=>a!==t)}),children:l?.title||t},t)})})]}),e.jsxs(r,{gap:"200",children:[e.jsx(D,{options:Be,selected:n.vendor_filter,onSelect:t=>c({...n,vendor_filter:t}),textField:e.jsx(D.TextField,{label:"Vendors/Brands",value:le,onChange:ce,placeholder:"Search vendors...",prefix:e.jsx(Z,{source:ee}),autoComplete:"off"}),allowMultiple:!0}),n.vendor_filter.length>0&&e.jsx(h,{gap:"100",wrap:!0,children:n.vendor_filter.filter(t=>t).map(t=>e.jsx(te,{onRemove:()=>c({...n,vendor_filter:n.vendor_filter.filter(l=>l!==t)}),children:t},t))})]}),e.jsxs(r,{gap:"200",children:[e.jsx(D,{options:We,selected:n.product_type_filter,onSelect:t=>c({...n,product_type_filter:t}),textField:e.jsx(D.TextField,{label:"Product Types",value:de,onChange:ue,placeholder:"Search product types...",prefix:e.jsx(Z,{source:ee}),autoComplete:"off"}),allowMultiple:!0}),n.product_type_filter.length>0&&e.jsx(h,{gap:"100",wrap:!0,children:n.product_type_filter.filter(t=>t).map(t=>e.jsx(te,{onRemove:()=>c({...n,product_type_filter:n.product_type_filter.filter(l=>l!==t)}),children:t},t))})]}),e.jsxs(r,{gap:"200",children:[e.jsx(D,{options:Ue,selected:n.product_tags_filter,onSelect:t=>c({...n,product_tags_filter:t}),textField:e.jsx(D.TextField,{label:"Product Tags",value:he,onChange:pe,placeholder:"Search tags...",prefix:e.jsx(Z,{source:ee}),autoComplete:"off"}),allowMultiple:!0}),n.product_tags_filter.length>0&&e.jsx(h,{gap:"100",wrap:!0,children:n.product_tags_filter.filter(t=>t).map(t=>e.jsx(te,{onRemove:()=>c({...n,product_tags_filter:n.product_tags_filter.filter(l=>l!==t)}),children:t},t))})]}),e.jsx(P,{}),e.jsx(s,{as:"h3",variant:"headingSm",children:"Additional Restrictions"}),e.jsx(Y,{label:"Channel",options:rt,value:n.channel,onChange:t=>c({...n,channel:t})}),G?.tiers&&G.tiers.length>0&&e.jsx(ve,{title:"Tier Restriction (optional)",choices:G.tiers.filter(t=>t&&t.tier_name).map(t=>({label:t.tier_name||"",value:String(t.tier_name||"").toUpperCase()})),selected:n.tier_restriction,onChange:t=>c({...n,tier_restriction:t}),allowMultiple:!0}),e.jsxs(O.Group,{children:[e.jsx(x,{label:"Min Order Value",type:"number",value:n.min_value,onChange:t=>c({...n,min_value:t}),prefix:"$",autoComplete:"off",helpText:"Minimum order to apply promo"}),e.jsx(x,{label:"Max Uses (optional)",type:"number",value:n.max_uses,onChange:t=>c({...n,max_uses:t}),autoComplete:"off",helpText:"Total uses allowed"})]}),e.jsx(x,{label:"Max Uses Per Member (optional)",type:"number",value:n.max_uses_per_member,onChange:t=>c({...n,max_uses_per_member:t}),autoComplete:"off",helpText:"Limit how many times each member can use this promo"}),e.jsx(P,{}),e.jsx(s,{as:"h3",variant:"headingSm",children:"Credit Settings"}),e.jsx(Y,{label:"Credit Expiration",options:Re,value:n.credit_expiration_days,onChange:t=>c({...n,credit_expiration_days:t}),helpText:"How long before credits from this promotion expire"}),e.jsx(Se,{label:"Stackable with other promotions",checked:n.stackable,onChange:t=>c({...n,stackable:t})}),e.jsx(Se,{label:"Active",checked:n.active,onChange:t=>c({...n,active:t})})]})})}),e.jsx(F,{open:R,onClose:()=>z(!1),title:"Delete Promotion",primaryAction:{content:"Delete",destructive:!0,onAction:()=>se&&ke.mutate(se.id),loading:ke.isPending},secondaryActions:[{content:"Cancel",onAction:()=>z(!1)}],children:e.jsx(F.Section,{children:e.jsxs(s,{as:"p",children:['Are you sure you want to delete "',se?.name,'"? This action cannot be undone.']})})}),e.jsx(F,{open:ze,onClose:()=>{q(!1),je()},title:"Create Store Credit Event",size:"large",primaryAction:f&&!j?{content:"Apply Credits",icon:tt,onAction:()=>Pe.mutate(),loading:Pe.isPending}:j?{content:"Done",onAction:()=>{q(!1),je()}}:{content:"Preview (Dry Run)",icon:nt,onAction:()=>xe.mutate(),loading:xe.isPending,disabled:!o.start_datetime||!o.end_datetime||o.sources.length===0},secondaryActions:j?[]:[{content:"Cancel",onAction:()=>{q(!1),je()}}],children:e.jsx(F.Section,{children:j?e.jsxs(r,{gap:"400",children:[e.jsx(E,{title:j.success_count>0?"Event Completed Successfully!":"Event Completed",tone:j.failure_count>0?"warning":"success",children:e.jsxs("p",{children:["Issued ",w(j.total_credit_issued)," in store credit to ",j.success_count," customers.",j.failure_count>0&&` ${j.failure_count} failed.`]})}),j.errors&&j.errors.length>0&&e.jsx(p,{children:e.jsxs(r,{gap:"200",children:[e.jsx(s,{as:"h4",variant:"headingSm",tone:"critical",children:"Errors"}),j.errors.filter(t=>t).map((t,l)=>e.jsx(s,{as:"p",variant:"bodySm",children:t},l))]})})]}):f?e.jsxs(r,{gap:"400",children:[e.jsx(E,{title:"Preview Results",tone:"info",children:e.jsx("p",{children:'This is a dry run. No credits have been issued yet. Review the data below and click "Apply Credits" to proceed.'})}),e.jsxs(N,{columns:v?2:4,gap:"300",children:[e.jsx(p,{children:e.jsxs(r,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Total Orders"}),e.jsx(s,{as:"p",variant:"headingLg",children:f.summary.total_orders})]})}),e.jsx(p,{children:e.jsxs(r,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Unique Customers"}),e.jsx(s,{as:"p",variant:"headingLg",children:f.summary.unique_customers})]})}),e.jsx(p,{children:e.jsxs(r,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Total Order Value"}),e.jsx(s,{as:"p",variant:"headingLg",children:w(f.summary.total_order_value)})]})}),e.jsx(p,{children:e.jsxs(r,{gap:"100",children:[e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Credit to Issue"}),e.jsx(s,{as:"p",variant:"headingLg",tone:"success",children:w(f.summary.total_credit_to_issue)})]})})]}),f.top_customers&&f.top_customers.length>0&&e.jsx(p,{children:e.jsxs(r,{gap:"300",children:[e.jsx(s,{as:"h4",variant:"headingSm",children:"Top Customers by Credit Amount"}),e.jsx($e,{columnContentTypes:["text","text","numeric","numeric","numeric"],headings:["Customer","Email","Orders","Spent","Credit"],rows:f.top_customers.slice(0,10).filter(t=>t&&t.customer_id!=null).map(t=>[t.name||"Guest",t.email||"-",t.order_count||0,w(t.total_spent||0),e.jsx(m,{tone:"success",children:String(w(t.credit_amount||0))},t.customer_id)])})]})}),f.orders_by_source&&Object.keys(f.orders_by_source).length>0&&e.jsx(p,{children:e.jsxs(r,{gap:"200",children:[e.jsx(s,{as:"h4",variant:"headingSm",children:"Orders by Source"}),e.jsx(h,{gap:"200",wrap:!0,children:Object.entries(f.orders_by_source).filter(([t])=>t).map(([t,l])=>e.jsx(m,{tone:"info",children:`${t}: ${l||0}`},t))})]})}),e.jsx(y,{onClick:()=>I(null),variant:"plain",children:"← Back to Edit"})]}):e.jsxs(O,{children:[e.jsx(E,{tone:"info",children:e.jsx("p",{children:'Set up your store credit event. After configuring, click "Preview (Dry Run)" to see exactly how much credit will be issued before applying.'})}),e.jsxs(O.Group,{children:[e.jsx(x,{label:"Start Date & Time",type:"datetime-local",value:o.start_datetime,onChange:t=>De("start_datetime",t),autoComplete:"off",requiredIndicator:!0,helpText:"When should orders start qualifying?"}),e.jsx(x,{label:"End Date & Time",type:"datetime-local",value:o.end_datetime,onChange:t=>De("end_datetime",t),autoComplete:"off",requiredIndicator:!0,helpText:"When should orders stop qualifying?"})]}),e.jsx(x,{label:"Credit Percentage",type:"number",value:o.credit_percent.toString(),onChange:t=>S({...o,credit_percent:parseFloat(t)||0}),suffix:"%",autoComplete:"off",helpText:"Percentage of order total to issue as store credit"}),e.jsxs(r,{gap:"200",children:[e.jsxs(s,{as:"span",variant:"bodyMd",children:["Order Sources ",e.jsx(s,{as:"span",tone:"critical",children:"*"})]}),ge.isPending?e.jsxs(h,{gap:"200",blockAlign:"center",children:[e.jsx(st,{size:"small"}),e.jsx(s,{as:"span",variant:"bodySm",tone:"subdued",children:"Loading available sources..."})]}):Te.length>0?e.jsx(ve,{title:"",choices:Te.filter(t=>t&&t.name).map(t=>({label:`${t.name} (${t.count||0} orders)`,value:t.name})),selected:o.sources,onChange:t=>S({...o,sources:t}),allowMultiple:!0}):o.start_datetime&&o.end_datetime?e.jsx(E,{tone:"warning",children:e.jsx("p",{children:"No orders found in this date range. Try adjusting the dates."})}):e.jsx(s,{as:"p",variant:"bodySm",tone:"subdued",children:"Select start and end dates to see available order sources."})]}),e.jsx(P,{}),e.jsx(Y,{label:"Credit Expiration",options:Re,value:o.credit_expiration_days,onChange:t=>S({...o,credit_expiration_days:t}),helpText:"How long before issued credits expire"}),e.jsx(Se,{label:"Include authorized (unpaid) orders",checked:o.include_authorized,onChange:t=>S({...o,include_authorized:t}),helpText:"Include orders that are authorized but not yet captured"}),xe.isError&&e.jsx(E,{tone:"critical",children:e.jsx("p",{children:"Failed to preview event. Please check your configuration and try again."})})]})})})]})]})}export{Tt as EmbeddedPromotions};
