import{u as W,j as e,b as me,c as z}from"./vendor-query-Bq4hz6H9.js";import{r as a}from"./vendor-router-CdtyvhQv.js";import{a as E,g as _}from"./index-B6-oWjXE.js";import{P as xe,B as j,G as ge,H as ve,k as we,J as Ce,v as _e,L as pe,C as se,b as F,K as Te,h as f,l as re,a as r,z as ye,c as J,T as t,t as H,D as be,N as ke,E as Ae,M as p,e as oe,f as he,g as Q,I as Ee,O as Fe,Q as je,U as Me,V as ae}from"./vendor-polaris-1WqYVNpP.js";import{T as Ne}from"./vendor-appbridge-DL6abzKC.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";const $e=[{label:"Never expires",value:""},{label:"30 days",value:"30"},{label:"60 days",value:"60"},{label:"90 days",value:"90"},{label:"180 days",value:"180"},{label:"1 year (365 days)",value:"365"}];async function Ie(s){const l=await E(`${_()}/members/tiers`,s);if(!l.ok)throw new Error("Failed to fetch tiers");return l.json()}async function Oe(s){const l=await E(`${_()}/settings`,s);if(!l.ok)throw new Error("Failed to fetch settings");return l.json()}async function De(s,l,c,g){const u=new URLSearchParams;u.set("page",String(l)),u.set("per_page","20"),c&&u.set("search",c),g&&u.set("tier",g);const x=await E(`${_()}/members?${u}`,s);if(!x.ok)throw new Error("Failed to fetch members");return x.json()}function Pe(s=768){const[l,c]=a.useState(typeof window<"u"?window.innerWidth<s:!1);return a.useEffect(()=>{const g=()=>c(window.innerWidth<s);return window.addEventListener("resize",g),()=>window.removeEventListener("resize",g)},[s]),l}function fe(s,l){const[c,g]=a.useState(s);return a.useEffect(()=>{const u=setTimeout(()=>g(s),l);return()=>clearTimeout(u)},[s,l]),c}function Je({shop:s}){const[l,c]=a.useState(1),[g,u]=a.useState(""),[x,d]=a.useState([]),[T,S]=a.useState(null),[I,O]=a.useState(!1),[D,w]=a.useState(!1),[M,N]=a.useState(!1),$=Pe(),v=fe(g,150),{data:y,isLoading:P,error:C,isFetching:h}=W({queryKey:["members",s,l,v,x[0]],queryFn:()=>De(s,l,v,x[0]||""),enabled:!!s,retry:1,staleTime:5e3,placeholderData:n=>n}),{data:m}=W({queryKey:["tiers",s],queryFn:()=>Ie(s),enabled:!!s,staleTime:6e4}),{data:o}=W({queryKey:["settings",s],queryFn:()=>Oe(s),enabled:!!s,staleTime:3e5}),k=o?.settings?.general?.timezone||"America/Los_Angeles",X=a.useCallback(n=>{u(n),c(1)},[]),U=a.useCallback(n=>{d(n),c(1)},[]),Z=a.useCallback(()=>{u(""),d([]),c(1)},[]),V=a.useCallback(()=>{if(!y?.members?.length)return;const n=["Name","Email","Tier","Status","Trade-Ins","Credits Issued","Member Since","Last Activity"],A=y.members.map(b=>[`${b.first_name||""} ${b.last_name||""}`.trim(),b.email||"",b.tier?.name||"None",b.status||"",b.trade_in_count||0,b.total_credits_issued||0,b.created_at?new Date(b.created_at).toLocaleDateString():"",b.last_trade_in_at?new Date(b.last_trade_in_at).toLocaleDateString():"Never"]),te=[n,...A].map(b=>b.map(ie=>`"${String(ie).replace(/"/g,'""')}"`).join(",")).join(`
`),ee=new Blob([te],{type:"text/csv;charset=utf-8;"}),ne=URL.createObjectURL(ee),G=document.createElement("a");G.href=ne,G.download=`tradeup-members-${new Date().toISOString().split("T")[0]}.csv`,document.body.appendChild(G),G.click(),document.body.removeChild(G),URL.revokeObjectURL(ne)},[y]),K=a.useCallback(n=>n?new Date(n).toLocaleDateString("en-US",{timeZone:k,month:"numeric",day:"numeric",year:"numeric"}):"Never",[k]);if(!s)return e.jsx(xe,{title:"Members",children:e.jsx(j,{tone:"warning",children:e.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})});const L=n=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(n||0),B=m?.tiers?m.tiers.filter(n=>n&&n.active&&n.name).map(n=>({label:n.name||"",value:String(n.name||"").toLowerCase()})):[],Y=B.length>0?[{key:"tier",label:"Tier",filter:e.jsx(ge,{title:"Tier",titleHidden:!0,choices:B,selected:x,onChange:U}),shortcut:!0}]:[],R=x.length>0?[{key:"tier",label:`Tier: ${x[0]}`,onRemove:()=>d([])}]:[];return e.jsxs(e.Fragment,{children:[e.jsx(Ne,{title:"Members",children:e.jsx("button",{variant:"primary",onClick:()=>w(!0),children:"Add member"})}),e.jsxs(xe,{title:"Members",subtitle:h&&g?"Searching...":`${y?.total||0} total members`,primaryAction:{content:"Add Member",icon:_e,onAction:()=>w(!0)},secondaryActions:[{content:"Import CSV",icon:ve,onAction:()=>N(!0)},{content:"Email Members",icon:we,onAction:()=>O(!0)},{content:"Export",icon:Ce,disabled:!y?.members?.length,onAction:V}],children:[e.jsxs(pe,{children:[C&&e.jsx(pe.Section,{children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:"Failed to load members. Please try refreshing the page."})})}),e.jsx(pe.Section,{children:e.jsxs(se,{padding:"0",children:[e.jsx(F,{padding:"400",children:e.jsx(Te,{queryValue:g,queryPlaceholder:"Search by name or email",onQueryChange:X,onQueryClear:()=>u(""),filters:Y,appliedFilters:R,onClearAll:Z})}),P?e.jsx(F,{padding:"1600",children:e.jsx(f,{align:"center",children:e.jsx(re,{size:"large"})})}):y?.members&&y.members.length>0?e.jsxs(e.Fragment,{children:[$?e.jsx(F,{padding:"300",children:e.jsx(r,{gap:"300",children:y.members.filter(n=>n&&n.id!=null).map((n,A)=>e.jsxs(F,{children:[A>0&&e.jsx(ye,{}),e.jsx(F,{paddingBlock:"300",children:e.jsxs(r,{gap:"200",children:[e.jsxs(f,{align:"space-between",blockAlign:"start",children:[e.jsxs(r,{gap:"050",children:[e.jsxs(J,{variant:"plain",onClick:()=>S(n),children:[n.first_name," ",n.last_name]}),e.jsx(t,{as:"p",variant:"bodySm",tone:"subdued",children:n.email})]}),e.jsxs(r,{gap:"100",inlineAlign:"end",children:[e.jsx(H,{tone:"info",children:String(n.tier?.name||"None")}),e.jsx(H,{tone:n.status==="active"?"success":void 0,children:String(n.status||"unknown")})]})]}),e.jsxs(f,{gap:"400",wrap:!0,children:[e.jsxs(r,{gap:"050",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Trade-Ins"}),e.jsx(t,{as:"span",fontWeight:"medium",children:n.trade_in_count})]}),e.jsxs(r,{gap:"050",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Credits"}),e.jsx(t,{as:"span",fontWeight:"medium",children:L(n.total_credits_issued)})]}),e.jsxs(r,{gap:"050",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Last Active"}),e.jsx(t,{as:"span",fontWeight:"medium",children:K(n.last_trade_in_at)})]})]})]})})]},n.id))})}):e.jsx(be,{columnContentTypes:["text","text","text","numeric","numeric","text"],headings:["Member","Tier","Status","Trade-Ins","Credits Issued","Last Activity"],rows:y.members.filter(n=>n&&n.id!=null).map(n=>[e.jsxs(r,{gap:"100",children:[e.jsxs(J,{variant:"plain",onClick:()=>S(n),children:[n.first_name||""," ",n.last_name||""]}),e.jsx(t,{as:"p",variant:"bodySm",tone:"subdued",children:n.email})]},n.id),e.jsx(H,{tone:"info",children:String(n.tier?.name||"None")},`tier-${n.id}`),e.jsx(H,{tone:n.status==="active"?"success":void 0,children:String(n.status||"unknown")},`status-${n.id}`),n.trade_in_count,L(n.total_credits_issued),K(n.last_trade_in_at)])}),e.jsx(F,{padding:"400",children:e.jsx(f,{align:"center",children:e.jsx(ke,{hasPrevious:l>1,onPrevious:()=>c(l-1),hasNext:l<(y?.pages||1),onNext:()=>c(l+1)})})})]}):e.jsx(F,{padding:"1600",children:e.jsx(Ae,{heading:"No members found",image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:e.jsx("p",{children:g||x.length>0?"Try adjusting your search or filters.":"Members will appear here when customers join your program."})})})]})})]}),e.jsx(qe,{member:T,shop:s,onClose:()=>S(null),onMemberUpdated:n=>S(n),formatCurrency:L,formatDate:K}),e.jsx(Le,{open:I,onClose:()=>O(!1),shop:s,tiers:m?.tiers}),e.jsx(Re,{open:D,onClose:()=>w(!1),shop:s}),e.jsx(Be,{open:M,onClose:()=>N(!1),shop:s})]})]})}function qe({member:s,shop:l,onClose:c,onMemberUpdated:g,formatCurrency:u,formatDate:x}){const[d,T]=a.useState(!1),[S,I]=a.useState(""),[O,D]=a.useState(""),[w,M]=a.useState(!1),[N,$]=a.useState(!1),[v,y]=a.useState(""),[P,C]=a.useState(""),[h,m]=a.useState(""),[o,k]=a.useState(!1),[X,U]=a.useState(!1),[Z,V]=a.useState(!1),[K,L]=a.useState(!1),[B,Y]=a.useState(!1),R=me(),{data:n}=W({queryKey:["tiers-list",l],queryFn:async()=>{const i=await E(`${_()}/membership/tiers`,l);if(!i.ok)throw new Error("Failed to fetch tiers");return(await i.json()).tiers||[]},enabled:!!l&&!!s}),{data:A,isLoading:te}=W({queryKey:["tier-history",l,s?.id],queryFn:async()=>{const i=await E(`${_()}/membership/tiers/history/${s?.id}`,l);if(!i.ok)throw new Error("Failed to fetch history");return i.json()},enabled:!!l&&!!s&&w}),ee=z({mutationFn:async()=>{const i=await E(`${_()}/membership/tiers/assign`,l,{method:"POST",body:JSON.stringify({member_id:s?.id,tier_id:S?parseInt(S):null,reason:O||"Staff assigned"})});if(!i.ok){const q=await i.json();throw new Error(q.error||"Failed to change tier")}return i.json()},onSuccess:()=>{if(R.invalidateQueries({queryKey:["members"]}),R.invalidateQueries({queryKey:["tier-history",l,s?.id]}),s){const i=n?.find(q=>String(q.id)===S);g({...s,tier:i?{id:i.id,name:i.name,color:""}:{id:0,name:"None",color:""}})}T(!1),I(""),D("")}}),{data:ne,isLoading:G}=W({queryKey:["credit-history",l,s?.id],queryFn:async()=>{const i=await E(`${_()}/bonuses?member_id=${s?.id}&per_page=10`,l);if(!i.ok)throw new Error("Failed to fetch credit history");return i.json()},enabled:!!l&&!!s&&B}),b=z({mutationFn:async()=>{const i=await E(`${_()}/membership/store-credit/add`,l,{method:"POST",body:JSON.stringify({member_id:s?.id,amount:parseFloat(v),description:P||"Manual credit adjustment",expiration_days:h?parseInt(h):null})});if(!i.ok){const q=await i.json();throw new Error(q.error||"Failed to issue credit")}return i.json()},onSuccess:()=>{R.invalidateQueries({queryKey:["members"]}),R.invalidateQueries({queryKey:["credit-history",l,s?.id]})}}),ie=a.useCallback((i=!1)=>{$(!1),y(""),C(""),m(""),b.reset(),i&&c()},[b,c]),le=z({mutationFn:async()=>{const i=await E(`${_()}/members/${s?.id}`,l,{method:"PUT",body:JSON.stringify({status:"cancelled"})});if(!i.ok){const q=await i.json();throw new Error(q.error||"Failed to cancel membership")}return i.json()},onSuccess:()=>{R.invalidateQueries({queryKey:["members"]}),k(!1),c()}}),ce=z({mutationFn:async()=>{const i=await E(`${_()}/members/${s?.id}`,l,{method:"DELETE"});if(!i.ok){const q=await i.json();throw new Error(q.error||"Failed to delete member")}return i.json()},onSuccess:()=>{R.invalidateQueries({queryKey:["members"]}),U(!1),c()}}),de=z({mutationFn:async()=>{const i=await E(`${_()}/members/${s?.id}/suspend`,l,{method:"POST"});if(!i.ok){const q=await i.json();throw new Error(q.error||"Failed to suspend membership")}return i.json()},onSuccess:()=>{R.invalidateQueries({queryKey:["members"]}),V(!1),c()}}),ue=z({mutationFn:async()=>{const i=await E(`${_()}/members/${s?.id}/reactivate`,l,{method:"POST"});if(!i.ok){const q=await i.json();throw new Error(q.error||"Failed to reactivate membership")}return i.json()},onSuccess:()=>{R.invalidateQueries({queryKey:["members"]}),L(!1),c()}});if(!s)return null;const Se=[{label:"No Tier",value:""},...n?.filter(i=>i&&i.name).map(i=>({label:i.name||"",value:String(i.id)}))||[]];return e.jsxs(e.Fragment,{children:[e.jsxs(p,{open:s!==null,onClose:c,title:`${s.first_name} ${s.last_name}`,primaryAction:{content:"Issue Credit",onAction:()=>$(!0),disabled:!s.shopify_customer_id},secondaryActions:[{content:"Change Tier",onAction:()=>T(!0)},...s.status==="active"?[{content:"Suspend",onAction:()=>V(!0)}]:[],...s.status==="suspended"||s.status==="cancelled"?[{content:"Reactivate",onAction:()=>L(!0)}]:[],{content:"Cancel Membership",onAction:()=>k(!0),destructive:!0,disabled:s.status==="cancelled"},{content:"Delete Member",onAction:()=>U(!0),destructive:!0}],children:[e.jsx(p.Section,{children:e.jsxs(r,{gap:"400",children:[!s.shopify_customer_id&&e.jsx(j,{tone:"critical",children:e.jsxs("p",{children:[e.jsx("strong",{children:"Not linked to Shopify:"})," This member is not linked to a Shopify customer account. Store credit cannot be issued until the member is linked. Delete this member and re-add them by searching for an existing Shopify customer."]})}),e.jsxs(f,{gap:"400",children:[e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Email"}),e.jsx(t,{as:"span",children:s.email})]}),e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Tier"}),e.jsx(H,{tone:"info",children:String(s.tier?.name||"None")})]})]}),e.jsxs(f,{gap:"400",children:[e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Total Trade-Ins"}),e.jsx(t,{as:"span",children:s.trade_in_count})]}),e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Trade-In Value"}),e.jsx(t,{as:"span",children:u(s.total_trade_in_value)})]}),e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Credits Issued"}),e.jsx(t,{as:"span",children:u(s.total_credits_issued)})]})]}),e.jsxs(f,{gap:"400",children:[e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Member Since"}),e.jsx(t,{as:"span",children:x(s.created_at)})]}),e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:"Last Activity"}),e.jsx(t,{as:"span",children:x(s.last_trade_in_at)})]})]})]})}),e.jsx(p.Section,{children:e.jsxs(r,{gap:"300",children:[e.jsxs(f,{align:"space-between",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:"Tier History"}),e.jsxs(J,{variant:"plain",onClick:()=>M(!w),children:[w?"Hide":"Show"," History"]})]}),w&&(te?e.jsx(f,{align:"center",children:e.jsx(re,{size:"small"})}):A?.history&&A.history.length>0?e.jsx(r,{gap:"200",children:A.history.slice(0,5).filter(i=>i&&i.id!=null).map(i=>e.jsx(F,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:e.jsxs(f,{align:"space-between",children:[e.jsxs(r,{gap:"050",children:[e.jsxs(t,{as:"span",variant:"bodySm",children:[String(i.previous_tier||"None")," → ",String(i.new_tier||"None")]}),e.jsxs(t,{as:"span",variant:"bodySm",tone:"subdued",children:[String(i.change_type||"change")," • ",String(i.source_type||"system")]})]}),e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:i.created_at?x(i.created_at):"-"})]})},i.id))}):e.jsx(t,{as:"p",tone:"subdued",children:"No tier changes recorded"}))]})}),e.jsx(p.Section,{children:e.jsxs(r,{gap:"300",children:[e.jsxs(f,{align:"space-between",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:"Credit History"}),e.jsxs(J,{variant:"plain",onClick:()=>Y(!B),children:[B?"Hide":"Show"," History"]})]}),B&&(G?e.jsx(f,{align:"center",children:e.jsx(re,{size:"small"})}):ne?.bonuses&&ne.bonuses.length>0?e.jsx(r,{gap:"200",children:ne.bonuses.filter(i=>i&&i.id!=null).map(i=>e.jsx(F,{padding:"200",background:"bg-surface-secondary",borderRadius:"100",children:e.jsxs(f,{align:"space-between",children:[e.jsxs(r,{gap:"050",children:[e.jsxs(f,{gap:"200",children:[e.jsxs(t,{as:"span",variant:"bodySm",fontWeight:"semibold",children:[i.amount>0?"+":"",u(i.amount)]}),i.synced_to_shopify&&e.jsx(H,{tone:"success",size:"small",children:"Synced"})]}),e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:String(i.description||i.event_type||"credit")})]}),e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:x(i.created_at)})]})},i.id))}):e.jsx(t,{as:"p",tone:"subdued",children:"No credit transactions recorded"}))]})})]}),e.jsx(p,{open:d,onClose:()=>T(!1),title:"Change Member Tier",primaryAction:{content:"Save",onAction:()=>ee.mutate(),loading:ee.isPending},secondaryActions:[{content:"Cancel",onAction:()=>T(!1)}],children:e.jsxs(p.Section,{children:[ee.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:ee.error?.message||"Failed to change tier"})})}),e.jsxs(oe,{children:[e.jsx(he,{label:"New Tier",options:Se,value:S,onChange:I}),e.jsx(Q,{label:"Reason (optional)",value:O,onChange:D,placeholder:"e.g., VIP upgrade, loyalty reward",autoComplete:"off"})]})]})}),e.jsx(p,{open:N,onClose:()=>ie(!1),title:"Issue Store Credit",primaryAction:b.isSuccess?{content:"Done",onAction:()=>ie(!0)}:{content:"Issue Credit",onAction:()=>b.mutate(),loading:b.isPending,disabled:!v||parseFloat(v)<=0},secondaryActions:b.isSuccess?[]:[{content:"Cancel",onAction:()=>ie(!1)}],children:e.jsxs(p.Section,{children:[b.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:b.error?.message||"Failed to issue credit"})})}),b.isSuccess?e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",variant:"headingMd",children:"Credit Issued Successfully!"}),e.jsxs(t,{as:"p",children:[u(parseFloat(v))," has been added to ",s.first_name,"'s Shopify store credit balance."]})]})}):e.jsxs(oe,{children:[e.jsx(Q,{label:"Credit Amount",type:"number",value:v,onChange:y,prefix:"$",min:.01,step:.01,autoComplete:"off",helpText:"Amount to add to member's store credit balance"}),e.jsx(Q,{label:"Description (optional)",value:P,onChange:C,placeholder:"e.g., Loyalty bonus, Price adjustment",autoComplete:"off",helpText:"Reason for the credit (visible in history)"}),e.jsx(he,{label:"Credit Expiration",options:$e,value:h,onChange:m,helpText:"When this credit should expire"})]})]})}),e.jsx(p,{open:o,onClose:()=>k(!1),title:"Cancel Membership",primaryAction:{content:"Cancel Membership",onAction:()=>le.mutate(),loading:le.isPending,destructive:!0},secondaryActions:[{content:"Keep Active",onAction:()=>k(!1)}],children:e.jsxs(p.Section,{children:[le.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:le.error?.message||"Failed to cancel membership"})})}),e.jsx(j,{tone:"warning",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",fontWeight:"semibold",children:"Are you sure you want to cancel this membership?"}),e.jsxs(t,{as:"p",children:[s.first_name," ",s.last_name," will no longer receive member benefits. Their existing store credit will remain available."]})]})})]})}),e.jsx(p,{open:X,onClose:()=>U(!1),title:"Delete Member",primaryAction:{content:"Delete Permanently",onAction:()=>ce.mutate(),loading:ce.isPending,destructive:!0},secondaryActions:[{content:"Cancel",onAction:()=>U(!1)}],children:e.jsxs(p.Section,{children:[ce.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:ce.error?.message||"Failed to delete member"})})}),e.jsx(j,{tone:"critical",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",fontWeight:"semibold",children:"Are you sure you want to permanently delete this member?"}),e.jsxs(t,{as:"p",children:["This will remove ",s.first_name," ",s.last_name," (",s.email,") from TradeUp and delete all their credit history. This action cannot be undone."]}),e.jsx(t,{as:"p",children:"Note: This does NOT delete the customer from Shopify - only from TradeUp."})]})})]})}),e.jsx(p,{open:Z,onClose:()=>V(!1),title:"Suspend Membership",primaryAction:{content:"Suspend Membership",onAction:()=>de.mutate(),loading:de.isPending},secondaryActions:[{content:"Cancel",onAction:()=>V(!1)}],children:e.jsxs(p.Section,{children:[de.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:de.error?.message||"Failed to suspend membership"})})}),e.jsx(j,{tone:"warning",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",fontWeight:"semibold",children:"Suspend this membership?"}),e.jsxs(t,{as:"p",children:[s.first_name," ",s.last_name,"'s membership will be temporarily suspended. They will not receive member benefits, but their data and store credit will be preserved. You can reactivate their membership at any time."]})]})})]})}),e.jsx(p,{open:K,onClose:()=>L(!1),title:"Reactivate Membership",primaryAction:{content:"Reactivate Membership",onAction:()=>ue.mutate(),loading:ue.isPending},secondaryActions:[{content:"Cancel",onAction:()=>L(!1)}],children:e.jsxs(p.Section,{children:[ue.isError&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",children:e.jsx("p",{children:ue.error?.message||"Failed to reactivate membership"})})}),e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",fontWeight:"semibold",children:"Reactivate this membership?"}),e.jsxs(t,{as:"p",children:[s.first_name," ",s.last_name,"'s membership will be reactivated. They will immediately regain access to all member benefits and their existing store credit."]})]})})]})})]})}function Le({open:s,onClose:l,shop:c,tiers:g}){const[u,x]=a.useState([]),[d,T]=a.useState(""),[S,I]=a.useState(""),[O,D]=a.useState(!1),[w,M]=a.useState(null),{data:N}=W({queryKey:["email-templates",c],queryFn:async()=>{const o=await E(`${_()}/members/email/templates`,c);if(!o.ok)throw new Error("Failed to fetch templates");return o.json()},enabled:!!c&&s}),$=z({mutationFn:async()=>{const o=await E(`${_()}/members/email/preview`,c,{method:"POST",body:JSON.stringify({tier_names:u})});if(!o.ok)throw new Error("Failed to preview");return o.json()}}),v=z({mutationFn:async()=>{const o=await E(`${_()}/members/email/send`,c,{method:"POST",body:JSON.stringify({tier_names:u,subject:d,message:S})});if(!o.ok){const k=await o.json();throw new Error(k.error||"Failed to send emails")}return o.json()},onSuccess:o=>{D(!0),M({sent:o.sent,failed:o.failed})}}),y=a.useCallback(o=>{x(o),o.length>0&&$.mutate()},[]),P=a.useCallback(o=>{T(o.subject),I(o.message)},[]),C=a.useCallback(()=>{x([]),T(""),I(""),D(!1),M(null),l()},[l]),h=u.length>0&&d.trim()&&S.trim(),m=$.data?.total_recipients||0;return e.jsx(p,{open:s,onClose:C,title:"Email Members by Tier",primaryAction:O?{content:"Done",onAction:C}:{content:`Send to ${m} ${m===1?"Member":"Members"}`,onAction:()=>v.mutate(),disabled:!h||m===0,loading:v.isPending},secondaryActions:O?[]:[{content:"Cancel",onAction:C}],size:"large",children:O?e.jsx(p.Section,{children:e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",variant:"headingMd",children:"Email Sent Successfully!"}),e.jsxs(t,{as:"p",children:["Sent ",w?.sent," emails",w?.failed?` (${w.failed} failed)`:"","."]})]})})}):e.jsxs(e.Fragment,{children:[e.jsx(p.Section,{children:e.jsxs(r,{gap:"400",children:[v.isError&&e.jsx(j,{tone:"critical",children:e.jsx("p",{children:v.error?.message||"Failed to send emails"})}),e.jsx(ge,{title:"Select Tiers to Email",choices:g?g.filter(o=>o&&o.active&&o.name).map(o=>({label:o.name||"",value:String(o.name||"").toUpperCase()})):[],selected:u,onChange:y,allowMultiple:!0}),$.data&&e.jsx(j,{children:e.jsxs(t,{as:"p",children:[e.jsx("strong",{children:m})," active members will receive this email:",Object.entries($.data.member_counts).map(([o,k])=>e.jsxs("span",{children:[" ",o,": ",k]},o))]})})]})}),e.jsx(p.Section,{children:e.jsxs(r,{gap:"400",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:"Quick Templates"}),e.jsx(f,{gap:"200",wrap:!0,children:N?.templates?.filter(o=>o&&o.id).map(o=>e.jsx(J,{size:"slim",onClick:()=>P(o),children:o.name||"Template"},o.id))})]})}),e.jsx(p.Section,{children:e.jsxs(oe,{children:[e.jsx(Q,{label:"Subject",value:d,onChange:T,autoComplete:"off",placeholder:"e.g., Exclusive Member Offer!",requiredIndicator:!0}),e.jsx(Q,{label:"Message",value:S,onChange:I,multiline:8,autoComplete:"off",placeholder:"Write your message here...",helpText:"Use {member_name}, {member_number}, and {tier_name} for personalization",requiredIndicator:!0})]})})]})})}function Re({open:s,onClose:l,shop:c}){const g=me(),[u,x]=a.useState(""),[d,T]=a.useState(null),[S,I]=a.useState(""),[O,D]=a.useState([]),[w,M]=a.useState(!1),[N,$]=a.useState(!1),v=fe(u,150),[y,P]=a.useState(!1),[C,h]=a.useState(""),[m,o]=a.useState(""),[k,X]=a.useState(""),[U,Z]=a.useState(""),{data:V}=W({queryKey:["tiers-list",c],queryFn:async()=>{const n=await E(`${_()}/membership/tiers`,c);if(!n.ok)throw new Error("Failed to fetch tiers");return(await n.json()).tiers||[]},enabled:!!c&&s});a.useEffect(()=>{(async()=>{if(!v||v.length<2){D([]);return}M(!0);try{const A=await E(`${_()}/members/search-shopify?q=${encodeURIComponent(v)}`,c);if(A.ok){const te=await A.json();D(te.customers||[])}}catch(A){console.error("Search failed:",A)}finally{M(!1)}})()},[v,c]);const K=z({mutationFn:async()=>{if(!d)throw new Error("No customer selected");const n=await E(`${_()}/members/enroll`,c,{method:"POST",body:JSON.stringify({shopify_customer_id:d.id,tier_id:S?parseInt(S):null})});if(!n.ok){const A=await n.json();throw new Error(A.error||"Failed to enroll member")}return n.json()},onSuccess:()=>{$(!0),g.invalidateQueries({queryKey:["members"]})}}),L=z({mutationFn:async()=>{if(!C)throw new Error("Email is required");const n=await E(`${_()}/members/create-and-enroll`,c,{method:"POST",body:JSON.stringify({email:C,first_name:m||void 0,last_name:k||void 0,phone:U||void 0,tier_id:S?parseInt(S):null})});if(!n.ok){const A=await n.json();throw new Error(A.error||"Failed to create customer")}return n.json()},onSuccess:()=>{$(!0),g.invalidateQueries({queryKey:["members"]})}}),B=a.useCallback(()=>{x(""),T(null),I(""),D([]),$(!1),P(!1),h(""),o(""),X(""),Z(""),l()},[l]),Y=[{label:"No Tier (Start at base)",value:""},...V?.filter(n=>n&&n.name).map(n=>({label:n.name||"",value:String(n.id)}))||[]],R=C&&C.includes("@")&&C.includes(".");return e.jsx(p,{open:s,onClose:B,title:y?"Create New Customer":"Add Member",primaryAction:N?{content:"Done",onAction:B}:y?{content:"Create & Enroll",onAction:()=>L.mutate(),loading:L.isPending,disabled:!R}:d?{content:"Enroll Member",onAction:()=>K.mutate(),loading:K.isPending}:void 0,secondaryActions:N?[]:y?[{content:"Back to Search",onAction:()=>{P(!1),h(""),o(""),X(""),Z("")}}]:d?[{content:"Back",onAction:()=>T(null)}]:[{content:"Cancel",onAction:B}],children:N?e.jsx(p.Section,{children:e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",variant:"headingMd",children:"Member Enrolled!"}),e.jsxs(t,{as:"p",children:[y?`${m||""} ${k||""} (${C})`.trim():d?.name||`${d?.firstName||""} ${d?.lastName||""}`.trim()," has been enrolled in your loyalty program."]})]})})}):y?e.jsx(p.Section,{children:e.jsxs(r,{gap:"400",children:[L.isError&&e.jsx(j,{tone:"critical",children:e.jsx("p",{children:L.error?.message||"Failed to create customer"})}),e.jsx(j,{tone:"info",children:e.jsx(t,{as:"p",children:"This will create a new customer in Shopify and automatically enroll them as a member."})}),e.jsxs(oe,{children:[e.jsx(Q,{label:"Email",type:"email",value:C,onChange:h,autoComplete:"email",placeholder:"customer@example.com",requiredIndicator:!0,error:C&&!R?"Please enter a valid email":void 0}),e.jsxs(oe.Group,{children:[e.jsx(Q,{label:"First Name",value:m,onChange:o,autoComplete:"given-name",placeholder:"John"}),e.jsx(Q,{label:"Last Name",value:k,onChange:X,autoComplete:"family-name",placeholder:"Doe"})]}),e.jsx(Q,{label:"Phone (optional)",type:"tel",value:U,onChange:Z,autoComplete:"tel",placeholder:"+1 555-123-4567"}),e.jsx(he,{label:"Starting Tier",options:Y,value:S,onChange:I,helpText:"Select an initial tier or leave at base level"})]})]})}):d?e.jsx(p.Section,{children:e.jsxs(r,{gap:"400",children:[K.isError&&e.jsx(j,{tone:"critical",children:e.jsx("p",{children:K.error?.message||"Failed to enroll member"})}),e.jsx(se,{background:"bg-surface-secondary",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:d.name||`${d.firstName||""} ${d.lastName||""}`.trim()||"Unknown"}),e.jsx(t,{as:"p",tone:"subdued",children:d.email}),e.jsxs(f,{gap:"400",wrap:!0,children:[e.jsxs(t,{as:"span",variant:"bodySm",children:[d.numberOfOrders||d.ordersCount||0," orders"]}),e.jsxs(t,{as:"span",variant:"bodySm",children:["$",Number(d.amountSpent||d.totalSpent||0).toFixed(2)," spent"]}),(d.storeCredit??0)>0&&e.jsx(H,{tone:"info",size:"small",children:`$${Number(d.storeCredit).toFixed(2)} store credit`})]})]})}),e.jsx(he,{label:"Starting Tier",options:Y,value:S,onChange:I,helpText:"Select an initial tier or leave at base level"})]})}):e.jsx(p.Section,{children:e.jsxs(r,{gap:"400",children:[e.jsx(Q,{label:"Search Shopify Customers",value:u,onChange:x,placeholder:"Type to search by name, email, or phone...",autoComplete:"off",autoFocus:!0,clearButton:!0,onClearButtonClick:()=>x(""),prefix:e.jsx(Ee,{source:Fe}),suffix:w?e.jsx(re,{size:"small"}):null,helpText:u.length>0&&u.length<2?"Type at least 2 characters":void 0}),O.length>0?e.jsxs(r,{gap:"200",children:[e.jsxs(t,{as:"h3",variant:"headingSm",children:["Search Results (",O.length,")"]}),O.map(n=>e.jsx("div",{onClick:()=>!n.is_member&&T(n),role:"button",tabIndex:0,onKeyDown:A=>A.key==="Enter"&&!n.is_member&&T(n),style:{cursor:n.is_member?"not-allowed":"pointer",opacity:n.is_member?.6:1},children:e.jsx(F,{padding:"300",background:"bg-surface-secondary",borderRadius:"200",children:e.jsxs(f,{align:"space-between",blockAlign:"center",children:[e.jsxs(r,{gap:"100",children:[e.jsxs(f,{gap:"200",blockAlign:"center",children:[e.jsx(t,{as:"span",fontWeight:"semibold",children:n.name||`${n.firstName||""} ${n.lastName||""}`.trim()||"Unknown"}),n.is_member&&e.jsx(H,{tone:"success",size:"small",children:`Member ${n.member_number||""}`})]}),e.jsx(t,{as:"span",variant:"bodySm",tone:"subdued",children:n.email})]}),e.jsxs(r,{gap:"050",inlineAlign:"end",children:[e.jsxs(f,{gap:"200",children:[e.jsxs(t,{as:"span",variant:"bodySm",children:[n.numberOfOrders||n.ordersCount||0," orders"]}),e.jsxs(t,{as:"span",variant:"bodySm",tone:"subdued",children:["$",Number(n.amountSpent||n.totalSpent||0).toFixed(2)," spent"]})]}),(n.storeCredit??0)>0&&e.jsx(H,{tone:"info",size:"small",children:`$${Number(n.storeCredit).toFixed(2)} credit`})]})]})})},n.id)),e.jsx(ye,{}),e.jsx(J,{variant:"plain",onClick:()=>P(!0),children:"Or create a new customer"})]}):v.length>=2&&!w?e.jsxs(r,{gap:"300",children:[e.jsx(j,{tone:"info",children:e.jsxs(t,{as:"p",children:['No customers found matching "',v,'"']})}),e.jsx(J,{variant:"primary",onClick:()=>{P(!0),u.includes("@")&&h(u)},fullWidth:!0,children:"Create New Customer"})]}):e.jsxs(r,{gap:"300",children:[e.jsx(t,{as:"p",tone:"subdued",alignment:"center",children:w?e.jsxs(f,{gap:"200",align:"center",children:[e.jsx(re,{size:"small"}),e.jsx("span",{children:"Searching..."})]}):"Start typing to search for Shopify customers, or create a new customer."}),e.jsx(J,{variant:"plain",onClick:()=>P(!0),children:"Create new customer instead"})]})]})})})}function Be({open:s,onClose:l,shop:c}){const g=me(),[u,x]=a.useState(null),[d,T]=a.useState(null),[S,I]=a.useState(!1),[O,D]=a.useState(!1),[w,M]=a.useState(""),[N,$]=a.useState(null),v=a.useCallback((h,m)=>{m.length>0&&(x(m[0]),T(null),M(""),$(null))},[]),y=a.useCallback(async()=>{if(!(!u||!c)){D(!0),M("");try{const h=new FormData;h.append("file",u);const m=await fetch(`${_()}/members/import/preview`,{method:"POST",headers:{"X-Shop-Domain":c},body:h});if(!m.ok){const k=await m.json();throw new Error(k.error||"Failed to preview CSV")}const o=await m.json();T(o)}catch(h){M(h instanceof Error?h.message:"Failed to preview CSV")}finally{D(!1)}}},[u,c]),P=a.useCallback(async()=>{if(!(!u||!c)){I(!0),M("");try{const h=new FormData;h.append("file",u),h.append("skip_duplicates","true");const m=await fetch(`${_()}/members/import/import`,{method:"POST",headers:{"X-Shop-Domain":c},body:h});if(!m.ok){const k=await m.json();throw new Error(k.error||"Failed to import members")}const o=await m.json();$({imported:o.imported,skipped:o.skipped}),g.invalidateQueries({queryKey:["members"]})}catch(h){M(h instanceof Error?h.message:"Failed to import members")}finally{I(!1)}}},[u,c,g]),C=a.useCallback(()=>{x(null),T(null),M(""),$(null),l()},[l]);return e.jsx(p,{open:s,onClose:C,title:"Import Members from CSV",primaryAction:N?{content:"Done",onAction:C}:d?{content:`Import ${d.valid_count} Members`,onAction:P,loading:S,disabled:d.valid_count===0}:u?{content:"Preview Import",onAction:y,loading:O}:void 0,secondaryActions:N?[]:d?[{content:"Back",onAction:()=>{T(null),x(null)}}]:[{content:"Cancel",onAction:C}],size:"large",children:N?e.jsx(p.Section,{children:e.jsx(j,{tone:"success",children:e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"p",variant:"headingMd",children:"Import Complete!"}),e.jsxs(t,{as:"p",children:["Successfully imported ",N.imported," members",N.skipped>0&&` (${N.skipped} duplicates skipped)`,"."]})]})})}):d?e.jsx(e.Fragment,{children:e.jsxs(p.Section,{children:[w&&e.jsx(F,{paddingBlockEnd:"400",children:e.jsx(j,{tone:"critical",onDismiss:()=>M(""),children:e.jsx("p",{children:w})})}),e.jsxs(r,{gap:"400",children:[e.jsxs(f,{gap:"400",children:[e.jsx(se,{children:e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"headingLg",tone:"success",children:d.valid_count}),e.jsx(t,{as:"span",variant:"bodySm",children:"Ready to import"})]})}),e.jsx(se,{children:e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"headingLg",tone:"critical",children:d.invalid_count}),e.jsx(t,{as:"span",variant:"bodySm",children:"Invalid rows"})]})}),e.jsx(se,{children:e.jsxs(r,{gap:"100",children:[e.jsx(t,{as:"span",variant:"headingLg",tone:"caution",children:d.duplicate_count}),e.jsx(t,{as:"span",variant:"bodySm",children:"Duplicates (skipped)"})]})})]}),d.valid_rows.length>0&&e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:"Preview (first 10 rows)"}),e.jsx(be,{columnContentTypes:["numeric","text","text","text","text"],headings:["Row","Email","First Name","Last Name","Tier"],rows:d.valid_rows.map(h=>[h.row,h.email,h.first_name,h.last_name,h.tier_name||"-"])})]}),d.invalid_rows.length>0&&e.jsxs(r,{gap:"200",children:[e.jsx(t,{as:"h3",variant:"headingSm",tone:"critical",children:"Invalid Rows"}),d.invalid_rows.map(h=>e.jsx(F,{padding:"200",background:"bg-surface-critical",borderRadius:"100",children:e.jsxs(f,{align:"space-between",children:[e.jsxs(t,{as:"span",variant:"bodySm",children:["Row ",h.row,": ",h.email||"(no email)"]}),e.jsx(t,{as:"span",variant:"bodySm",tone:"critical",children:h.errors.join(", ")})]})},h.row))]})]})]})}):e.jsx(p.Section,{children:e.jsxs(r,{gap:"400",children:[w&&e.jsx(j,{tone:"critical",onDismiss:()=>M(""),children:e.jsx("p",{children:w})}),e.jsx(je,{accept:".csv",type:"file",onDrop:v,variableHeight:!0,children:u?e.jsx(F,{padding:"400",children:e.jsxs(f,{gap:"300",blockAlign:"center",children:[e.jsx(Me,{source:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",alt:"CSV file",size:"small"}),e.jsxs(r,{gap:"050",children:[e.jsx(t,{as:"span",variant:"bodyMd",fontWeight:"semibold",children:u.name}),e.jsxs(t,{as:"span",variant:"bodySm",tone:"subdued",children:[(u.size/1024).toFixed(1)," KB"]})]})]})}):e.jsx(je.FileUpload,{actionHint:"or drop a CSV file to upload"})}),e.jsx(se,{background:"bg-surface-secondary",children:e.jsxs(r,{gap:"300",children:[e.jsx(t,{as:"h3",variant:"headingSm",children:"CSV Format Requirements"}),e.jsxs(ae,{type:"bullet",children:[e.jsx(ae.Item,{children:"First row must be column headers"}),e.jsx(ae.Item,{children:"Required columns: email, first_name"}),e.jsx(ae.Item,{children:"Optional: last_name, phone, tier_name"}),e.jsx(ae.Item,{children:"Tier names must match existing tiers exactly"})]}),e.jsx(t,{as:"p",variant:"bodySm",tone:"subdued",children:"Example: email,first_name,last_name,tier_name"})]})})]})})})}export{Je as EmbeddedMembers};
