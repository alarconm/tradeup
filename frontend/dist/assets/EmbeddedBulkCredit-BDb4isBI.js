import{b as Z,u as D,c as I,j as e}from"./vendor-query-Bq4hz6H9.js";import{r as a}from"./vendor-router-CdtyvhQv.js";import{a as g,g as x}from"./index-CG0F7Qqq.js";import{P as q,B as k,v as $,L as h,C as b,a as c,h as d,t as R,T as r,u as ee,Y as U,z as ne,c as W,X as te,b as v,l as re,R as ie,w as se,E as ae,M as L,g as C,f as oe}from"./vendor-polaris-1WqYVNpP.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";import"./vendor-appbridge-DL6abzKC.js";async function ce(t){const s=await g(`${x()}/members/tiers`,t);if(!s.ok)throw new Error("Failed to fetch tiers");return s.json()}async function le(t){const s=await g(`${x()}/promotions/credit/bulk`,t);if(!s.ok)throw new Error("Failed to fetch operations");return s.json()}async function de(t,s){const o=await g(`${x()}/promotions/credit/bulk`,t,{method:"POST",body:JSON.stringify(s)});if(!o.ok)throw new Error("Failed to create operation");return o.json()}async function ue(t,s){const o=await g(`${x()}/promotions/credit/bulk/${s}/preview`,t);if(!o.ok)throw new Error("Failed to preview operation");return o.json()}async function me(t,s){if(!(await g(`${x()}/promotions/credit/bulk/${s}/execute`,t,{method:"POST"})).ok)throw new Error("Failed to execute operation")}function ye({shop:t}){const s=Z(),[o,j]=a.useState(!1),[i,y]=a.useState(null),[F,l]=a.useState(""),[u,A]=a.useState(""),[E,_]=a.useState(""),[m,M]=a.useState("5.00"),[B,O]=a.useState(""),{data:X,isLoading:K,error:Q}=D({queryKey:["bulk-credit",t],queryFn:()=>le(t),enabled:!!t}),{data:T}=D({queryKey:["tiers",t],queryFn:()=>ce(t),enabled:!!t,staleTime:6e4}),z=[{label:"All Active Members",value:""},...T?.tiers?T.tiers.filter(n=>n&&n.active&&n.name).map(n=>({label:`${n.name||""} Only`,value:String(n.name||"").toUpperCase()})):[]],S=I({mutationFn:async()=>{const n=await de(t,{name:u,description:E||void 0,amount_per_member:parseFloat(m),tier_filter:B||void 0}),f=await ue(t,n.id);return{operation:n,...f}},onSuccess:n=>{y(n),j(!1)},onError:n=>l(n.message)}),w=I({mutationFn:n=>me(t,n),onSuccess:()=>{s.invalidateQueries({queryKey:["bulk-credit"]}),y(null)},onError:n=>l(n.message)}),N=a.useCallback(()=>{A(""),_(""),M("5.00"),O(""),l(""),j(!0)},[]),H=a.useCallback(()=>{if(!u.trim()){l("Operation name is required");return}if(parseFloat(m)<=0){l("Amount must be greater than 0");return}S.mutate()},[u,m,S]),Y=a.useCallback(()=>{i&&w.mutate(i.operation.id)},[i,w]),p=n=>new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(n),G=n=>new Date(n).toLocaleDateString(),J=n=>{const f=n||"unknown",V={pending:"warning",processing:"info",completed:"success",failed:"critical",unknown:void 0};return e.jsx(R,{tone:V[f],children:String(f)})};if(!t)return e.jsx(q,{title:"Bulk Credit",children:e.jsx(k,{tone:"warning",children:e.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})});const P=X?.operations||[];return e.jsxs(q,{title:"Bulk Credit Operations",subtitle:"Issue store credit to multiple members at once",primaryAction:{content:"New Bulk Credit",icon:$,onAction:N},children:[e.jsxs(h,{children:[Q&&e.jsx(h.Section,{children:e.jsx(k,{tone:"critical",children:e.jsx("p",{children:"Failed to load operations. Please try refreshing the page."})})}),F&&e.jsx(h.Section,{children:e.jsx(k,{tone:"critical",onDismiss:()=>l(""),children:e.jsx("p",{children:F})})}),i&&e.jsx(h.Section,{children:e.jsx(b,{children:e.jsxs(c,{gap:"400",children:[e.jsxs(d,{gap:"200",blockAlign:"center",children:[e.jsx(R,{tone:"success",children:"Ready to Execute"}),e.jsx(r,{as:"h2",variant:"headingMd",children:i.operation.name})]}),i.operation.description&&e.jsx(r,{as:"p",tone:"subdued",children:i.operation.description}),e.jsxs(ee,{columns:3,gap:"400",children:[e.jsx(b,{background:"bg-surface-secondary",children:e.jsxs(c,{gap:"100",inlineAlign:"center",children:[e.jsx(r,{as:"p",variant:"headingXl",fontWeight:"bold",children:i.member_count}),e.jsx(r,{as:"p",variant:"bodySm",tone:"subdued",children:"Members"})]})}),e.jsx(b,{background:"bg-surface-secondary",children:e.jsxs(c,{gap:"100",inlineAlign:"center",children:[e.jsx(r,{as:"p",variant:"headingXl",fontWeight:"bold",tone:"success",children:p(i.operation.amount_per_member)}),e.jsx(r,{as:"p",variant:"bodySm",tone:"subdued",children:"Per Member"})]})}),e.jsx(b,{background:"bg-surface-secondary",children:e.jsxs(c,{gap:"100",inlineAlign:"center",children:[e.jsx(r,{as:"p",variant:"headingXl",fontWeight:"bold",tone:"caution",children:p(i.total_amount)}),e.jsx(r,{as:"p",variant:"bodySm",tone:"subdued",children:"Total Credit"})]})})]}),i.members.length>0&&e.jsxs(c,{gap:"200",children:[e.jsxs(r,{as:"h3",variant:"headingSm",children:["Sample Recipients (",i.members.length," of ",i.member_count,")"]}),e.jsx(d,{gap:"200",wrap:!0,children:i.members.filter(n=>n&&n.id!=null).map(n=>e.jsxs(U,{children:[n.email||"Unknown"," (",n.tier||"No tier",")"]},n.id))})]}),e.jsx(ne,{}),e.jsxs(d,{gap:"300",align:"end",children:[e.jsx(W,{onClick:()=>y(null),children:"Cancel"}),e.jsx(W,{variant:"primary",tone:"success",icon:te,onClick:Y,loading:w.isPending,children:"Execute Now"})]})]})})}),e.jsx(h.Section,{children:e.jsxs(b,{padding:"0",children:[e.jsx(v,{padding:"400",borderBlockEndWidth:"025",borderColor:"border",children:e.jsx(r,{as:"h2",variant:"headingMd",children:"Operation History"})}),K?e.jsx(v,{padding:"1600",children:e.jsx(d,{align:"center",children:e.jsx(re,{size:"large"})})}):P.length>0?e.jsx(ie,{resourceName:{singular:"operation",plural:"operations"},items:P.filter(n=>n&&n.id!=null),renderItem:n=>e.jsx(se,{id:String(n.id),onClick:()=>{},children:e.jsxs(d,{align:"space-between",blockAlign:"center",children:[e.jsxs(c,{gap:"100",children:[e.jsxs(d,{gap:"200",blockAlign:"center",children:[e.jsx(r,{as:"h3",variant:"bodyMd",fontWeight:"semibold",children:n.name||"Untitled"}),J(n.status),n.tier_filter&&e.jsx(U,{children:n.tier_filter.split(",").join(", ")})]}),n.description&&e.jsx(r,{as:"p",variant:"bodySm",tone:"subdued",children:n.description}),e.jsxs(r,{as:"p",variant:"bodySm",tone:"subdued",children:[G(n.created_at)," by ",n.created_by]})]}),e.jsx(c,{gap:"100",inlineAlign:"end",children:n.status==="completed"?e.jsxs(e.Fragment,{children:[e.jsx(r,{as:"span",variant:"bodyMd",fontWeight:"semibold",tone:"success",children:p(n.total_amount)}),e.jsxs(r,{as:"span",variant:"bodySm",tone:"subdued",children:[n.member_count," members @ ",p(n.amount_per_member),"/ea"]})]}):e.jsxs(r,{as:"span",variant:"bodySm",tone:"subdued",children:[p(n.amount_per_member),"/member"]})})]})})}):e.jsx(v,{padding:"1600",children:e.jsx(ae,{heading:"No bulk credit operations yet",image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",action:{content:"Create Operation",icon:$,onAction:N},children:e.jsx("p",{children:"Issue store credit to multiple members at once for promotions, thank you bonuses, or loyalty rewards."})})})]})})]}),e.jsx(L,{open:o,onClose:()=>j(!1),title:"New Bulk Credit",primaryAction:{content:"Preview",onAction:H,loading:S.isPending,disabled:!u.trim()||parseFloat(m)<=0},secondaryActions:[{content:"Cancel",onAction:()=>j(!1)}],children:e.jsx(L.Section,{children:e.jsxs(c,{gap:"400",children:[e.jsx(C,{label:"Operation Name",value:u,onChange:A,placeholder:"Holiday Thank You Bonus",autoComplete:"off",requiredIndicator:!0,autoFocus:!0}),e.jsx(C,{label:"Description",value:E,onChange:_,placeholder:"Thank you for being a loyal member!",autoComplete:"off",multiline:2}),e.jsx(C,{label:"Amount Per Member",type:"number",value:m,onChange:M,prefix:"$",autoComplete:"off",requiredIndicator:!0}),e.jsx(oe,{label:"Filter by Tier",options:z,value:B,onChange:O})]})})})]})}export{ye as EmbeddedBulkCredit};
