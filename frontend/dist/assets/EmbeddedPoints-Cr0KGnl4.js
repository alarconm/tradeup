import{b as ve,u as Q,c as F,j as t}from"./vendor-query-Bq4hz6H9.js";import{r as o}from"./vendor-router-CdtyvhQv.js";import{a as h,g}from"./index-CIr4Wx79.js";import{X as ee,x as E,P as W,B as z,b as k,h as f,l as Se,v as we,L as A,C as K,ab as Ce,R as te,w as ne,a as S,T as u,t as m,E as ae,a9 as Re,z as se,M as q,e as re,g as p,f as H,c as $e,ac as Pe,a1 as ie,I as Fe,V as Ae}from"./vendor-polaris-vFYxDTRx.js";import{T as Te}from"./vendor-appbridge-DL6abzKC.js";import"./vendor-react-N--QU9DW.js";import"./vendor-sentry-UzNpYtBG.js";async function Ee(a){const s=await h(`${g()}/points/rules`,a);if(!s.ok){const l=await s.json().catch(()=>({}));throw new Error(l.error||`Failed to fetch earning rules (${s.status})`)}return(await s.json()).rules||[]}async function ke(a){const s=await h(`${g()}/rewards`,a);if(!s.ok){const l=await s.json().catch(()=>({}));throw new Error(l.error||`Failed to fetch rewards (${s.status})`)}return(await s.json()).rewards||[]}async function qe(a){const s=await h(`${g()}/members/tiers`,a);return s.ok?(await s.json()).tiers||[]:[]}async function Le(a,s){const r=await h(`${g()}/points/rules`,a,{method:"POST",body:JSON.stringify(s)});if(!r.ok){const l=await r.json().catch(()=>({}));throw new Error(l.error||`Failed to create rule (${r.status})`)}return r.json()}async function Ie(a,s){const r=await h(`${g()}/rewards`,a,{method:"POST",body:JSON.stringify(s)});if(!r.ok){const l=await r.json().catch(()=>({}));throw new Error(l.error||`Failed to create reward (${r.status})`)}return r.json()}async function Me(a,s){const r=await h(`${g()}/points/rules/${s}/toggle`,a,{method:"POST"});if(!r.ok)throw new Error("Failed to toggle rule");return r.json()}async function De(a,s){const r=await h(`${g()}/rewards/${s}/toggle`,a,{method:"POST"});if(!r.ok)throw new Error("Failed to toggle reward");return r.json()}async function Oe(a,s,r){const l=await h(`${g()}/rewards/${s}`,a,{method:"PUT",body:JSON.stringify(r)});if(!l.ok){const w=await l.json().catch(()=>({}));throw new Error(w.error||`Failed to update reward (${l.status})`)}return l.json()}async function Be(a,s){if(!s.trim())return[];const r=await h(`${g()}/shopify-data/products/search?q=${encodeURIComponent(s)}`,a);if(!r.ok){const w=await r.json().catch(()=>({}));throw new Error(w.error||`Failed to search products (${r.status})`)}return(await r.json()).products||[]}async function Ue(a,s){const r=await h(`${g()}/shopify-data/products/${encodeURIComponent(s)}`,a);return r.ok&&(await r.json()).product||null}function Xe({shop:a}){const s=ve(),[r,l]=o.useState(0),[w,C]=o.useState(!1),[oe,b]=o.useState(!1),[R,y]=o.useState(null),[J,x]=o.useState(null),[i,j]=o.useState({name:"",description:"",rule_type:"base_rate",points_per_dollar:"1",trigger_source:"purchase",min_order_value:"",max_points_per_order:""}),[n,c]=o.useState({name:"",description:"",reward_type:"store_credit",points_cost:"100",credit_value:"1",discount_percent:"",discount_amount:"",product_id:"",tier_restriction:[],available_quantity:"",max_redemptions_per_member:"",starts_at:"",ends_at:""}),[L,T]=o.useState(""),[I,v]=o.useState([]),[d,$]=o.useState(null),[V,X]=o.useState(!1),{data:M,isLoading:le,error:ce}=Q({queryKey:["earning-rules",a],queryFn:()=>Ee(a),enabled:!!a}),{data:D,isLoading:de,error:ue}=Q({queryKey:["rewards",a],queryFn:()=>ke(a),enabled:!!a}),{data:O}=Q({queryKey:["tiers",a],queryFn:()=>qe(a),enabled:!!a}),B=F({mutationFn:e=>Le(a,e),onSuccess:()=>{x(null),s.invalidateQueries({queryKey:["earning-rules"]}),C(!1),j({name:"",description:"",rule_type:"base_rate",points_per_dollar:"1",trigger_source:"purchase",min_order_value:"",max_points_per_order:""})},onError:e=>{x(e.message)}}),U=F({mutationFn:e=>Ie(a,e),onSuccess:()=>{x(null),s.invalidateQueries({queryKey:["rewards"]}),b(!1),y(null)},onError:e=>{x(e.message)}}),pe=F({mutationFn:e=>Me(a,e),onSuccess:()=>{s.invalidateQueries({queryKey:["earning-rules"]})}}),me=F({mutationFn:e=>De(a,e),onSuccess:()=>{s.invalidateQueries({queryKey:["rewards"]})}}),N=F({mutationFn:({rewardId:e,reward:_})=>Oe(a,e,_),onSuccess:()=>{x(null),s.invalidateQueries({queryKey:["rewards"]}),b(!1),y(null),P()},onError:e=>{x(e.message)}}),_e=o.useCallback(()=>{const e={name:i.name,description:i.description||void 0,rule_type:i.rule_type,points_per_dollar:parseInt(i.points_per_dollar)||1,trigger_source:i.trigger_source,min_order_value:i.min_order_value?parseFloat(i.min_order_value):void 0,max_points_per_order:i.max_points_per_order?parseInt(i.max_points_per_order):void 0};B.mutate(e)},[i,B]),P=o.useCallback(()=>{c({name:"",description:"",reward_type:"store_credit",points_cost:"100",credit_value:"1",discount_percent:"",discount_amount:"",product_id:"",tier_restriction:[],available_quantity:"",max_redemptions_per_member:"",starts_at:"",ends_at:""}),T(""),v([]),$(null)},[]),G=o.useCallback(async e=>{if(y(e),c({name:e.name,description:e.description||"",reward_type:e.reward_type,points_cost:String(e.points_cost),credit_value:e.credit_value?String(e.credit_value):"1",discount_percent:e.discount_percent?String(e.discount_percent):"",discount_amount:e.discount_amount?String(e.discount_amount):"",product_id:e.product_id||"",tier_restriction:e.tier_restriction||[],available_quantity:e.available_quantity?String(e.available_quantity):"",max_redemptions_per_member:e.max_redemptions_per_member?String(e.max_redemptions_per_member):"",starts_at:e.starts_at?e.starts_at.split("T")[0]:"",ends_at:e.ends_at?e.ends_at.split("T")[0]:""}),e.reward_type==="free_product"&&e.product_id){const _=await Ue(a,e.product_id);$(_)}else $(null);T(""),v([]),b(!0)},[a]),he=o.useCallback(()=>{const e={name:n.name,description:n.description||void 0,reward_type:n.reward_type,points_cost:parseInt(n.points_cost)||100};n.reward_type==="store_credit"?e.credit_value=parseFloat(n.credit_value)||1:n.reward_type==="discount_code"?(n.discount_percent&&(e.discount_percent=parseFloat(n.discount_percent)),n.discount_amount&&(e.discount_amount=parseFloat(n.discount_amount))):n.reward_type==="free_product"&&d&&(e.product_id=d.id),n.tier_restriction&&n.tier_restriction.length>0&&(e.tier_restriction=n.tier_restriction),n.available_quantity&&(e.available_quantity=parseInt(n.available_quantity)),n.max_redemptions_per_member&&(e.max_redemptions_per_member=parseInt(n.max_redemptions_per_member)),n.starts_at&&(e.starts_at=n.starts_at),n.ends_at&&(e.ends_at=n.ends_at),R?N.mutate({rewardId:R.id,reward:e}):U.mutate(e)},[n,R,d,U,N]),Y=o.useCallback(()=>{b(!1),y(null),P()},[P]),ge=o.useCallback(async e=>{if(T(e),!e.trim()){v([]);return}X(!0);try{const _=await Be(a,e);v(_)}catch(_){console.error("Product search failed:",_),v([])}finally{X(!1)}},[a]),fe=o.useCallback(e=>{$(e),c(_=>({..._,product_id:e.id})),T(""),v([])},[]),xe=o.useCallback(()=>{$(null),c(e=>({...e,product_id:""}))},[]),be=o.useMemo(()=>I.map(e=>({value:e.id,label:e.title,media:e.imageUrl?t.jsx(ee,{source:e.imageUrl,alt:e.title,size:"small"}):t.jsx(E,{customer:!1,size:"sm",name:e.title})})),[I]),ye=[{id:"earning-rules",content:"Earning Rules",accessibilityLabel:"Earning rules",panelID:"earning-rules-panel"},{id:"rewards",content:"Rewards Catalog",accessibilityLabel:"Rewards catalog",panelID:"rewards-panel"}];return a?le||de?t.jsx(W,{title:"Points & Rewards",children:t.jsx(k,{padding:"1600",children:t.jsx(f,{align:"center",children:t.jsx(Se,{size:"large"})})})}):t.jsxs(t.Fragment,{children:[t.jsx(Te,{title:"Points & Rewards"}),t.jsxs(W,{title:"Points & Rewards",subtitle:"Configure how customers earn and redeem loyalty points",primaryAction:{content:r===0?"Add Earning Rule":"Add Reward",icon:we,onAction:()=>{r===0?C(!0):(y(null),P(),b(!0))}},children:[t.jsxs(A,{children:[(ce||ue)&&t.jsx(A.Section,{children:t.jsx(z,{tone:"critical",children:t.jsx("p",{children:"Failed to load data. Please try refreshing the page."})})}),J&&t.jsx(A.Section,{children:t.jsx(z,{tone:"critical",onDismiss:()=>x(null),children:t.jsx("p",{children:J})})}),t.jsx(A.Section,{children:t.jsx(K,{padding:"0",children:t.jsx(Ce,{tabs:ye,selected:r,onSelect:l,children:r===0?M&&M.length>0?t.jsx(te,{resourceName:{singular:"rule",plural:"rules"},items:M,renderItem:e=>t.jsx(ne,{id:String(e.id),accessibilityLabel:e.name,onClick:()=>{},media:t.jsx(E,{customer:!1,size:"md",name:e.name,initials:e.name.charAt(0)}),shortcutActions:[{content:e.is_active?"Disable":"Enable",onAction:()=>pe.mutate(e.id)}],children:t.jsxs(S,{gap:"200",children:[t.jsxs(f,{gap:"200",blockAlign:"center",wrap:!0,children:[t.jsx(u,{as:"h3",variant:"bodyMd",fontWeight:"bold",children:e.name}),e.is_base_rule&&t.jsx(m,{tone:"info",children:"Base Rule"}),!e.is_active&&t.jsx(m,{tone:"warning",children:"Inactive"}),t.jsx(m,{tone:"success",children:e.rule_type==="base_rate"?`${e.points_per_dollar} pts/$1`:e.rule_type==="multiplier"?`${e.multiplier}x multiplier`:`${e.bonus_points} bonus pts`})]}),t.jsx(u,{as:"span",variant:"bodySm",tone:"subdued",children:e.description||`${e.points_per_dollar||0} points per $1 spent`})]})})}):t.jsx(ae,{heading:"Set up your earning rules",action:{content:"Add Earning Rule",onAction:()=>C(!0)},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:t.jsx("p",{children:"Earning rules define how customers earn points on purchases, trade-ins, referrals, and more."})}):D&&D.length>0?t.jsx(te,{resourceName:{singular:"reward",plural:"rewards"},items:D,renderItem:e=>t.jsx(ne,{id:String(e.id),accessibilityLabel:e.name,onClick:()=>G(e),media:t.jsx(E,{customer:!1,size:"md",name:e.name,initials:e.name.charAt(0)}),shortcutActions:[{content:"Edit",onAction:()=>G(e)},{content:e.is_active?"Disable":"Enable",onAction:()=>me.mutate(e.id)}],children:t.jsxs(S,{gap:"200",children:[t.jsxs(f,{gap:"200",blockAlign:"center",wrap:!0,children:[t.jsx(u,{as:"h3",variant:"bodyMd",fontWeight:"bold",children:e.name}),e.is_featured&&t.jsx(m,{tone:"success",children:"Featured"}),!e.is_active&&t.jsx(m,{tone:"warning",children:"Inactive"}),t.jsx(m,{children:`${e.points_cost.toLocaleString()} points`}),e.credit_value&&t.jsx(m,{tone:"info",children:`$${e.credit_value} value`}),e.discount_percent&&t.jsx(m,{tone:"info",children:`${e.discount_percent}% off`}),e.discount_amount&&!e.discount_percent&&t.jsx(m,{tone:"info",children:`$${e.discount_amount} off`})]}),t.jsx(u,{as:"span",variant:"bodySm",tone:"subdued",children:e.description||`${e.reward_type} reward`}),(e.tier_restriction?.length||e.available_quantity||e.max_redemptions_per_member||e.starts_at||e.ends_at)&&t.jsxs(f,{gap:"200",wrap:!0,children:[e.tier_restriction&&e.tier_restriction.length>0&&t.jsxs(m,{children:[e.tier_restriction.join(", ")," only"]}),e.available_quantity&&t.jsx(m,{tone:"attention",children:e.remaining_quantity!==null?`${e.remaining_quantity}/${e.available_quantity} left`:`Limit: ${e.available_quantity}`}),e.max_redemptions_per_member&&t.jsxs(m,{children:["Max ",e.max_redemptions_per_member,"/member"]}),(e.starts_at||e.ends_at)&&t.jsx(m,{tone:"attention",children:e.starts_at&&e.ends_at?`${new Date(e.starts_at).toLocaleDateString()} - ${new Date(e.ends_at).toLocaleDateString()}`:e.starts_at?`From ${new Date(e.starts_at).toLocaleDateString()}`:`Until ${new Date(e.ends_at).toLocaleDateString()}`})]})]})})}):t.jsx(ae,{heading:"Create your rewards catalog",action:{content:"Add Reward",onAction:()=>{y(null),P(),b(!0)}},image:"https://cdn.shopify.com/s/files/1/0262/4071/2726/files/emptystate-files.png",children:t.jsx("p",{children:"Rewards are what customers can redeem their points for - store credit, discounts, free products, and more."})})})})}),t.jsx(A.Section,{variant:"oneThird",children:t.jsx(K,{children:t.jsxs(S,{gap:"400",children:[t.jsxs(f,{gap:"200",blockAlign:"center",children:[t.jsx(Re,{}),t.jsx(u,{as:"h3",variant:"headingMd",children:"How Points Work"})]}),t.jsx(se,{}),t.jsxs(S,{gap:"200",children:[t.jsxs(u,{as:"p",variant:"bodySm",children:[t.jsx("strong",{children:"Earning:"})," Customers earn points based on your earning rules - per dollar spent, on trade-ins, referrals, and more."]}),t.jsxs(u,{as:"p",variant:"bodySm",children:[t.jsx("strong",{children:"Redeeming:"})," Points are redeemed for rewards in your catalog - typically store credit that syncs to Shopify."]}),t.jsxs(u,{as:"p",variant:"bodySm",children:[t.jsx("strong",{children:"Default:"})," 1 point per $1 spent, 100 points = $1 store credit."]})]})]})})})]}),t.jsx(q,{open:w,onClose:()=>C(!1),title:"Create Earning Rule",primaryAction:{content:"Create",onAction:_e,loading:B.isPending,disabled:!i.name.trim()},secondaryActions:[{content:"Cancel",onAction:()=>C(!1)}],children:t.jsx(q.Section,{children:t.jsxs(re,{children:[t.jsx(p,{label:"Rule Name",value:i.name,onChange:e=>j({...i,name:e}),placeholder:"e.g., Base Purchase Rate, Double Points Day",autoComplete:"off"}),t.jsx(p,{label:"Description",value:i.description,onChange:e=>j({...i,description:e}),placeholder:"Brief description of this rule",autoComplete:"off"}),t.jsx(H,{label:"Trigger",options:[{label:"Purchase",value:"purchase"},{label:"Trade-in",value:"trade_in"},{label:"Referral",value:"referral"},{label:"Signup",value:"signup"},{label:"Anniversary",value:"anniversary"}],value:i.trigger_source,onChange:e=>j({...i,trigger_source:e})}),t.jsx(p,{label:"Points per Dollar",type:"number",value:i.points_per_dollar,onChange:e=>j({...i,points_per_dollar:e}),autoComplete:"off",helpText:"How many points to award per $1 spent"}),t.jsx(p,{label:"Minimum Order Value (optional)",type:"number",value:i.min_order_value,onChange:e=>j({...i,min_order_value:e}),prefix:"$",autoComplete:"off",helpText:"Order must be at least this amount to qualify"})]})})}),t.jsx(q,{open:oe,onClose:Y,title:R?"Edit Reward":"Create Reward",primaryAction:{content:R?"Save":"Create",onAction:he,loading:U.isPending||N.isPending,disabled:!n.name.trim()},secondaryActions:[{content:"Cancel",onAction:Y}],children:t.jsx(q.Section,{children:t.jsxs(re,{children:[t.jsx(p,{label:"Reward Name",value:n.name,onChange:e=>c({...n,name:e}),placeholder:"e.g., $5 Store Credit, Free Shipping",autoComplete:"off"}),t.jsx(p,{label:"Description",value:n.description,onChange:e=>c({...n,description:e}),placeholder:"Brief description of this reward",autoComplete:"off"}),t.jsx(H,{label:"Reward Type",options:[{label:"Store Credit",value:"store_credit"},{label:"Discount Code",value:"discount_code"},{label:"Free Product",value:"free_product"},{label:"Free Shipping",value:"free_shipping"}],value:n.reward_type,onChange:e=>c({...n,reward_type:e})}),t.jsx(p,{label:"Points Cost",type:"number",value:n.points_cost,onChange:e=>c({...n,points_cost:e}),autoComplete:"off",helpText:"Points required to redeem this reward"}),n.reward_type==="store_credit"&&t.jsx(p,{label:"Credit Value",type:"number",value:n.credit_value,onChange:e=>c({...n,credit_value:e}),prefix:"$",autoComplete:"off",helpText:"Store credit amount to issue"}),n.reward_type==="discount_code"&&t.jsxs(t.Fragment,{children:[t.jsx(p,{label:"Discount Percentage",type:"number",value:n.discount_percent,onChange:e=>c({...n,discount_percent:e}),suffix:"%",autoComplete:"off",helpText:"Percentage off (e.g., 10 for 10% off). Leave empty if using fixed amount."}),t.jsx(p,{label:"Discount Amount",type:"number",value:n.discount_amount,onChange:e=>c({...n,discount_amount:e}),prefix:"$",autoComplete:"off",helpText:"Fixed dollar amount off. Leave empty if using percentage."})]}),n.reward_type==="free_product"&&t.jsxs(S,{gap:"300",children:[t.jsx(u,{as:"span",variant:"bodyMd",fontWeight:"semibold",children:"Select Product"}),d?t.jsx(K,{padding:"400",children:t.jsxs(f,{gap:"400",align:"space-between",blockAlign:"center",children:[t.jsxs(f,{gap:"300",blockAlign:"center",children:[d.imageUrl?t.jsx(ee,{source:d.imageUrl,alt:d.title,size:"small"}):t.jsx(E,{customer:!1,size:"md",name:d.title}),t.jsxs(S,{gap:"100",children:[t.jsx(u,{as:"span",variant:"bodyMd",fontWeight:"semibold",children:d.title}),d.variants.length>0&&t.jsx(u,{as:"span",variant:"bodySm",tone:"subdued",children:d.variants.length===1?`$${d.variants[0].price}`:`${d.variants.length} variants - from $${d.variants[0].price}`})]})]}),t.jsx($e,{variant:"plain",icon:Pe,onClick:xe,accessibilityLabel:"Remove selected product"})]})}):t.jsx(ie,{options:be,selected:[],onSelect:e=>{const _=e[0],Z=I.find(je=>je.id===_);Z&&fe(Z)},textField:t.jsx(ie.TextField,{onChange:ge,label:"Search products",labelHidden:!0,value:L,prefix:t.jsx(Fe,{source:Ae}),placeholder:"Search for a product by name...",autoComplete:"off",loading:V}),listTitle:"Products",emptyState:L.trim()&&!V?t.jsx(k,{padding:"200",children:t.jsxs(u,{as:"span",tone:"subdued",children:['No products found for "',L,'"']})}):null}),t.jsx(u,{as:"span",variant:"bodySm",tone:"subdued",children:"The selected product will be given to customers when they redeem this reward."})]}),t.jsx(se,{}),t.jsx(u,{as:"h3",variant:"headingSm",children:"Restrictions (Optional)"}),O&&O.length>0&&t.jsx(H,{label:"Tier Restriction",options:[{label:"All tiers can redeem",value:""},...O.filter(e=>e.is_active).map(e=>({label:`${e.name} only`,value:e.name}))],value:n.tier_restriction.length>0?n.tier_restriction[0]:"",onChange:e=>c({...n,tier_restriction:e?[e]:[]}),helpText:"Limit this reward to a specific tier"}),t.jsx(p,{label:"Total Redemption Limit",type:"number",value:n.available_quantity,onChange:e=>c({...n,available_quantity:e}),autoComplete:"off",helpText:"Maximum total redemptions allowed (leave empty for unlimited)",placeholder:"Unlimited"}),t.jsx(p,{label:"Per-Member Limit",type:"number",value:n.max_redemptions_per_member,onChange:e=>c({...n,max_redemptions_per_member:e}),autoComplete:"off",helpText:"Maximum redemptions per member (leave empty for unlimited)",placeholder:"Unlimited"}),t.jsxs(f,{gap:"400",children:[t.jsx(k,{minWidth:"200px",children:t.jsx(p,{label:"Available From",type:"date",value:n.starts_at,onChange:e=>c({...n,starts_at:e}),autoComplete:"off",helpText:"When reward becomes available"})}),t.jsx(k,{minWidth:"200px",children:t.jsx(p,{label:"Available Until",type:"date",value:n.ends_at,onChange:e=>c({...n,ends_at:e}),autoComplete:"off",helpText:"When reward expires"})})]})]})})})]})]}):t.jsx(W,{title:"Points & Rewards",children:t.jsx(z,{tone:"warning",children:t.jsx("p",{children:"No shop connected. Please install the app from the Shopify App Store."})})})}export{Xe as EmbeddedPoints};
