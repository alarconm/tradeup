# TradeUp Tier Discount Function - Input Query
#
# This query fetches all data needed to calculate tier-based discounts.
# Shopify Functions have strict memory/time limits, so we only request
# exactly what we need.
#
# Customer metafields (namespace: "tradeup"):
#   - tier: The tier name (e.g., "GOLD", "PLATINUM")
#   - tier_discount_pct: Percentage discount for this tier (e.g., "10")
#   - free_shipping_threshold: Order amount for free shipping (e.g., "50.00", "0" for always free)
#
# Learn more: https://shopify.dev/docs/api/functions/reference/order-discounts

query Input {
  # The discount node contains configuration set by the merchant
  discountNode {
    metafield(namespace: "tradeup-tier-discount", key: "config") {
      value
    }
  }

  # Cart data for applying discounts
  cart {
    # Customer identity and tier metafields
    buyerIdentity {
      customer {
        id
        # Tier name (BRONZE, SILVER, GOLD, PLATINUM, etc.)
        tierMetafield: metafield(namespace: "tradeup", key: "tier") {
          value
        }
        # Discount percentage for this tier
        discountMetafield: metafield(namespace: "tradeup", key: "tier_discount_pct") {
          value
        }
        # Free shipping threshold (0 = always free)
        shippingThresholdMetafield: metafield(namespace: "tradeup", key: "free_shipping_threshold") {
          value
        }
      }
    }

    # Cart lines for applying line-item discounts
    lines {
      id
      quantity
      merchandise {
        ... on ProductVariant {
          id
          product {
            id
            # Check if product has a "no_tier_discount" tag
            hasAnyTag(tags: ["no-tier-discount", "sale", "clearance"])
          }
        }
      }
      cost {
        # Amount per unit before discounts
        amountPerQuantity {
          amount
          currencyCode
        }
        # Total line cost
        totalAmount {
          amount
          currencyCode
        }
      }
    }

    # Total cart cost for threshold calculations
    cost {
      totalAmount {
        amount
        currencyCode
      }
      subtotalAmount {
        amount
        currencyCode
      }
    }

    # Delivery groups for free shipping logic
    deliveryGroups {
      id
      deliveryOptions {
        handle
        title
        cost {
          amount
          currencyCode
        }
      }
      selectedDeliveryOption {
        handle
        title
        cost {
          amount
          currencyCode
        }
      }
    }
  }
}
